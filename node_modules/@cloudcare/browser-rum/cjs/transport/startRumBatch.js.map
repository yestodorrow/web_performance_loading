{"version":3,"file":"startRumBatch.js","names":["_browserCore","require","startRumBatch","configuration","lifeCycle","telemetryEventObservable","reportError","pageExitObservable","sessionExpireObservable","batch","makeRumBatch","subscribe","LifeCycleEventType","RUM_EVENT_COLLECTED","serverRumEvent","type","RumEventType","VIEW","upsert","view","id","add","event","rumBatch","createRumBatch","rumEndpoint","primaryBatch","primaryFlushController","flushController","endpointUrl","createFlushController","messagesLimit","batchMessagesLimit","bytesLimit","batchBytesLimit","durationLimit","flushTimeout","Batch","createHttpRequest","sendContentTypeByJson","messageBytesLimit","flushObservable","message","key"],"sources":["../../src/transport/startRumBatch.js"],"sourcesContent":["import {\n  Batch,\n  createHttpRequest,\n  LifeCycleEventType,\n  RumEventType,\n  createFlushController\n} from '@cloudcare/browser-core'\n\nexport function startRumBatch(\n  configuration,\n  lifeCycle,\n  telemetryEventObservable,\n  reportError,\n  pageExitObservable,\n  sessionExpireObservable\n) {\n  var batch = makeRumBatch(\n    configuration,\n    reportError,\n    pageExitObservable,\n    sessionExpireObservable\n  )\n\n  lifeCycle.subscribe(\n    LifeCycleEventType.RUM_EVENT_COLLECTED,\n    function (serverRumEvent) {\n      if (serverRumEvent.type === RumEventType.VIEW) {\n        batch.upsert(serverRumEvent, serverRumEvent.view.id)\n      } else {\n        batch.add(serverRumEvent)\n      }\n    }\n  )\n  telemetryEventObservable.subscribe(function (event) {\n    batch.add(event)\n  })\n}\n\nfunction makeRumBatch(\n  configuration,\n  reportError,\n  pageExitObservable,\n  sessionExpireObservable\n) {\n  var rumBatch = createRumBatch(configuration.rumEndpoint)\n  var primaryBatch = rumBatch.batch\n  var primaryFlushController = rumBatch.flushController\n  function createRumBatch(endpointUrl) {\n    var flushController = createFlushController({\n      messagesLimit: configuration.batchMessagesLimit,\n      bytesLimit: configuration.batchBytesLimit,\n      durationLimit: configuration.flushTimeout,\n      pageExitObservable: pageExitObservable,\n      sessionExpireObservable: sessionExpireObservable\n    })\n    var batch = new Batch(\n      createHttpRequest(\n        endpointUrl,\n        configuration.batchBytesLimit,\n        configuration.sendContentTypeByJson,\n        reportError\n      ),\n      flushController,\n      configuration.messageBytesLimit,\n      configuration.sendContentTypeByJson\n    )\n    return {\n      batch: batch,\n      flushController: flushController\n    }\n  }\n\n  return {\n    flushObservable: primaryFlushController.flushObservable,\n    add: function (message) {\n      primaryBatch.add(message)\n    },\n    upsert: function (message, key) {\n      primaryBatch.upsert(message, key)\n    }\n  }\n}\n"],"mappings":";;;;;;AAAA,IAAAA,YAAA,GAAAC,OAAA;AAQO,SAASC,aAAaA,CAC3BC,aAAa,EACbC,SAAS,EACTC,wBAAwB,EACxBC,WAAW,EACXC,kBAAkB,EAClBC,uBAAuB,EACvB;EACA,IAAIC,KAAK,GAAGC,YAAY,CACtBP,aAAa,EACbG,WAAW,EACXC,kBAAkB,EAClBC,uBACF,CAAC;EAEDJ,SAAS,CAACO,SAAS,CACjBC,+BAAkB,CAACC,mBAAmB,EACtC,UAAUC,cAAc,EAAE;IACxB,IAAIA,cAAc,CAACC,IAAI,KAAKC,yBAAY,CAACC,IAAI,EAAE;MAC7CR,KAAK,CAACS,MAAM,CAACJ,cAAc,EAAEA,cAAc,CAACK,IAAI,CAACC,EAAE,CAAC;IACtD,CAAC,MAAM;MACLX,KAAK,CAACY,GAAG,CAACP,cAAc,CAAC;IAC3B;EACF,CACF,CAAC;EACDT,wBAAwB,CAACM,SAAS,CAAC,UAAUW,KAAK,EAAE;IAClDb,KAAK,CAACY,GAAG,CAACC,KAAK,CAAC;EAClB,CAAC,CAAC;AACJ;AAEA,SAASZ,YAAYA,CACnBP,aAAa,EACbG,WAAW,EACXC,kBAAkB,EAClBC,uBAAuB,EACvB;EACA,IAAIe,QAAQ,GAAGC,cAAc,CAACrB,aAAa,CAACsB,WAAW,CAAC;EACxD,IAAIC,YAAY,GAAGH,QAAQ,CAACd,KAAK;EACjC,IAAIkB,sBAAsB,GAAGJ,QAAQ,CAACK,eAAe;EACrD,SAASJ,cAAcA,CAACK,WAAW,EAAE;IACnC,IAAID,eAAe,GAAG,IAAAE,kCAAqB,EAAC;MAC1CC,aAAa,EAAE5B,aAAa,CAAC6B,kBAAkB;MAC/CC,UAAU,EAAE9B,aAAa,CAAC+B,eAAe;MACzCC,aAAa,EAAEhC,aAAa,CAACiC,YAAY;MACzC7B,kBAAkB,EAAEA,kBAAkB;MACtCC,uBAAuB,EAAEA;IAC3B,CAAC,CAAC;IACF,IAAIC,KAAK,GAAG,IAAI4B,kBAAK,CACnB,IAAAC,8BAAiB,EACfT,WAAW,EACX1B,aAAa,CAAC+B,eAAe,EAC7B/B,aAAa,CAACoC,qBAAqB,EACnCjC,WACF,CAAC,EACDsB,eAAe,EACfzB,aAAa,CAACqC,iBAAiB,EAC/BrC,aAAa,CAACoC,qBAChB,CAAC;IACD,OAAO;MACL9B,KAAK,EAAEA,KAAK;MACZmB,eAAe,EAAEA;IACnB,CAAC;EACH;EAEA,OAAO;IACLa,eAAe,EAAEd,sBAAsB,CAACc,eAAe;IACvDpB,GAAG,EAAE,SAAAA,IAAUqB,OAAO,EAAE;MACtBhB,YAAY,CAACL,GAAG,CAACqB,OAAO,CAAC;IAC3B,CAAC;IACDxB,MAAM,EAAE,SAAAA,OAAUwB,OAAO,EAAEC,GAAG,EAAE;MAC9BjB,YAAY,CAACR,MAAM,CAACwB,OAAO,EAAEC,GAAG,CAAC;IACnC;EACF,CAAC;AACH","ignoreList":[]}