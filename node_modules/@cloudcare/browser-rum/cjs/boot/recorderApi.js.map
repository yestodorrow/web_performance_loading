{"version":3,"file":"recorderApi.js","names":["_browserCore","require","_replayStats","_deflate","RecorderStatus","Stopped","IntentToStart","Starting","Started","makeRecorderApi","startRecordingImpl","createDeflateWorkerImpl","recorderStartObservable","Observable","canUseEventBridge","isBrowserSupported","start","noop","stop","getReplayStats","undefined","onRumStart","isRecording","state","status","startStrategy","stopStrategy","viewId","getDeflateWorkerStatus","DeflateWorkerStatus","Initialized","getReplayStatsImpl","lifeCycle","configuration","sessionManager","viewContexts","worker","subscribe","LifeCycleEventType","SESSION_EXPIRED","PAGE_EXITED","pageExitEvent","reason","PageExitReason","UNLOADING","PAGEHIDE","SESSION_RENEWED","cachedDeflateEncoder","getOrCreateDeflateEncoder","startDeflateWorker","createDeflateEncoder","DeflateEncoderStreamId","REPLAY","session","findTrackedSession","sessionReplayAllowed","runOnReadyState","deflateEncoder","recordingImpl","notify","relativeNow","stopRecording","Array","from","CSSSupportsRule","URL","createObjectURL","NodeList","prototype"],"sources":["../../src/boot/recorderApi.js"],"sourcesContent":["import {\n  noop,\n  runOnReadyState,\n  LifeCycleEventType,\n  canUseEventBridge,\n  Observable,\n  relativeNow,\n  PageExitReason\n} from '@cloudcare/browser-core'\n\nimport { getReplayStats as getReplayStatsImpl } from '../domain/replay/replayStats'\nimport {\n  DeflateEncoderStreamId,\n  createDeflateEncoder,\n  startDeflateWorker,\n  DeflateWorkerStatus,\n  getDeflateWorkerStatus\n} from '../domain/replay/deflate'\nvar RecorderStatus = {\n  // The recorder is stopped.\n  Stopped: 0,\n  // The user started the recording while it wasn't possible yet. The recorder should start as soon\n  // as possible.\n  IntentToStart: 1,\n  // The recorder is starting. It does not record anything yet.\n  Starting: 2,\n  // The recorder is started, it records the session.\n  Started: 3\n}\n\nexport function makeRecorderApi(startRecordingImpl, createDeflateWorkerImpl) {\n  var recorderStartObservable = new Observable()\n  if (canUseEventBridge() || !isBrowserSupported()) {\n    return {\n      start: noop,\n      stop: noop,\n      getReplayStats: function () {\n        return undefined\n      },\n      onRumStart: noop,\n      isRecording: function () {\n        return false\n      },\n      recorderStartObservable: recorderStartObservable\n    }\n  }\n\n  var state = {\n    status: RecorderStatus.Stopped\n  }\n\n  var startStrategy = function () {\n    state = { status: RecorderStatus.IntentToStart }\n  }\n  var stopStrategy = function () {\n    state = { status: RecorderStatus.Stopped }\n  }\n  return {\n    start: function () {\n      startStrategy()\n    },\n    stop: function () {\n      stopStrategy()\n    },\n    recorderStartObservable: recorderStartObservable,\n    getReplayStats: function (viewId) {\n      return getDeflateWorkerStatus() === DeflateWorkerStatus.Initialized\n        ? getReplayStatsImpl(viewId)\n        : undefined\n    },\n\n    onRumStart: function (\n      lifeCycle,\n      configuration,\n      sessionManager,\n      viewContexts,\n      worker\n    ) {\n      lifeCycle.subscribe(LifeCycleEventType.SESSION_EXPIRED, function () {\n        if (\n          state.status === RecorderStatus.Starting ||\n          state.status === RecorderStatus.Started\n        ) {\n          stopStrategy()\n          state = { status: RecorderStatus.IntentToStart }\n        }\n      })\n      lifeCycle.subscribe(\n        LifeCycleEventType.PAGE_EXITED,\n        function (pageExitEvent) {\n          if (\n            pageExitEvent.reason === PageExitReason.UNLOADING ||\n            pageExitEvent.reason === PageExitReason.PAGEHIDE\n          ) {\n            stopStrategy()\n          }\n        }\n      )\n      lifeCycle.subscribe(LifeCycleEventType.SESSION_RENEWED, function () {\n        if (state.status === RecorderStatus.IntentToStart) {\n          startStrategy()\n        }\n      })\n      var cachedDeflateEncoder\n      function getOrCreateDeflateEncoder() {\n        if (!cachedDeflateEncoder) {\n          if (!worker) {\n            worker = startDeflateWorker(function () {\n              stopStrategy()\n            }, createDeflateWorkerImpl)\n          }\n          if (worker) {\n            cachedDeflateEncoder = createDeflateEncoder(\n              worker,\n              DeflateEncoderStreamId.REPLAY\n            )\n          }\n        }\n        return cachedDeflateEncoder\n      }\n      startStrategy = function () {\n        var session = sessionManager.findTrackedSession()\n        if (!session || !session.sessionReplayAllowed) {\n          state = { status: RecorderStatus.IntentToStart }\n          return\n        }\n\n        if (\n          state.status === RecorderStatus.Starting ||\n          state.status === RecorderStatus.Started\n        ) {\n          return\n        }\n\n        state = { status: RecorderStatus.Starting }\n\n        runOnReadyState('interactive', function () {\n          if (state.status !== RecorderStatus.Starting) {\n            return\n          }\n          var deflateEncoder = getOrCreateDeflateEncoder()\n          //   var worker = startDeflateWorker(function () {\n          //     stopStrategy()\n          //   }, createDeflateWorkerImpl)\n          if (!deflateEncoder) {\n            state = {\n              status: RecorderStatus.Stopped\n            }\n            return\n          }\n          var recordingImpl = startRecordingImpl(\n            lifeCycle,\n            configuration,\n            sessionManager,\n            viewContexts,\n            deflateEncoder\n          )\n          recorderStartObservable.notify(relativeNow())\n          state = {\n            status: RecorderStatus.Started,\n            stopRecording: recordingImpl.stop\n          }\n        })\n      }\n\n      stopStrategy = function () {\n        if (state.status === RecorderStatus.Stopped) {\n          return\n        }\n\n        if (state.status === RecorderStatus.Started) {\n          state.stopRecording()\n        }\n\n        state = {\n          status: RecorderStatus.Stopped\n        }\n      }\n\n      if (state.status === RecorderStatus.IntentToStart) {\n        startStrategy()\n      }\n    },\n\n    isRecording: function () {\n      return state.status === RecorderStatus.Started\n    }\n  }\n}\n\n/**\n * Test for Browser features used while recording\n */\nfunction isBrowserSupported() {\n  return (\n    // Array.from is a bit less supported by browsers than CSSSupportsRule, but has higher chances\n    // to be polyfilled. Test for both to be more confident. We could add more things if we find out\n    // this test is not sufficient.\n    typeof Array.from === 'function' &&\n    typeof CSSSupportsRule === 'function' &&\n    typeof URL.createObjectURL === 'function' &&\n    'forEach' in NodeList.prototype\n  )\n}\n"],"mappings":"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","ignoreList":[]}