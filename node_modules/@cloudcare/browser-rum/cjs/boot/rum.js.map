{"version":3,"file":"rum.js","names":["_rumSessionManager","require","_usr","_browserCore","_performanceCollection","_domMutationObservable","_locationChangeObservable","_longTaskCollection","_actionCollection","_startRumBatch","_startRumEventBridge","_assembly","_displayContext","_internalContext","_urlContexts","_viewContexts","_commonContext","_pageStateHistory","_errorCollection","_viewCollection","_requestCollection","_resourceCollection","startRum","configuration","recorderApi","globalContextManager","userContextManager","initialViewOptions","cleanupTasks","lifeCycle","LifeCycle","telemetry","startRumTelemetry","setContextProvider","application","id","applicationId","session","findTrackedSession","view","viewContexts","findView","action","actionContexts","findActionId","ids","findAllActionId","reportError","error","notify","LifeCycleEventType","RAW_ERROR_COLLECTED","pageExitObservable","createPageExitObservable","subscribe","event","PAGE_EXITED","push","pageExitSubscription","unsubscribe","canUseEventBridge","startRumSessionManager","startRumSessionManagerStub","batch","startRumBatch","observable","expireObservable","stop","startRumEventBridge","userSession","startCacheUsrCache","domMutationObservable","createDOMMutationObservable","locationChangeObservable","createLocationChangeObservable","location","_startRumEventCollection","startRumEventCollection","buildCommonContext","urlContexts","pageStateHistory","stopRumEventCollection","addAction","startLongTaskCollection","startResourceCollection","_startViewCollection","startViewCollection","addTiming","startView","stopViewCollection","_startErrorCollection","startErrorCollection","addError","startRequestCollection","startPerformanceCollection","internalContext","startInternalContext","stopSession","expire","getInternalContext","get","forEach","task","startTelemetry","TelemetryService","RUM","sessionManager","userSessionManager","startViewContexts","startUrlContexts","startPageStateHistory","_startActionCollection","startActionCollection","displayContext","startDisplayContext","startRumAssembly"],"sources":["../../src/boot/rum.js"],"sourcesContent":["import {\n  startRumSessionManager,\n  startRumSessionManagerStub\n} from '../domain/rumSessionManager'\nimport { startCacheUsrCache } from '../domain/usr'\nimport {\n  LifeCycle,\n  LifeCycleEventType,\n  createPageExitObservable,\n  canUseEventBridge,\n  startTelemetry,\n  getEventBridge,\n  TelemetryService\n} from '@cloudcare/browser-core'\nimport { startPerformanceCollection } from '../domain/performanceCollection'\nimport { createDOMMutationObservable } from '../domain/domMutationObservable.js'\nimport { createLocationChangeObservable } from '../domain/locationChangeObservable'\nimport { startLongTaskCollection } from '../domain/rumEventsCollection/longTask/longTaskCollection'\nimport { startActionCollection } from '../domain/rumEventsCollection/actions/actionCollection'\nimport { startRumBatch } from '../transport/startRumBatch'\nimport { startRumEventBridge } from '../transport/startRumEventBridge'\nimport { startRumAssembly } from '../domain/assembly'\nimport { startDisplayContext } from '../domain/contexts/displayContext.js'\nimport { startInternalContext } from '../domain/contexts/internalContext'\n// import { startForegroundContexts } from '../domain/contexts/foregroundContexts'\nimport { startUrlContexts } from '../domain/contexts/urlContexts'\nimport { startViewContexts } from '../domain/contexts/viewContexts'\nimport { buildCommonContext } from '../domain/contexts/commonContext'\nimport { startPageStateHistory } from '../domain/contexts/pageStateHistory'\nimport { startErrorCollection } from '../domain/rumEventsCollection/error/errorCollection'\nimport { startViewCollection } from '../domain/rumEventsCollection/view/viewCollection'\nimport { startRequestCollection } from '../domain/requestCollection'\nimport { startResourceCollection } from '../domain/rumEventsCollection/resource/resourceCollection'\n\nexport function startRum(\n  configuration,\n  recorderApi,\n  globalContextManager,\n  userContextManager,\n  initialViewOptions\n) {\n  var cleanupTasks = []\n  var lifeCycle = new LifeCycle()\n  var telemetry = startRumTelemetry(configuration)\n  telemetry.setContextProvider(function () {\n    return {\n      application: {\n        id: configuration.applicationId\n      },\n      session: {\n        id: session.findTrackedSession() && session.findTrackedSession().id\n      },\n      view: {\n        id: viewContexts.findView() && viewContexts.findView().id\n      },\n      action: {\n        id: actionContexts.findActionId(),\n        ids: actionContexts.findAllActionId()\n      }\n    }\n  })\n  var reportError = function (error) {\n    lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, { error: error })\n  }\n  var pageExitObservable = createPageExitObservable()\n  pageExitObservable.subscribe(function (event) {\n    lifeCycle.notify(LifeCycleEventType.PAGE_EXITED, event)\n  })\n  cleanupTasks.push(function () {\n    pageExitSubscription.unsubscribe()\n  })\n  var session = !canUseEventBridge()\n    ? startRumSessionManager(configuration, lifeCycle)\n    : startRumSessionManagerStub()\n  if (!canUseEventBridge()) {\n    var batch = startRumBatch(\n      configuration,\n      lifeCycle,\n      telemetry.observable,\n      reportError,\n      pageExitObservable,\n      session.expireObservable\n    )\n    cleanupTasks.push(function () {\n      batch.stop()\n    })\n  } else {\n    startRumEventBridge(lifeCycle)\n  }\n\n  var userSession = startCacheUsrCache(configuration)\n  var domMutationObservable = createDOMMutationObservable()\n  var locationChangeObservable = createLocationChangeObservable(location)\n  var _startRumEventCollection = startRumEventCollection(\n    lifeCycle,\n    configuration,\n    location,\n    session,\n    userSession,\n    locationChangeObservable,\n    domMutationObservable,\n    function () {\n      return buildCommonContext(\n        globalContextManager,\n        userContextManager,\n        recorderApi\n      )\n    },\n    reportError\n  )\n  var viewContexts = _startRumEventCollection.viewContexts\n  var urlContexts = _startRumEventCollection.urlContexts\n  var actionContexts = _startRumEventCollection.actionContexts\n  var pageStateHistory = _startRumEventCollection.pageStateHistory\n  var stopRumEventCollection = _startRumEventCollection.stop\n  var addAction = _startRumEventCollection.addAction\n\n  cleanupTasks.push(stopRumEventCollection)\n\n  startLongTaskCollection(lifeCycle, session)\n  startResourceCollection(lifeCycle, configuration, session, pageStateHistory)\n\n  var _startViewCollection = startViewCollection(\n    lifeCycle,\n    configuration,\n    location,\n    domMutationObservable,\n    locationChangeObservable,\n    pageStateHistory,\n    recorderApi,\n    initialViewOptions\n  )\n  var addTiming = _startViewCollection.addTiming\n  var startView = _startViewCollection.startView\n  var stopViewCollection = _startViewCollection.stop\n  cleanupTasks.push(stopViewCollection)\n\n  var _startErrorCollection = startErrorCollection(\n    lifeCycle,\n    configuration,\n    pageStateHistory\n  )\n  var addError = _startErrorCollection.addError\n  startRequestCollection(lifeCycle, configuration, session)\n  startPerformanceCollection(lifeCycle, configuration)\n  var internalContext = startInternalContext(\n    configuration.applicationId,\n    session,\n    viewContexts,\n    actionContexts,\n    urlContexts\n  )\n  return {\n    addAction: addAction,\n    addError: addError,\n    addTiming: addTiming,\n    configuration: configuration,\n    lifeCycle: lifeCycle,\n    viewContexts: viewContexts,\n    session: session,\n    startView: startView,\n    stopSession: function () {\n      session.expire()\n    },\n    getInternalContext: internalContext.get,\n    stop: function () {\n      cleanupTasks.forEach(function (task) {\n        task()\n      })\n    }\n  }\n}\nfunction startRumTelemetry(configuration) {\n  const telemetry = startTelemetry(TelemetryService.RUM, configuration)\n  //   if (canUseEventBridge()) {\n  //     const bridge = getEventBridge()\n  //     telemetry.observable.subscribe((event) =>\n  //       bridge.send('internal_telemetry', event)\n  //     )\n  //   }\n  return telemetry\n}\n\nexport function startRumEventCollection(\n  lifeCycle,\n  configuration,\n  location,\n  sessionManager,\n  userSessionManager,\n  locationChangeObservable,\n  domMutationObservable,\n  buildCommonContext,\n  reportError\n) {\n  var viewContexts = startViewContexts(lifeCycle)\n  var urlContexts = startUrlContexts(\n    lifeCycle,\n    locationChangeObservable,\n    location\n  )\n\n  var pageStateHistory = startPageStateHistory()\n  var _startActionCollection = startActionCollection(\n    lifeCycle,\n    domMutationObservable,\n    configuration,\n    pageStateHistory\n  )\n  var actionContexts = _startActionCollection.actionContexts\n  var addAction = _startActionCollection.addAction\n\n  var displayContext = startDisplayContext()\n  startRumAssembly(\n    configuration,\n    lifeCycle,\n    sessionManager,\n    userSessionManager,\n    viewContexts,\n    urlContexts,\n    actionContexts,\n    displayContext,\n    buildCommonContext,\n    reportError\n  )\n  return {\n    viewContexts: viewContexts,\n    urlContexts: urlContexts,\n    pageStateHistory: pageStateHistory,\n    addAction: addAction,\n    actionContexts: actionContexts,\n    stop: function () {\n      viewContexts.stop()\n      urlContexts.stop()\n      pageStateHistory.stop()\n      displayContext.stop()\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}