{"version":3,"file":"startRecording.js","names":["_browserCore","require","_record2","_segmentCollection","_types","startRecording","lifeCycle","configuration","sessionManager","viewContexts","encoder","httpRequest","reportError","error","notify","LifeCycleEventType","RAW_ERROR_COLLECTED","addTelemetryDebug","message","replayRequest","createHttpRequest","sessionReplayEndPoint","SEGMENT_BYTES_LIMIT","segmentCollection","startSegmentCollection","addRecord","stopSegmentCollection","stop","_record","record","emit","stopRecording","takeSubsequentFullSnapshot","flushMutations","subscribeViewEnded","subscribe","VIEW_ENDED","timestamp","timeStampNow","type","RecordType","ViewEnd","scribeViewCreated","VIEW_CREATED","view","startClocks","timeStamp","unsubscribe"],"sources":["../../src/boot/startRecording.js"],"sourcesContent":["import {\n  timeStampNow,\n  createHttpRequest,\n  LifeCycleEventType,\n  addTelemetryDebug\n} from '@cloudcare/browser-core'\nimport { record } from '../domain/replay/record'\nimport {\n  startSegmentCollection,\n  SEGMENT_BYTES_LIMIT\n} from '../domain/replay/segmentCollection'\nimport { RecordType } from '../types'\n\nexport function startRecording(\n  lifeCycle,\n  configuration,\n  sessionManager,\n  viewContexts,\n  encoder,\n  httpRequest\n) {\n  var reportError = function (error) {\n    lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, { error: error })\n    addTelemetryDebug('Error reported to customer', {\n      'error.message': error.message\n    })\n  }\n\n  var replayRequest =\n    httpRequest ||\n    createHttpRequest(\n      configuration.sessionReplayEndPoint,\n      SEGMENT_BYTES_LIMIT,\n      false,\n      reportError\n    )\n\n  var segmentCollection = startSegmentCollection(\n    lifeCycle,\n    configuration,\n    sessionManager,\n    viewContexts,\n    replayRequest,\n    encoder\n  )\n  var addRecord = segmentCollection.addRecord\n  var stopSegmentCollection = segmentCollection.stop\n\n  var _record = record({\n    emit: addRecord,\n    configuration: configuration,\n    lifeCycle: lifeCycle\n  })\n  var stopRecording = _record.stop\n  var takeSubsequentFullSnapshot = _record.takeSubsequentFullSnapshot\n  var flushMutations = _record.flushMutations\n  var subscribeViewEnded = lifeCycle.subscribe(\n    LifeCycleEventType.VIEW_ENDED,\n    function () {\n      flushMutations()\n      addRecord({\n        timestamp: timeStampNow(),\n        type: RecordType.ViewEnd\n      })\n    }\n  )\n  var scribeViewCreated = lifeCycle.subscribe(\n    LifeCycleEventType.VIEW_CREATED,\n    function (view) {\n      takeSubsequentFullSnapshot(view.startClocks.timeStamp)\n    }\n  )\n\n  return {\n    stop: function () {\n      subscribeViewEnded.unsubscribe()\n      scribeViewCreated.unsubscribe()\n      stopRecording()\n      stopSegmentCollection()\n    }\n  }\n}\n"],"mappings":";;;;;;AAAA,IAAAA,YAAA,GAAAC,OAAA;AAMA,IAAAC,QAAA,GAAAD,OAAA;AACA,IAAAE,kBAAA,GAAAF,OAAA;AAIA,IAAAG,MAAA,GAAAH,OAAA;AAEO,SAASI,cAAcA,CAC5BC,SAAS,EACTC,aAAa,EACbC,cAAc,EACdC,YAAY,EACZC,OAAO,EACPC,WAAW,EACX;EACA,IAAIC,WAAW,GAAG,SAAdA,WAAWA,CAAaC,KAAK,EAAE;IACjCP,SAAS,CAACQ,MAAM,CAACC,+BAAkB,CAACC,mBAAmB,EAAE;MAAEH,KAAK,EAAEA;IAAM,CAAC,CAAC;IAC1E,IAAAI,8BAAiB,EAAC,4BAA4B,EAAE;MAC9C,eAAe,EAAEJ,KAAK,CAACK;IACzB,CAAC,CAAC;EACJ,CAAC;EAED,IAAIC,aAAa,GACfR,WAAW,IACX,IAAAS,8BAAiB,EACfb,aAAa,CAACc,qBAAqB,EACnCC,sCAAmB,EACnB,KAAK,EACLV,WACF,CAAC;EAEH,IAAIW,iBAAiB,GAAG,IAAAC,yCAAsB,EAC5ClB,SAAS,EACTC,aAAa,EACbC,cAAc,EACdC,YAAY,EACZU,aAAa,EACbT,OACF,CAAC;EACD,IAAIe,SAAS,GAAGF,iBAAiB,CAACE,SAAS;EAC3C,IAAIC,qBAAqB,GAAGH,iBAAiB,CAACI,IAAI;EAElD,IAAIC,OAAO,GAAG,IAAAC,eAAM,EAAC;IACnBC,IAAI,EAAEL,SAAS;IACflB,aAAa,EAAEA,aAAa;IAC5BD,SAAS,EAAEA;EACb,CAAC,CAAC;EACF,IAAIyB,aAAa,GAAGH,OAAO,CAACD,IAAI;EAChC,IAAIK,0BAA0B,GAAGJ,OAAO,CAACI,0BAA0B;EACnE,IAAIC,cAAc,GAAGL,OAAO,CAACK,cAAc;EAC3C,IAAIC,kBAAkB,GAAG5B,SAAS,CAAC6B,SAAS,CAC1CpB,+BAAkB,CAACqB,UAAU,EAC7B,YAAY;IACVH,cAAc,CAAC,CAAC;IAChBR,SAAS,CAAC;MACRY,SAAS,EAAE,IAAAC,yBAAY,EAAC,CAAC;MACzBC,IAAI,EAAEC,iBAAU,CAACC;IACnB,CAAC,CAAC;EACJ,CACF,CAAC;EACD,IAAIC,iBAAiB,GAAGpC,SAAS,CAAC6B,SAAS,CACzCpB,+BAAkB,CAAC4B,YAAY,EAC/B,UAAUC,IAAI,EAAE;IACdZ,0BAA0B,CAACY,IAAI,CAACC,WAAW,CAACC,SAAS,CAAC;EACxD,CACF,CAAC;EAED,OAAO;IACLnB,IAAI,EAAE,SAAAA,KAAA,EAAY;MAChBO,kBAAkB,CAACa,WAAW,CAAC,CAAC;MAChCL,iBAAiB,CAACK,WAAW,CAAC,CAAC;MAC/BhB,aAAa,CAAC,CAAC;MACfL,qBAAqB,CAAC,CAAC;IACzB;EACF,CAAC;AACH","ignoreList":[]}