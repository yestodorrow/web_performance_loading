{"version":3,"file":"requestCollection.js","names":["_browserCore","require","_resourceUtils","_tracer","nextRequestIndex","startRequestCollection","lifeCycle","configuration","sessionManager","tracer","startTracer","trackXhr","trackFetch","subscription","initXhrObservable","subscribe","rawContext","context","isAllowedRequestUrl","url","state","traceXhr","xhr","requestIndex","getNextRequestIndex","notify","LifeCycleEventType","REQUEST_STARTED","clearTracingIfNeeded","REQUEST_COMPLETED","duration","method","spanId","startClocks","status","traceId","traceSampled","type","RequestType","XHR","stop","unsubscribe","initFetchObservable","traceFetch","waitForResponseToComplete","responseType","FETCH","response","init","input","result","callback","clonedResponse","tryToClone","body","elapsed","timeStamp","timeStampNow","readBytesFromStream","bytesLimit","Number","POSITIVE_INFINITY","collectStreamBody"],"sources":["../../src/domain/requestCollection.js"],"sourcesContent":["import {\n  RequestType,\n  initFetchObservable,\n  initXhrObservable,\n  LifeCycleEventType,\n  tryToClone,\n  readBytesFromStream,\n  elapsed,\n  timeStampNow\n} from '@cloudcare/browser-core'\nimport { isAllowedRequestUrl } from './rumEventsCollection/resource/resourceUtils'\nimport { startTracer } from './tracing/tracer'\n\nvar nextRequestIndex = 1\n\nexport function startRequestCollection(\n  lifeCycle,\n  configuration,\n  sessionManager\n) {\n  var tracer = startTracer(configuration, sessionManager)\n  trackXhr(lifeCycle, configuration, tracer)\n  trackFetch(lifeCycle, configuration, tracer)\n}\n\nexport function trackXhr(lifeCycle, configuration, tracer) {\n  var subscription = initXhrObservable().subscribe(function (rawContext) {\n    var context = rawContext\n    if (!isAllowedRequestUrl(configuration, context.url)) {\n      return\n    }\n\n    switch (context.state) {\n      case 'start':\n        tracer.traceXhr(context, context.xhr)\n        context.requestIndex = getNextRequestIndex()\n\n        lifeCycle.notify(LifeCycleEventType.REQUEST_STARTED, {\n          requestIndex: context.requestIndex,\n          url: context.url\n        })\n        break\n      case 'complete':\n        tracer.clearTracingIfNeeded(context)\n        lifeCycle.notify(LifeCycleEventType.REQUEST_COMPLETED, {\n          duration: context.duration,\n          method: context.method,\n          requestIndex: context.requestIndex,\n          spanId: context.spanId,\n          startClocks: context.startClocks,\n          status: context.status,\n          traceId: context.traceId,\n          traceSampled: context.traceSampled,\n          type: RequestType.XHR,\n          url: context.url,\n          xhr: context.xhr\n        })\n        break\n    }\n  })\n\n  return {\n    stop: function () {\n      return subscription.unsubscribe()\n    }\n  }\n}\n\nexport function trackFetch(lifeCycle, configuration, tracer) {\n  var subscription = initFetchObservable().subscribe(function (rawContext) {\n    var context = rawContext\n    if (!isAllowedRequestUrl(configuration, context.url)) {\n      return\n    }\n\n    switch (context.state) {\n      case 'start':\n        tracer.traceFetch(context)\n        context.requestIndex = getNextRequestIndex()\n\n        lifeCycle.notify(LifeCycleEventType.REQUEST_STARTED, {\n          requestIndex: context.requestIndex,\n          url: context.url\n        })\n        break\n      case 'resolve':\n        waitForResponseToComplete(context, function (duration) {\n          tracer.clearTracingIfNeeded(context)\n          lifeCycle.notify(LifeCycleEventType.REQUEST_COMPLETED, {\n            duration: duration,\n            method: context.method,\n            requestIndex: context.requestIndex,\n            responseType: context.responseType,\n            spanId: context.spanId,\n            startClocks: context.startClocks,\n            status: context.status,\n            traceId: context.traceId,\n            traceSampled: context.traceSampled,\n            type: RequestType.FETCH,\n            url: context.url,\n            response: context.response,\n            init: context.init,\n            input: context.input\n          })\n        })\n        break\n    }\n  })\n  return {\n    stop: function () {\n      return subscription.unsubscribe()\n    }\n  }\n}\n\nfunction getNextRequestIndex() {\n  var result = nextRequestIndex\n  nextRequestIndex += 1\n  return result\n}\n\nfunction waitForResponseToComplete(context, callback) {\n  var clonedResponse = context.response && tryToClone(context.response)\n  if (!clonedResponse || !clonedResponse.body) {\n    // do not try to wait for the response if the clone failed, fetch error or null body\n    callback(elapsed(context.startClocks.timeStamp, timeStampNow()))\n  } else {\n    readBytesFromStream(\n      clonedResponse.body,\n      function () {\n        callback(elapsed(context.startClocks.timeStamp, timeStampNow()))\n      },\n      {\n        bytesLimit: Number.POSITIVE_INFINITY,\n        collectStreamBody: false\n      }\n    )\n  }\n}\n"],"mappings":"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","ignoreList":[]}