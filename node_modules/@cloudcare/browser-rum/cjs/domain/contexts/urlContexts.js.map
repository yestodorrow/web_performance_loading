{"version":3,"file":"urlContexts.js","names":["_browserCore","require","URL_CONTEXT_TIME_OUT_DELAY","SESSION_TIME_OUT_DELAY","exports","startUrlContexts","lifeCycle","locationChangeObservable","location","urlContextHistory","ContextHistory","previousViewUrl","subscribe","LifeCycleEventType","BEFORE_VIEW_CREATED","data","viewUrl","href","add","buildUrlContext","url","referrer","document","startClocks","relative","AFTER_VIEW_ENDED","closeActive","endClocks","locationChangeSubscription","current","find","changeTime","relativeNow","newLocation","path","pathname","hash","isHashAnAnchor","getPathFromHash","host","pathGroup","replaceNumberCharByPath","urlQuery","getQueryParamsFromUrl","findUrl","startTime","stop","unsubscribe"],"sources":["../../../src/domain/contexts/urlContexts.js"],"sourcesContent":["import {\n  LifeCycleEventType,\n  SESSION_TIME_OUT_DELAY,\n  relativeNow,\n  ContextHistory,\n  replaceNumberCharByPath,\n  getQueryParamsFromUrl,\n  isHashAnAnchor,\n  getPathFromHash\n} from '@cloudcare/browser-core'\n\n/**\n * We want to attach to an event:\n * - the url corresponding to its start\n * - the referrer corresponding to the previous view url (or document referrer for initial view)\n */\n\nexport var URL_CONTEXT_TIME_OUT_DELAY = SESSION_TIME_OUT_DELAY\n\nexport function startUrlContexts(\n  lifeCycle,\n  locationChangeObservable,\n  location\n) {\n  var urlContextHistory = new ContextHistory(URL_CONTEXT_TIME_OUT_DELAY)\n\n  var previousViewUrl\n\n  lifeCycle.subscribe(LifeCycleEventType.BEFORE_VIEW_CREATED, function (data) {\n    var viewUrl = location.href\n    urlContextHistory.add(\n      buildUrlContext({\n        url: viewUrl,\n        location: location,\n        referrer: !previousViewUrl ? document.referrer : previousViewUrl\n      }),\n      data.startClocks.relative\n    )\n    previousViewUrl = viewUrl\n  })\n  lifeCycle.subscribe(LifeCycleEventType.AFTER_VIEW_ENDED, function (data) {\n    urlContextHistory.closeActive(data.endClocks.relative)\n  })\n  var locationChangeSubscription = locationChangeObservable.subscribe(function (\n    data\n  ) {\n    var current = urlContextHistory.find()\n    if (current) {\n      var changeTime = relativeNow()\n      urlContextHistory.closeActive(changeTime)\n      urlContextHistory.add(\n        buildUrlContext({\n          url: data.newLocation.href,\n          location: data.newLocation,\n          referrer: current.referrer\n        }),\n        changeTime\n      )\n    }\n  })\n\n  function buildUrlContext(data) {\n    var path = data.location.pathname\n    var hash = data.location.hash\n    if (hash && !isHashAnAnchor(hash)) {\n      path = '/' + getPathFromHash(hash)\n    }\n    return {\n      url: data.url,\n      referrer: data.referrer,\n      host: data.location.host,\n      path: path,\n      pathGroup: replaceNumberCharByPath(path),\n      urlQuery: getQueryParamsFromUrl(data.location.href)\n    }\n  }\n\n  return {\n    findUrl: function (startTime) {\n      return urlContextHistory.find(startTime)\n    },\n    stop: function () {\n      locationChangeSubscription.unsubscribe()\n      urlContextHistory.stop()\n    }\n  }\n}\n"],"mappings":";;;;;;;AAAA,IAAAA,YAAA,GAAAC,OAAA;AAWA;AACA;AACA;AACA;AACA;;AAEO,IAAIC,0BAA0B,GAAGC,mCAAsB;AAAAC,OAAA,CAAAF,0BAAA,GAAAA,0BAAA;AAEvD,SAASG,gBAAgBA,CAC9BC,SAAS,EACTC,wBAAwB,EACxBC,QAAQ,EACR;EACA,IAAIC,iBAAiB,GAAG,IAAIC,2BAAc,CAACR,0BAA0B,CAAC;EAEtE,IAAIS,eAAe;EAEnBL,SAAS,CAACM,SAAS,CAACC,+BAAkB,CAACC,mBAAmB,EAAE,UAAUC,IAAI,EAAE;IAC1E,IAAIC,OAAO,GAAGR,QAAQ,CAACS,IAAI;IAC3BR,iBAAiB,CAACS,GAAG,CACnBC,eAAe,CAAC;MACdC,GAAG,EAAEJ,OAAO;MACZR,QAAQ,EAAEA,QAAQ;MAClBa,QAAQ,EAAE,CAACV,eAAe,GAAGW,QAAQ,CAACD,QAAQ,GAAGV;IACnD,CAAC,CAAC,EACFI,IAAI,CAACQ,WAAW,CAACC,QACnB,CAAC;IACDb,eAAe,GAAGK,OAAO;EAC3B,CAAC,CAAC;EACFV,SAAS,CAACM,SAAS,CAACC,+BAAkB,CAACY,gBAAgB,EAAE,UAAUV,IAAI,EAAE;IACvEN,iBAAiB,CAACiB,WAAW,CAACX,IAAI,CAACY,SAAS,CAACH,QAAQ,CAAC;EACxD,CAAC,CAAC;EACF,IAAII,0BAA0B,GAAGrB,wBAAwB,CAACK,SAAS,CAAC,UAClEG,IAAI,EACJ;IACA,IAAIc,OAAO,GAAGpB,iBAAiB,CAACqB,IAAI,CAAC,CAAC;IACtC,IAAID,OAAO,EAAE;MACX,IAAIE,UAAU,GAAG,IAAAC,wBAAW,EAAC,CAAC;MAC9BvB,iBAAiB,CAACiB,WAAW,CAACK,UAAU,CAAC;MACzCtB,iBAAiB,CAACS,GAAG,CACnBC,eAAe,CAAC;QACdC,GAAG,EAAEL,IAAI,CAACkB,WAAW,CAAChB,IAAI;QAC1BT,QAAQ,EAAEO,IAAI,CAACkB,WAAW;QAC1BZ,QAAQ,EAAEQ,OAAO,CAACR;MACpB,CAAC,CAAC,EACFU,UACF,CAAC;IACH;EACF,CAAC,CAAC;EAEF,SAASZ,eAAeA,CAACJ,IAAI,EAAE;IAC7B,IAAImB,IAAI,GAAGnB,IAAI,CAACP,QAAQ,CAAC2B,QAAQ;IACjC,IAAIC,IAAI,GAAGrB,IAAI,CAACP,QAAQ,CAAC4B,IAAI;IAC7B,IAAIA,IAAI,IAAI,CAAC,IAAAC,2BAAc,EAACD,IAAI,CAAC,EAAE;MACjCF,IAAI,GAAG,GAAG,GAAG,IAAAI,4BAAe,EAACF,IAAI,CAAC;IACpC;IACA,OAAO;MACLhB,GAAG,EAAEL,IAAI,CAACK,GAAG;MACbC,QAAQ,EAAEN,IAAI,CAACM,QAAQ;MACvBkB,IAAI,EAAExB,IAAI,CAACP,QAAQ,CAAC+B,IAAI;MACxBL,IAAI,EAAEA,IAAI;MACVM,SAAS,EAAE,IAAAC,oCAAuB,EAACP,IAAI,CAAC;MACxCQ,QAAQ,EAAE,IAAAC,kCAAqB,EAAC5B,IAAI,CAACP,QAAQ,CAACS,IAAI;IACpD,CAAC;EACH;EAEA,OAAO;IACL2B,OAAO,EAAE,SAAAA,QAAUC,SAAS,EAAE;MAC5B,OAAOpC,iBAAiB,CAACqB,IAAI,CAACe,SAAS,CAAC;IAC1C,CAAC;IACDC,IAAI,EAAE,SAAAA,KAAA,EAAY;MAChBlB,0BAA0B,CAACmB,WAAW,CAAC,CAAC;MACxCtC,iBAAiB,CAACqC,IAAI,CAAC,CAAC;IAC1B;EACF,CAAC;AACH","ignoreList":[]}