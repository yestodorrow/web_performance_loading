{"version":3,"file":"foregroundContexts.js","names":["_browserCore","require","MAX_NUMBER_OF_SELECTABLE_FOREGROUND_PERIODS","exports","MAX_NUMBER_OF_STORED_FOREGROUND_PERIODS","foregroundPeriods","startForegroundContexts","document","hasFocus","addNewForegroundPeriod","foregroundTracking","trackFocus","blurTracking","trackBlur","closeForegroundPeriod","isInForegroundAt","selectInForegroundPeriodsFor","stop","length","currentForegroundPeriod","now","relativeNow","undefined","end","push","start","onFocusChange","addEventListener","window","DOM_EVENT","FOCUS","event","isTrusted","onBlurChange","BLUR","startTime","i","foregroundPeriod","eventStartTime","duration","eventEndTime","addDuration","filteredForegroundPeriods","earliestIndex","Math","max","startDuration","elapsed","endTime","endDuration","unshift","toServerDuration"],"sources":["../../../src/domain/contexts/foregroundContexts.js"],"sourcesContent":["import {\n  addDuration,\n  addEventListener,\n  DOM_EVENT,\n  elapsed,\n  relativeNow,\n  toServerDuration\n} from '@cloudcare/browser-core'\n\n// Arbitrary value to cap number of element mostly for backend & to save bandwidth\nexport var MAX_NUMBER_OF_SELECTABLE_FOREGROUND_PERIODS = 500\n// Arbitrary value to cap number of element mostly for memory consumption in the browser\nexport var MAX_NUMBER_OF_STORED_FOREGROUND_PERIODS = 2500\n\nvar foregroundPeriods = []\n\nexport function startForegroundContexts() {\n  if (document.hasFocus()) {\n    addNewForegroundPeriod()\n  }\n\n  var foregroundTracking = trackFocus(addNewForegroundPeriod)\n  var blurTracking = trackBlur(closeForegroundPeriod)\n  return {\n    isInForegroundAt: isInForegroundAt,\n    selectInForegroundPeriodsFor: selectInForegroundPeriodsFor,\n    stop: function () {\n      foregroundPeriods = []\n      foregroundTracking.stop()\n      blurTracking.stop()\n    }\n  }\n}\n\nexport function addNewForegroundPeriod() {\n  if (foregroundPeriods.length > MAX_NUMBER_OF_STORED_FOREGROUND_PERIODS) {\n    return\n  }\n  var currentForegroundPeriod = foregroundPeriods[foregroundPeriods.length - 1]\n  var now = relativeNow()\n  if (\n    currentForegroundPeriod !== undefined &&\n    currentForegroundPeriod.end === undefined\n  ) {\n    return\n  }\n  foregroundPeriods.push({\n    start: now\n  })\n}\n\nexport function closeForegroundPeriod() {\n  if (foregroundPeriods.length === 0) {\n    return\n  }\n  var currentForegroundPeriod = foregroundPeriods[foregroundPeriods.length - 1]\n  var now = relativeNow()\n  if (currentForegroundPeriod.end !== undefined) {\n    return\n  }\n  currentForegroundPeriod.end = now\n}\n\nfunction trackFocus(onFocusChange) {\n  return addEventListener(window, DOM_EVENT.FOCUS, function (event) {\n    if (!event.isTrusted) {\n      return\n    }\n    onFocusChange()\n  })\n}\n\nfunction trackBlur(onBlurChange) {\n  return addEventListener(window, DOM_EVENT.BLUR, function (event) {\n    if (!event.isTrusted) {\n      return\n    }\n    onBlurChange()\n  })\n}\n\nfunction isInForegroundAt(startTime) {\n  for (var i = foregroundPeriods.length - 1; i >= 0; i--) {\n    var foregroundPeriod = foregroundPeriods[i]\n    if (\n      foregroundPeriod.end !== undefined &&\n      startTime > foregroundPeriod.end\n    ) {\n      break\n    }\n    if (\n      startTime > foregroundPeriod.start &&\n      (foregroundPeriod.end === undefined || startTime < foregroundPeriod.end)\n    ) {\n      return true\n    }\n  }\n  return false\n}\n\nfunction selectInForegroundPeriodsFor(eventStartTime, duration) {\n  var eventEndTime = addDuration(eventStartTime, duration)\n  var filteredForegroundPeriods = []\n\n  var earliestIndex = Math.max(\n    0,\n    foregroundPeriods.length - MAX_NUMBER_OF_SELECTABLE_FOREGROUND_PERIODS\n  )\n  for (var i = foregroundPeriods.length - 1; i >= earliestIndex; i--) {\n    var foregroundPeriod = foregroundPeriods[i]\n    if (\n      foregroundPeriod.end !== undefined &&\n      eventStartTime > foregroundPeriod.end\n    ) {\n      // event starts after the end of the current focus period\n      // since the array is sorted, we can stop looking for foreground periods\n      break\n    }\n    if (eventEndTime < foregroundPeriod.start) {\n      // event ends before the start of the current focus period\n      // continue to previous one\n      continue\n    }\n    var startTime =\n      eventStartTime > foregroundPeriod.start\n        ? eventStartTime\n        : foregroundPeriod.start\n    var startDuration = elapsed(eventStartTime, startTime)\n    var endTime =\n      foregroundPeriod.end === undefined || eventEndTime < foregroundPeriod.end\n        ? eventEndTime\n        : foregroundPeriod.end\n    var endDuration = elapsed(startTime, endTime)\n    filteredForegroundPeriods.unshift({\n      start: toServerDuration(startDuration),\n      duration: toServerDuration(endDuration)\n    })\n  }\n  return filteredForegroundPeriods\n}\n"],"mappings":";;;;;;;;;AAAA,IAAAA,YAAA,GAAAC,OAAA;AASA;AACO,IAAIC,2CAA2C,GAAG,GAAG;AAC5D;AAAAC,OAAA,CAAAD,2CAAA,GAAAA,2CAAA;AACO,IAAIE,uCAAuC,GAAG,IAAI;AAAAD,OAAA,CAAAC,uCAAA,GAAAA,uCAAA;AAEzD,IAAIC,iBAAiB,GAAG,EAAE;AAEnB,SAASC,uBAAuBA,CAAA,EAAG;EACxC,IAAIC,QAAQ,CAACC,QAAQ,CAAC,CAAC,EAAE;IACvBC,sBAAsB,CAAC,CAAC;EAC1B;EAEA,IAAIC,kBAAkB,GAAGC,UAAU,CAACF,sBAAsB,CAAC;EAC3D,IAAIG,YAAY,GAAGC,SAAS,CAACC,qBAAqB,CAAC;EACnD,OAAO;IACLC,gBAAgB,EAAEA,gBAAgB;IAClCC,4BAA4B,EAAEA,4BAA4B;IAC1DC,IAAI,EAAE,SAAAA,KAAA,EAAY;MAChBZ,iBAAiB,GAAG,EAAE;MACtBK,kBAAkB,CAACO,IAAI,CAAC,CAAC;MACzBL,YAAY,CAACK,IAAI,CAAC,CAAC;IACrB;EACF,CAAC;AACH;AAEO,SAASR,sBAAsBA,CAAA,EAAG;EACvC,IAAIJ,iBAAiB,CAACa,MAAM,GAAGd,uCAAuC,EAAE;IACtE;EACF;EACA,IAAIe,uBAAuB,GAAGd,iBAAiB,CAACA,iBAAiB,CAACa,MAAM,GAAG,CAAC,CAAC;EAC7E,IAAIE,GAAG,GAAG,IAAAC,wBAAW,EAAC,CAAC;EACvB,IACEF,uBAAuB,KAAKG,SAAS,IACrCH,uBAAuB,CAACI,GAAG,KAAKD,SAAS,EACzC;IACA;EACF;EACAjB,iBAAiB,CAACmB,IAAI,CAAC;IACrBC,KAAK,EAAEL;EACT,CAAC,CAAC;AACJ;AAEO,SAASN,qBAAqBA,CAAA,EAAG;EACtC,IAAIT,iBAAiB,CAACa,MAAM,KAAK,CAAC,EAAE;IAClC;EACF;EACA,IAAIC,uBAAuB,GAAGd,iBAAiB,CAACA,iBAAiB,CAACa,MAAM,GAAG,CAAC,CAAC;EAC7E,IAAIE,GAAG,GAAG,IAAAC,wBAAW,EAAC,CAAC;EACvB,IAAIF,uBAAuB,CAACI,GAAG,KAAKD,SAAS,EAAE;IAC7C;EACF;EACAH,uBAAuB,CAACI,GAAG,GAAGH,GAAG;AACnC;AAEA,SAAST,UAAUA,CAACe,aAAa,EAAE;EACjC,OAAO,IAAAC,6BAAgB,EAACC,MAAM,EAAEC,sBAAS,CAACC,KAAK,EAAE,UAAUC,KAAK,EAAE;IAChE,IAAI,CAACA,KAAK,CAACC,SAAS,EAAE;MACpB;IACF;IACAN,aAAa,CAAC,CAAC;EACjB,CAAC,CAAC;AACJ;AAEA,SAASb,SAASA,CAACoB,YAAY,EAAE;EAC/B,OAAO,IAAAN,6BAAgB,EAACC,MAAM,EAAEC,sBAAS,CAACK,IAAI,EAAE,UAAUH,KAAK,EAAE;IAC/D,IAAI,CAACA,KAAK,CAACC,SAAS,EAAE;MACpB;IACF;IACAC,YAAY,CAAC,CAAC;EAChB,CAAC,CAAC;AACJ;AAEA,SAASlB,gBAAgBA,CAACoB,SAAS,EAAE;EACnC,KAAK,IAAIC,CAAC,GAAG/B,iBAAiB,CAACa,MAAM,GAAG,CAAC,EAAEkB,CAAC,IAAI,CAAC,EAAEA,CAAC,EAAE,EAAE;IACtD,IAAIC,gBAAgB,GAAGhC,iBAAiB,CAAC+B,CAAC,CAAC;IAC3C,IACEC,gBAAgB,CAACd,GAAG,KAAKD,SAAS,IAClCa,SAAS,GAAGE,gBAAgB,CAACd,GAAG,EAChC;MACA;IACF;IACA,IACEY,SAAS,GAAGE,gBAAgB,CAACZ,KAAK,KACjCY,gBAAgB,CAACd,GAAG,KAAKD,SAAS,IAAIa,SAAS,GAAGE,gBAAgB,CAACd,GAAG,CAAC,EACxE;MACA,OAAO,IAAI;IACb;EACF;EACA,OAAO,KAAK;AACd;AAEA,SAASP,4BAA4BA,CAACsB,cAAc,EAAEC,QAAQ,EAAE;EAC9D,IAAIC,YAAY,GAAG,IAAAC,wBAAW,EAACH,cAAc,EAAEC,QAAQ,CAAC;EACxD,IAAIG,yBAAyB,GAAG,EAAE;EAElC,IAAIC,aAAa,GAAGC,IAAI,CAACC,GAAG,CAC1B,CAAC,EACDxC,iBAAiB,CAACa,MAAM,GAAGhB,2CAC7B,CAAC;EACD,KAAK,IAAIkC,CAAC,GAAG/B,iBAAiB,CAACa,MAAM,GAAG,CAAC,EAAEkB,CAAC,IAAIO,aAAa,EAAEP,CAAC,EAAE,EAAE;IAClE,IAAIC,gBAAgB,GAAGhC,iBAAiB,CAAC+B,CAAC,CAAC;IAC3C,IACEC,gBAAgB,CAACd,GAAG,KAAKD,SAAS,IAClCgB,cAAc,GAAGD,gBAAgB,CAACd,GAAG,EACrC;MACA;MACA;MACA;IACF;IACA,IAAIiB,YAAY,GAAGH,gBAAgB,CAACZ,KAAK,EAAE;MACzC;MACA;MACA;IACF;IACA,IAAIU,SAAS,GACXG,cAAc,GAAGD,gBAAgB,CAACZ,KAAK,GACnCa,cAAc,GACdD,gBAAgB,CAACZ,KAAK;IAC5B,IAAIqB,aAAa,GAAG,IAAAC,oBAAO,EAACT,cAAc,EAAEH,SAAS,CAAC;IACtD,IAAIa,OAAO,GACTX,gBAAgB,CAACd,GAAG,KAAKD,SAAS,IAAIkB,YAAY,GAAGH,gBAAgB,CAACd,GAAG,GACrEiB,YAAY,GACZH,gBAAgB,CAACd,GAAG;IAC1B,IAAI0B,WAAW,GAAG,IAAAF,oBAAO,EAACZ,SAAS,EAAEa,OAAO,CAAC;IAC7CN,yBAAyB,CAACQ,OAAO,CAAC;MAChCzB,KAAK,EAAE,IAAA0B,6BAAgB,EAACL,aAAa,CAAC;MACtCP,QAAQ,EAAE,IAAAY,6BAAgB,EAACF,WAAW;IACxC,CAAC,CAAC;EACJ;EACA,OAAOP,yBAAyB;AAClC","ignoreList":[]}