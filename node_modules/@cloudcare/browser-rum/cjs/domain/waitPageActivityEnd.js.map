{"version":3,"file":"waitPageActivityEnd.js","names":["_browserCore","require","PAGE_ACTIVITY_VALIDATION_DELAY","exports","PAGE_ACTIVITY_END_DELAY","waitPageActivityEnd","lifeCycle","domMutationObservable","configuration","pageActivityEndCallback","maxDuration","pageActivityObservable","createPageActivityObservable","doWaitPageActivityEnd","pageActivityEndTimeoutId","hasCompleted","validationTimeoutId","setTimeout","complete","hadActivity","maxDurationTimeoutId","undefined","end","timeStampNow","pageActivitySubscription","subscribe","data","isBusy","clearTimeout","lastChangeTime","stop","unsubscribe","event","Observable","observable","subscriptions","firstRequestIndex","pendingRequestsCount","push","notifyPageActivity","LifeCycleEventType","PERFORMANCE_ENTRIES_COLLECTED","entries","some","entry","entryType","isExcludedUrl","name","REQUEST_STARTED","startEvent","url","requestIndex","REQUEST_COMPLETED","request","_trackWindowOpen","trackWindowOpen","stopTrackingWindowOpen","each","s","notify","requestUrl","matchList","excludedActivityUrls","callback","instrumentMethodAndCallOriginal","window","before"],"sources":["../../src/domain/waitPageActivityEnd.js"],"sourcesContent":["import {\n  Observable,\n  each,\n  timeStampNow,\n  LifeCycleEventType,\n  some,\n  matchList,\n  instrumentMethodAndCallOriginal,\n  setTimeout,\n  clearTimeout\n} from '@cloudcare/browser-core'\n\n// Delay to wait for a page activity to validate the tracking process\nexport var PAGE_ACTIVITY_VALIDATION_DELAY = 100\n// Delay to wait after a page activity to end the tracking process\nexport var PAGE_ACTIVITY_END_DELAY = 100\n\n/**\n * Wait for the page activity end\n *\n * Detection lifecycle:\n * ```\n *                        Wait page activity end\n *              .-------------------'--------------------.\n *              v                                        v\n *     [Wait for a page activity ]          [Wait for a maximum duration]\n *     [timeout: VALIDATION_DELAY]          [  timeout: maxDuration     ]\n *          /                  \\                           |\n *         v                    v                          |\n *  [No page activity]   [Page activity]                   |\n *         |                   |,----------------------.   |\n *         v                   v                       |   |\n *     (Discard)     [Wait for a page activity]        |   |\n *                   [   timeout: END_DELAY   ]        |   |\n *                       /                \\            |   |\n *                      v                  v           |   |\n *             [No page activity]    [Page activity]   |   |\n *                      |                 |            |   |\n *                      |                 '------------'   |\n *                      '-----------. ,--------------------'\n *                                   v\n *                                 (End)\n * ```\n *\n * Note: by assuming that maxDuration is greater than VALIDATION_DELAY, we are sure that if the\n * process is still alive after maxDuration, it has been validated.\n */\nexport function waitPageActivityEnd(\n  lifeCycle,\n  domMutationObservable,\n  configuration,\n  pageActivityEndCallback,\n  maxDuration\n) {\n  var pageActivityObservable = createPageActivityObservable(\n    lifeCycle,\n    domMutationObservable,\n    configuration\n  )\n  return doWaitPageActivityEnd(\n    pageActivityObservable,\n    pageActivityEndCallback,\n    maxDuration\n  )\n}\n\nexport function doWaitPageActivityEnd(\n  pageActivityObservable,\n  pageActivityEndCallback,\n  maxDuration\n) {\n  var pageActivityEndTimeoutId\n  var hasCompleted = false\n\n  var validationTimeoutId = setTimeout(function () {\n    complete({ hadActivity: false })\n  }, PAGE_ACTIVITY_VALIDATION_DELAY)\n\n  var maxDurationTimeoutId =\n    maxDuration !== undefined\n      ? setTimeout(function () {\n          return complete({ hadActivity: true, end: timeStampNow() })\n        }, maxDuration)\n      : undefined\n\n  var pageActivitySubscription = pageActivityObservable.subscribe(function (\n    data\n  ) {\n    var isBusy = data.isBusy\n    clearTimeout(validationTimeoutId)\n    clearTimeout(pageActivityEndTimeoutId)\n    var lastChangeTime = timeStampNow()\n    if (!isBusy) {\n      pageActivityEndTimeoutId = setTimeout(function () {\n        complete({ hadActivity: true, end: lastChangeTime })\n      }, PAGE_ACTIVITY_END_DELAY)\n    }\n  })\n\n  var stop = function () {\n    hasCompleted = true\n    clearTimeout(validationTimeoutId)\n    clearTimeout(pageActivityEndTimeoutId)\n    clearTimeout(maxDurationTimeoutId)\n    pageActivitySubscription.unsubscribe()\n  }\n\n  function complete(event) {\n    if (hasCompleted) {\n      return\n    }\n    stop()\n    pageActivityEndCallback(event)\n  }\n  return { stop: stop }\n}\n\nexport function createPageActivityObservable(\n  lifeCycle,\n  domMutationObservable,\n  configuration\n) {\n  return new Observable(function (observable) {\n    var subscriptions = []\n    var firstRequestIndex\n    var pendingRequestsCount = 0\n\n    subscriptions.push(\n      domMutationObservable.subscribe(notifyPageActivity),\n      lifeCycle.subscribe(\n        LifeCycleEventType.PERFORMANCE_ENTRIES_COLLECTED,\n        function (entries) {\n          if (\n            some(entries, function (entry) {\n              return (\n                entry.entryType === 'resource' &&\n                !isExcludedUrl(configuration, entry.name)\n              )\n            })\n          ) {\n            notifyPageActivity()\n          }\n        }\n      ),\n      lifeCycle.subscribe(\n        LifeCycleEventType.REQUEST_STARTED,\n        function (startEvent) {\n          if (isExcludedUrl(configuration, startEvent.url)) {\n            return\n          }\n\n          if (firstRequestIndex === undefined) {\n            firstRequestIndex = startEvent.requestIndex\n          }\n          pendingRequestsCount += 1\n          notifyPageActivity()\n        }\n      ),\n      lifeCycle.subscribe(\n        LifeCycleEventType.REQUEST_COMPLETED,\n        function (request) {\n          if (\n            isExcludedUrl(configuration, request.url) ||\n            firstRequestIndex === undefined ||\n            // If the request started before the tracking start, ignore it\n            request.requestIndex < firstRequestIndex\n          ) {\n            return\n          }\n          pendingRequestsCount -= 1\n          notifyPageActivity()\n        }\n      )\n    )\n\n    var _trackWindowOpen = trackWindowOpen(notifyPageActivity)\n    var stopTrackingWindowOpen = _trackWindowOpen.stop\n    return function () {\n      stopTrackingWindowOpen()\n      each(subscriptions, function (s) {\n        s.unsubscribe()\n      })\n    }\n\n    function notifyPageActivity() {\n      observable.notify({ isBusy: pendingRequestsCount > 0 })\n    }\n  })\n}\n\nfunction isExcludedUrl(configuration, requestUrl) {\n  return matchList(configuration.excludedActivityUrls, requestUrl)\n}\n\nfunction trackWindowOpen(callback) {\n  return instrumentMethodAndCallOriginal(window, 'open', { before: callback })\n}\n"],"mappings":"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","ignoreList":[]}