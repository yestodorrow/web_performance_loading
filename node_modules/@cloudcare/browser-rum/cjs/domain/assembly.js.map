{"version":3,"file":"assembly.js","names":["_browserCore","require","SessionType","SYNTHETICS","USER","VIEW_MODIFIABLE_FIELD_PATHS","USER_CUSTOMIZABLE_FIELD_PATHS","context","modifiableFieldPathsByEvent","startRumAssembly","configuration","lifeCycle","sessionManager","userSessionManager","viewContexts","urlContexts","actionContexts","displayContext","buildCommonContext","reportError","RumEventType","VIEW","ERROR","assign","RESOURCE","ACTION","LONG_TASK","eventRateLimiters","createEventRateLimiter","eventRateLimiterThreshold","subscribe","LifeCycleEventType","RAW_RUM_EVENT_COLLECTED","data","startTime","rawRumEvent","savedCommonContext","customerContext","domainContext","viewContext","findView","urlContext","findUrl","session","findTrackedSession","type","undefined","actionId","findActionId","actionIds","findAllActionId","commonContext","rumContext","_gc","sdkName","sdkVersion","drift","currentDrift","session_sample_rate","round","sessionSampleRate","session_replay_sample_rate","sessionReplaySampleRate","terminal","application","id","applicationId","device","deviceInfo","env","service","version","source","date","timeStampNow","user","getId","is_signin","is_login","getSessionType","view","name","url","referrer","host","path","pathGroup","urlQuery","action","needToAssembleWithAction","ids","display","get","rumEvent","extend2Lev","serverRumEvent","withSnakeCaseKeys","isEmptyObject","has_replay","hasReplay","sampled_for_replay","sessionReplayAllowed","shouldSend","beforeSend","notify","RUM_EVENT_COLLECTED","event","result","limitModification","warn","rateLimitReached","isLimitReached","indexOf","window","_DATAFLUX_SYNTHETICS_BROWSER"],"sources":["../../src/domain/assembly.js"],"sourcesContent":["import {\n  extend2Lev,\n  withSnakeCaseKeys,\n  timeStampNow,\n  isEmptyObject,\n  LifeCycleEventType,\n  RumEventType,\n  deviceInfo,\n  currentDrift,\n  createEventRateLimiter,\n  limitModification,\n  display,\n  assign,\n  round\n} from '@cloudcare/browser-core'\nvar SessionType = {\n  SYNTHETICS: 'synthetics',\n  USER: 'user'\n}\n\nvar VIEW_MODIFIABLE_FIELD_PATHS = {\n  'view.url': 'string',\n  'view.referrer': 'string'\n}\n\nvar USER_CUSTOMIZABLE_FIELD_PATHS = {\n  context: 'object'\n}\n\nvar modifiableFieldPathsByEvent = {}\nexport function startRumAssembly(\n  configuration,\n  lifeCycle,\n  sessionManager,\n  userSessionManager,\n  viewContexts,\n  urlContexts,\n  actionContexts,\n  displayContext,\n  buildCommonContext,\n  reportError\n) {\n  modifiableFieldPathsByEvent[RumEventType.VIEW] = VIEW_MODIFIABLE_FIELD_PATHS\n  modifiableFieldPathsByEvent[RumEventType.ERROR] = assign(\n    {\n      'error.message': 'string',\n      'error.stack': 'string',\n      'error.resource.url': 'string'\n    },\n    USER_CUSTOMIZABLE_FIELD_PATHS,\n    VIEW_MODIFIABLE_FIELD_PATHS\n  )\n  modifiableFieldPathsByEvent[RumEventType.RESOURCE] = assign(\n    {\n      'resource.url': 'string'\n    },\n    USER_CUSTOMIZABLE_FIELD_PATHS,\n    VIEW_MODIFIABLE_FIELD_PATHS\n  )\n  modifiableFieldPathsByEvent[RumEventType.ACTION] = assign(\n    {\n      'action.target.name': 'string'\n    },\n    USER_CUSTOMIZABLE_FIELD_PATHS,\n    VIEW_MODIFIABLE_FIELD_PATHS\n  )\n  modifiableFieldPathsByEvent[RumEventType.LONG_TASK] = assign(\n    {},\n    USER_CUSTOMIZABLE_FIELD_PATHS,\n    VIEW_MODIFIABLE_FIELD_PATHS\n  )\n  var eventRateLimiters = {}\n  eventRateLimiters[RumEventType.ERROR] = createEventRateLimiter(\n    RumEventType.ERROR,\n    configuration.eventRateLimiterThreshold,\n    reportError\n  )\n  eventRateLimiters[RumEventType.ACTION] = createEventRateLimiter(\n    RumEventType.ACTION,\n    configuration.eventRateLimiterThreshold,\n    reportError\n  )\n  lifeCycle.subscribe(\n    LifeCycleEventType.RAW_RUM_EVENT_COLLECTED,\n    function (data) {\n      var startTime = data.startTime\n      var rawRumEvent = data.rawRumEvent\n      var savedCommonContext = data.savedCommonContext\n      var customerContext = data.customerContext\n      var domainContext = data.domainContext\n      var viewContext = viewContexts.findView(startTime)\n      var urlContext = urlContexts.findUrl(startTime)\n      var session = sessionManager.findTrackedSession(\n        rawRumEvent.type !== RumEventType.VIEW ? startTime : undefined\n      )\n\n      if (session && viewContext && urlContext) {\n        var actionId = actionContexts.findActionId(startTime)\n        var actionIds = actionContexts.findAllActionId(startTime)\n        var commonContext = savedCommonContext || buildCommonContext()\n        var rumContext = {\n          _gc: {\n            sdkName: configuration.sdkName,\n            sdkVersion: configuration.sdkVersion,\n            drift: currentDrift(),\n            configuration: {\n              session_sample_rate: round(configuration.sessionSampleRate, 3),\n              session_replay_sample_rate: round(\n                configuration.sessionReplaySampleRate,\n                3\n              )\n            }\n          },\n          terminal: {\n            type: 'web'\n          },\n          application: {\n            id: configuration.applicationId\n          },\n          device: deviceInfo,\n          env: configuration.env || '',\n          service: viewContext.service || configuration.service || 'browser',\n          version: viewContext.version || configuration.version || '',\n          source: 'browser',\n          date: timeStampNow(),\n          user: {\n            id: userSessionManager.getId(),\n            is_signin: 'F',\n            is_login: false\n          },\n          session: {\n            // must be computed on each event because synthetics instrumentation can be done after sdk execution\n            // cf https://github.com/puppeteer/puppeteer/issues/3667\n            type: getSessionType(),\n            id: session.id\n          },\n          view: {\n            id: viewContext.id,\n            name: viewContext.name,\n            url: urlContext.url,\n            referrer: urlContext.referrer,\n            host: urlContext.host,\n            path: urlContext.path,\n            pathGroup: urlContext.pathGroup,\n            urlQuery: urlContext.urlQuery\n          },\n          action:\n            needToAssembleWithAction(rawRumEvent) && actionId\n              ? { id: actionId, ids: actionIds }\n              : undefined,\n          display: displayContext.get()\n        }\n\n        var rumEvent = extend2Lev(rumContext, viewContext, rawRumEvent)\n        var serverRumEvent = withSnakeCaseKeys(rumEvent)\n        var context = extend2Lev({}, commonContext.context, customerContext)\n        if (!isEmptyObject(context)) {\n          serverRumEvent.context = context\n        }\n        if (!('has_replay' in serverRumEvent.session)) {\n          serverRumEvent.session.has_replay = commonContext.hasReplay\n        }\n        if (serverRumEvent.type === 'view') {\n          serverRumEvent.session.sampled_for_replay =\n            session.sessionReplayAllowed\n        }\n        if (!isEmptyObject(commonContext.user)) {\n          // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n          serverRumEvent.user = extend2Lev(\n            {\n              // id: session.getAnonymousID(),\n              is_signin: 'T',\n              is_login: true\n            },\n            commonContext.user\n          )\n        }\n\n        if (\n          shouldSend(\n            serverRumEvent,\n            configuration.beforeSend,\n            domainContext,\n            eventRateLimiters\n          )\n        ) {\n          if (isEmptyObject(serverRumEvent.context)) {\n            delete serverRumEvent.context\n          }\n          lifeCycle.notify(\n            LifeCycleEventType.RUM_EVENT_COLLECTED,\n            serverRumEvent\n          )\n        }\n      }\n    }\n  )\n}\n\nfunction shouldSend(event, beforeSend, domainContext, eventRateLimiters) {\n  if (beforeSend) {\n    var result = limitModification(\n      event,\n      modifiableFieldPathsByEvent[event.type],\n      function (event) {\n        return beforeSend(event, domainContext)\n      }\n    )\n    if (result === false && event.type !== RumEventType.VIEW) {\n      return false\n    }\n    if (result === false) {\n      display.warn(\"Can't dismiss view events using beforeSend!\")\n    }\n  }\n  var rateLimitReached = false\n  if (eventRateLimiters[event.type]) {\n    rateLimitReached = eventRateLimiters[event.type].isLimitReached()\n  }\n  return !rateLimitReached\n}\nfunction needToAssembleWithAction(event) {\n  return (\n    [RumEventType.ERROR, RumEventType.RESOURCE, RumEventType.LONG_TASK].indexOf(\n      event.type\n    ) !== -1\n  )\n}\n\nfunction getSessionType() {\n  return window._DATAFLUX_SYNTHETICS_BROWSER === undefined\n    ? SessionType.USER\n    : SessionType.SYNTHETICS\n}\n"],"mappings":"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","ignoreList":[]}