{"version":3,"file":"rumSessionManager.js","names":["_browserCore","require","RUM_SESSION_KEY","exports","RumSessionPlan","WITHOUT_SESSION_REPLAY","WITH_SESSION_REPLAY","RumTrackingType","NOT_TRACKED","TRACKED_WITH_SESSION_REPLAY","TRACKED_WITHOUT_SESSION_REPLAY","startRumSessionManager","configuration","lifeCycle","sessionManager","startSessionManager","cookieOptions","rawTrackingType","computeSessionState","expireObservable","subscribe","notify","LifeCycleEventType","SESSION_EXPIRED","renewObservable","SESSION_RENEWED","findTrackedSession","startTime","session","findActiveSession","isTypeTracked","trackingType","plan","id","sessionReplayAllowed","expire","startRumSessionManagerStub","noop","Observable","hasValidRumSession","performDraw","sessionSampleRate","sessionReplaySampleRate","isTracked","rumSessionType"],"sources":["../../src/domain/rumSessionManager.js"],"sourcesContent":["import {\n  performDraw,\n  startSessionManager,\n  LifeCycleEventType,\n  noop,\n  Observable\n} from '@cloudcare/browser-core'\n\nexport var RUM_SESSION_KEY = 'rum'\n\nexport var RumSessionPlan = {\n  WITHOUT_SESSION_REPLAY: 1,\n  WITH_SESSION_REPLAY: 2\n}\n\nexport var RumTrackingType = {\n  NOT_TRACKED: '0',\n  // Note: the \"tracking type\" value (stored in the session cookie) does not match the \"session\n  // plan\" value (sent in RUM events). This is expected, and was done to keep retrocompatibility\n  // with active sessions when upgrading the SDK.\n  TRACKED_WITH_SESSION_REPLAY: '1',\n  TRACKED_WITHOUT_SESSION_REPLAY: '2'\n}\n\nexport function startRumSessionManager(configuration, lifeCycle) {\n  var sessionManager = startSessionManager(\n    configuration.cookieOptions,\n    RUM_SESSION_KEY,\n    function (rawTrackingType) {\n      return computeSessionState(configuration, rawTrackingType)\n    }\n  )\n\n  sessionManager.expireObservable.subscribe(function () {\n    lifeCycle.notify(LifeCycleEventType.SESSION_EXPIRED)\n  })\n\n  sessionManager.renewObservable.subscribe(function () {\n    lifeCycle.notify(LifeCycleEventType.SESSION_RENEWED)\n  })\n\n  return {\n    findTrackedSession: function (startTime) {\n      var session = sessionManager.findActiveSession(startTime)\n      if (!session || !isTypeTracked(session.trackingType)) {\n        return\n      }\n      var plan =\n        session.trackingType === RumTrackingType.TRACKED_WITH_SESSION_REPLAY\n          ? RumSessionPlan.WITH_SESSION_REPLAY\n          : RumSessionPlan.WITHOUT_SESSION_REPLAY\n      return {\n        id: session.id,\n        plan: plan,\n        sessionReplayAllowed: plan === RumSessionPlan.WITH_SESSION_REPLAY\n      }\n    },\n    expire: sessionManager.expire,\n    expireObservable: sessionManager.expireObservable\n  }\n}\n\n/**\n * Start a tracked replay session stub\n * It needs to be a premium plan in order to get long tasks\n */\nexport function startRumSessionManagerStub() {\n  var session = {\n    id: '00000000-aaaa-0000-aaaa-000000000000',\n    plan: RumSessionPlan.WITHOUT_SESSION_REPLAY, // plan value should not be taken into account for mobile\n    sessionReplayAllowed: false\n  }\n  return {\n    findTrackedSession: function () {\n      return session\n    },\n    expire: noop,\n    expireObservable: new Observable()\n  }\n}\n\nfunction computeSessionState(configuration, rawTrackingType) {\n  var trackingType\n  if (hasValidRumSession(rawTrackingType)) {\n    trackingType = rawTrackingType\n  } else if (!performDraw(configuration.sessionSampleRate)) {\n    trackingType = RumTrackingType.NOT_TRACKED\n  } else if (!performDraw(configuration.sessionReplaySampleRate)) {\n    trackingType = RumTrackingType.TRACKED_WITHOUT_SESSION_REPLAY\n  } else {\n    trackingType = RumTrackingType.TRACKED_WITH_SESSION_REPLAY\n  }\n  return {\n    trackingType: trackingType,\n    isTracked: isTypeTracked(trackingType)\n  }\n}\n\nfunction hasValidRumSession(trackingType) {\n  return (\n    trackingType === RumTrackingType.NOT_TRACKED ||\n    trackingType === RumTrackingType.TRACKED_WITH_SESSION_REPLAY ||\n    trackingType === RumTrackingType.TRACKED_WITHOUT_SESSION_REPLAY\n  )\n}\n\nfunction isTypeTracked(rumSessionType) {\n  return (\n    rumSessionType === RumTrackingType.TRACKED_WITHOUT_SESSION_REPLAY ||\n    rumSessionType === RumTrackingType.TRACKED_WITH_SESSION_REPLAY\n  )\n}\n"],"mappings":"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","ignoreList":[]}