{"version":3,"file":"record.js","names":["_browserCore","require","_initViewportObservable","_types","_serialize","_observers","_viewports","_utils","_elementsScrollPositions","_shadowRootsController","record","options","emit","Error","elementsScrollPositions","createElementsScrollPositions","mutationCb","mutation","assembleIncrementalSnapshot","IncrementalSource","Mutation","inputCb","s","Input","shadowRootsController","initShadowRootsController","configuration","takeFullSnapshot","timestamp","serializationContext","timeStampNow","status","SerializationContextStatus","INITIAL_FULL_SNAPSHOT","_viewportDimension","getViewportDimension","width","height","data","href","window","location","type","RecordType","Meta","has_focus","document","hasFocus","Focus","node","serializeDocument","initialOffset","left","getScrollX","top","getScrollY","FullSnapshot","visualViewport","getVisualViewport","VisualViewport","_initObservers","initObservers","lifeCycle","mediaInteractionCb","p","MediaInteraction","mouseInteractionCb","mouseInteractionRecord","mousemoveCb","positions","source","scrollCb","Scroll","styleSheetCb","r","StyleSheetRule","viewportResizeCb","d","ViewportResize","frustrationCb","frustrationRecord","focusCb","visualViewportResizeCb","stopObservers","stop","flushMutationsFromObservers","flush","flushMutations","takeSubsequentFullSnapshot","SUBSEQUENT_FULL_SNAPSHOT"],"sources":["../../../../src/domain/replay/record/record.js"],"sourcesContent":["import { timeStampNow, getScrollX, getScrollY } from '@cloudcare/browser-core'\nimport { getViewportDimension } from '../../initViewportObservable'\n\nimport { RecordType, IncrementalSource } from '../../../types'\nimport { serializeDocument, SerializationContextStatus } from './serialize'\nimport { initObservers } from './observers'\n\nimport { getVisualViewport } from './viewports'\nimport { assembleIncrementalSnapshot } from './utils'\nimport { createElementsScrollPositions } from './elementsScrollPositions'\nimport { initShadowRootsController } from './shadowRootsController'\n\nexport function record(options) {\n  var emit = options.emit\n  // runtime checks for user options\n  if (!emit) {\n    throw new Error('emit function is required')\n  }\n\n  var elementsScrollPositions = createElementsScrollPositions()\n\n  var mutationCb = function (mutation) {\n    emit(assembleIncrementalSnapshot(IncrementalSource.Mutation, mutation))\n  }\n  var inputCb = function (s) {\n    emit(assembleIncrementalSnapshot(IncrementalSource.Input, s))\n  }\n\n  var shadowRootsController = initShadowRootsController(options.configuration, {\n    mutationCb,\n    inputCb\n  })\n\n  var takeFullSnapshot = function (timestamp, serializationContext) {\n    if (typeof timestamp === 'undefined') {\n      timestamp = timeStampNow()\n    }\n    if (typeof serializationContext === 'undefined') {\n      serializationContext = {\n        status: SerializationContextStatus.INITIAL_FULL_SNAPSHOT,\n        elementsScrollPositions: elementsScrollPositions,\n        shadowRootsController: shadowRootsController\n      }\n    }\n    var _viewportDimension = getViewportDimension()\n    var width = _viewportDimension.width\n    var height = _viewportDimension.height\n    emit({\n      data: {\n        height: height,\n        href: window.location.href,\n        width: width\n      },\n      type: RecordType.Meta,\n      timestamp: timestamp\n    })\n\n    emit({\n      data: {\n        has_focus: document.hasFocus()\n      },\n      type: RecordType.Focus,\n      timestamp: timestamp\n    })\n\n    emit({\n      data: {\n        node: serializeDocument(\n          document,\n          options.configuration,\n          serializationContext\n        ),\n        initialOffset: {\n          left: getScrollX(),\n          top: getScrollY()\n        }\n      },\n      type: RecordType.FullSnapshot,\n      timestamp: timestamp\n    })\n\n    if (window.visualViewport) {\n      emit({\n        data: getVisualViewport(),\n        type: RecordType.VisualViewport,\n        timestamp: timestamp\n      })\n    }\n  }\n\n  takeFullSnapshot()\n  var _initObservers = initObservers({\n    lifeCycle: options.lifeCycle,\n    configuration: options.configuration,\n    elementsScrollPositions: elementsScrollPositions,\n    inputCb: inputCb,\n    mediaInteractionCb: function (p) {\n      emit(assembleIncrementalSnapshot(IncrementalSource.MediaInteraction, p))\n    },\n    mouseInteractionCb: function (mouseInteractionRecord) {\n      emit(mouseInteractionRecord)\n    },\n    mousemoveCb: function (positions, source) {\n      emit(assembleIncrementalSnapshot(source, { positions: positions }))\n    },\n    mutationCb: mutationCb,\n    scrollCb: function (p) {\n      emit(assembleIncrementalSnapshot(IncrementalSource.Scroll, p))\n    },\n    styleSheetCb: function (r) {\n      emit(assembleIncrementalSnapshot(IncrementalSource.StyleSheetRule, r))\n    },\n    viewportResizeCb: function (d) {\n      emit(assembleIncrementalSnapshot(IncrementalSource.ViewportResize, d))\n    },\n    frustrationCb: function (frustrationRecord) {\n      emit(frustrationRecord)\n    },\n    focusCb: function (data) {\n      emit({\n        data: data,\n        type: RecordType.Focus,\n        timestamp: timeStampNow()\n      })\n    },\n    visualViewportResizeCb: function (data) {\n      emit({\n        data: data,\n        type: RecordType.VisualViewport,\n        timestamp: timeStampNow()\n      })\n    },\n    shadowRootsController: shadowRootsController\n  })\n  var stopObservers = _initObservers.stop\n  var flushMutationsFromObservers = _initObservers.flush\n  function flushMutations() {\n    shadowRootsController.flush()\n    flushMutationsFromObservers()\n  }\n\n  return {\n    stop: function () {\n      shadowRootsController.stop()\n      stopObservers()\n    },\n    takeSubsequentFullSnapshot: function (timestamp) {\n      flushMutations()\n      takeFullSnapshot(timestamp, {\n        shadowRootsController: shadowRootsController,\n        status: SerializationContextStatus.SUBSEQUENT_FULL_SNAPSHOT,\n        elementsScrollPositions: elementsScrollPositions\n      })\n    },\n    flushMutations: flushMutations,\n    shadowRootsController: shadowRootsController\n  }\n}\n"],"mappings":"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","ignoreList":[]}