{"version":3,"file":"deflateEncoder.js","names":["_browserCore","require","DeflateEncoderStreamId","REPLAY","exports","createDeflateEncoder","worker","streamId","rawBytesCount","compressedData","compressedDataTrailer","nextWriteActionId","pendingWriteActions","wokerListener","addEventListener","params","data","type","nextPendingAction","shift","id","additionalBytesCount","result","push","trailer","callback","removeMessageListener","addTelemetryDebug","stop","getEncodedBytes","length","Uint8Array","concatBuffers","concat","getEncodedBytesCount","reduce","total","buffer","getRawBytesCount","write","postMessage","action","reset"],"sources":["../../../../src/domain/replay/deflate/deflateEncoder.js"],"sourcesContent":["import {\n  addEventListener,\n  concatBuffers,\n  addTelemetryDebug\n} from '@cloudcare/browser-core'\nexport var DeflateEncoderStreamId = {\n  REPLAY: 1\n}\nexport function createDeflateEncoder(worker, streamId) {\n  var rawBytesCount = 0\n  var compressedData = []\n  var compressedDataTrailer\n\n  var nextWriteActionId = 0\n  var pendingWriteActions = []\n\n  var wokerListener = addEventListener(worker, 'message', function (params) {\n    var data = params.data\n    if (data.type !== 'wrote' || data.streamId !== streamId) {\n      return\n    }\n\n    var nextPendingAction = pendingWriteActions.shift()\n    if (nextPendingAction && nextPendingAction.id === data.id) {\n      if (data.id === 0) {\n        // Initial state\n        rawBytesCount = data.additionalBytesCount\n        compressedData = [data.result]\n      } else {\n        rawBytesCount += data.additionalBytesCount\n        compressedData.push(data.result)\n      }\n      compressedDataTrailer = data.trailer\n      nextPendingAction.callback()\n    } else {\n      removeMessageListener()\n      addTelemetryDebug('Worker responses received out of order.')\n    }\n  })\n  var removeMessageListener = wokerListener.stop\n  return {\n    getEncodedBytes: function () {\n      if (!compressedData.length) {\n        return new Uint8Array(0)\n      }\n\n      return concatBuffers(compressedData.concat(compressedDataTrailer))\n    },\n\n    getEncodedBytesCount: function () {\n      if (!compressedData.length) {\n        return 0\n      }\n\n      return (\n        compressedData.reduce(function (total, buffer) {\n          return total + buffer.length\n        }, 0) + compressedDataTrailer.length\n      )\n    },\n\n    getRawBytesCount: function () {\n      return rawBytesCount\n    },\n\n    write: function (data, callback) {\n      worker.postMessage({\n        action: 'write',\n        id: nextWriteActionId,\n        data: data,\n        streamId: streamId\n      })\n      pendingWriteActions.push({\n        id: nextWriteActionId,\n        callback: callback\n      })\n      nextWriteActionId += 1\n    },\n\n    reset: function () {\n      worker.postMessage({\n        action: 'reset',\n        streamId: streamId\n      })\n      nextWriteActionId = 0\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}