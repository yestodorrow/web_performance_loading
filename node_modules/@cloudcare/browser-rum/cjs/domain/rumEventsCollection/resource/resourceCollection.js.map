{"version":3,"file":"resourceCollection.js","names":["_browserCore","require","_matchRequestTiming","_resourceUtils","_pageStateHistory","startResourceCollection","lifeCycle","configuration","sessionManager","pageStateHistory","subscribe","LifeCycleEventType","REQUEST_COMPLETED","request","rawEvent","processRequest","notify","RAW_RUM_EVENT_COLLECTED","PERFORMANCE_ENTRIES_COLLECTED","entries","i","length","entry","entryType","isRequestKind","isResourceUrlLimit","name","resourceUrlLimit","processResourceEntry","matchingTiming","matchRequestTiming","startClocks","relativeToClocks","startTime","shouldIndex","shouldIndexResource","tracingInfo","computeRequestTracingInfo","type","RequestType","XHR","ResourceType","FETCH","correspondingTimingOverrides","computePerformanceEntryMetrics","undefined","duration","computeRequestDuration","pageStateInfo","computePageStateInfo","isNullUndefinedDefaultValue","urlObj","urlParse","url","getParse","resourceEvent","extend2Lev","date","timeStamp","resource","id","UUID","method","status","statusGroup","getStatusGroup","isLongDataUrl","sanitizeDataUrl","urlHost","Host","urlPath","Path","urlPathGroup","replaceNumberCharByPath","urlQuery","getQueryParamsFromUrl","RumEventType","RESOURCE","relative","rawRumEvent","domainContext","performanceEntry","xhr","response","requestInput","input","requestInit","init","error","computeEntryTracingInfo","computeResourceKind","entryMetrics","statusCode","responseStatus","is304","isCacheHit","resourceStart","findTrackedSession","timing","computePerformanceResourceDuration","computeSize","computePerformanceResourceDetails","hasBeenTraced","traceSampled","traceId","spanId","_gc","page_states","findAll","page_was_discarded","String","document","wasDiscarded","requestCrosseds","requestCrossedFrozenState","some","pageState","state","PageState","FROZEN","toServerDuration"],"sources":["../../../../src/domain/rumEventsCollection/resource/resourceCollection.js"],"sourcesContent":["import {\n  getStatusGroup,\n  UUID,\n  extend2Lev,\n  relativeToClocks,\n  urlParse,\n  getQueryParamsFromUrl,\n  replaceNumberCharByPath,\n  RequestType,\n  ResourceType,\n  RumEventType,\n  LifeCycleEventType,\n  toServerDuration,\n  some,\n  isNullUndefinedDefaultValue\n} from '@cloudcare/browser-core'\nimport { matchRequestTiming } from './matchRequestTiming'\nimport {\n  computePerformanceResourceDetails,\n  computePerformanceResourceDuration,\n  computeResourceKind,\n  computeSize,\n  isRequestKind,\n  is304,\n  isCacheHit,\n  isResourceUrlLimit,\n  isLongDataUrl,\n  sanitizeDataUrl\n} from './resourceUtils'\nimport { PageState } from '../../contexts/pageStateHistory.js'\nexport function startResourceCollection(\n  lifeCycle,\n  configuration,\n  sessionManager,\n  pageStateHistory\n) {\n  lifeCycle.subscribe(LifeCycleEventType.REQUEST_COMPLETED, function (request) {\n    var rawEvent = processRequest(\n      request,\n      configuration,\n      sessionManager,\n      pageStateHistory\n    )\n    if (rawEvent) {\n      lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, rawEvent)\n    }\n  })\n\n  lifeCycle.subscribe(\n    LifeCycleEventType.PERFORMANCE_ENTRIES_COLLECTED,\n    function (entries) {\n      for (var i = 0; i < entries.length; i++) {\n        var entry = entries[i]\n        if (\n          entry.entryType === 'resource' &&\n          !isRequestKind(entry) &&\n          !isResourceUrlLimit(entry.name, configuration.resourceUrlLimit)\n        ) {\n          var rawEvent = processResourceEntry(\n            entry,\n            configuration,\n            sessionManager,\n            pageStateHistory\n          )\n          if (rawEvent) {\n            lifeCycle.notify(\n              LifeCycleEventType.RAW_RUM_EVENT_COLLECTED,\n              rawEvent\n            )\n          }\n        }\n      }\n    }\n  )\n}\n\nfunction processRequest(\n  request,\n  configuration,\n  sessionManager,\n  pageStateHistory\n) {\n  var matchingTiming = matchRequestTiming(request)\n  var startClocks = matchingTiming\n    ? relativeToClocks(matchingTiming.startTime)\n    : request.startClocks\n  var shouldIndex = shouldIndexResource(\n    configuration,\n    sessionManager,\n    startClocks\n  )\n  var tracingInfo = computeRequestTracingInfo(request)\n  if (!shouldIndex && !tracingInfo) {\n    return\n  }\n  var type =\n    request.type === RequestType.XHR ? ResourceType.XHR : ResourceType.FETCH\n  var correspondingTimingOverrides = matchingTiming\n    ? computePerformanceEntryMetrics(matchingTiming)\n    : undefined\n\n  var duration = computeRequestDuration(\n    pageStateHistory,\n    startClocks,\n    request.duration\n  )\n  var pageStateInfo = computePageStateInfo(\n    pageStateHistory,\n    startClocks,\n    isNullUndefinedDefaultValue(\n      matchingTiming && matchingTiming.duration,\n      request.duration\n    )\n  )\n  var urlObj = urlParse(request.url).getParse()\n  var resourceEvent = extend2Lev(\n    {\n      date: startClocks.timeStamp,\n      resource: {\n        id: UUID,\n        type: type,\n        duration: duration,\n        method: request.method,\n        status: request.status,\n        statusGroup: getStatusGroup(request.status),\n        url: isLongDataUrl(request.url)\n          ? sanitizeDataUrl(request.url)\n          : request.url,\n        urlHost: urlObj.Host,\n        urlPath: urlObj.Path,\n        urlPathGroup: replaceNumberCharByPath(urlObj.Path),\n        urlQuery: getQueryParamsFromUrl(request.url)\n      },\n      type: RumEventType.RESOURCE\n    },\n    tracingInfo,\n    correspondingTimingOverrides,\n    pageStateInfo\n  )\n  return {\n    startTime: startClocks.relative,\n    rawRumEvent: resourceEvent,\n    domainContext: {\n      performanceEntry: matchingTiming,\n      xhr: request.xhr,\n      response: request.response,\n      requestInput: request.input,\n      requestInit: request.init,\n      error: request.error\n    }\n  }\n}\n\nfunction processResourceEntry(\n  entry,\n  configuration,\n  sessionManager,\n  pageStateHistory\n) {\n  var startClocks = relativeToClocks(entry.startTime)\n  var shouldIndex = shouldIndexResource(\n    configuration,\n    sessionManager,\n    startClocks\n  )\n  var tracingInfo = computeEntryTracingInfo(entry)\n  if (!shouldIndex && !tracingInfo) {\n    return\n  }\n  var type = computeResourceKind(entry)\n  var entryMetrics = computePerformanceEntryMetrics(entry)\n  var urlObj = urlParse(entry.name).getParse()\n  var statusCode = ''\n  if (entry.responseStatus !== 0) {\n    statusCode = entry.responseStatus\n  } else if (is304(entry)) {\n    statusCode = 304\n  } else if (isCacheHit(entry)) {\n    statusCode = 200\n  }\n  var pageStateInfo = computePageStateInfo(\n    pageStateHistory,\n    startClocks,\n    entry.duration\n  )\n\n  var resourceEvent = extend2Lev(\n    {\n      date: startClocks.timeStamp,\n      resource: {\n        id: UUID(),\n        type: type,\n        url: entry.name,\n        urlHost: urlObj.Host,\n        urlPath: urlObj.Path,\n        urlPathGroup: replaceNumberCharByPath(urlObj.Path),\n        urlQuery: getQueryParamsFromUrl(entry.name),\n        method: 'GET',\n        status: statusCode,\n        statusGroup: getStatusGroup(statusCode)\n      },\n      type: RumEventType.RESOURCE\n    },\n    tracingInfo,\n    entryMetrics,\n    pageStateInfo\n  )\n  return {\n    startTime: startClocks.relative,\n    rawRumEvent: resourceEvent,\n    domainContext: {\n      performanceEntry: entry\n    }\n  }\n}\nfunction shouldIndexResource(configuration, sessionManager, resourceStart) {\n  return sessionManager.findTrackedSession(resourceStart.relative)\n}\n\nfunction computePerformanceEntryMetrics(timing) {\n  return {\n    resource: extend2Lev(\n      {},\n      {\n        duration: computePerformanceResourceDuration(timing)\n      },\n      computeSize(timing),\n      computePerformanceResourceDetails(timing)\n    )\n  }\n}\n\nfunction computeRequestTracingInfo(request) {\n  var hasBeenTraced = request.traceSampled && request.traceId && request.spanId\n  if (!hasBeenTraced) {\n    return undefined\n  }\n  return {\n    _gc: {\n      spanId: request.spanId,\n      traceId: request.traceId\n    },\n    resource: { id: UUID() }\n  }\n}\nfunction computePageStateInfo(pageStateHistory, startClocks, duration) {\n  return {\n    _gc: {\n      page_states: pageStateHistory.findAll(startClocks.relative, duration),\n      page_was_discarded: String(document.wasDiscarded)\n    }\n  }\n}\nfunction computeRequestDuration(pageStateHistory, startClocks, duration) {\n  const requestCrosseds = pageStateHistory.findAll(\n    startClocks.relative,\n    duration\n  )\n  var requestCrossedFrozenState\n  if (requestCrosseds) {\n    requestCrossedFrozenState = some(requestCrosseds, function (pageState) {\n      return pageState.state === PageState.FROZEN\n    })\n  }\n  return !requestCrossedFrozenState ? toServerDuration(duration) : undefined\n}\nfunction computeEntryTracingInfo(entry) {\n  return entry.traceId ? { _gc: { traceId: entry.traceId } } : undefined\n}\n"],"mappings":"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","ignoreList":[]}