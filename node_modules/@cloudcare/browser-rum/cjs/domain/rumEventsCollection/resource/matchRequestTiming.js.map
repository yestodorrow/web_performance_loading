{"version":3,"file":"matchRequestTiming.js","names":["_resourceUtils","require","_browserCore","matchRequestTiming","request","performance","sameNameEntries","getEntriesByName","url","length","candidates","map","entry","toJSON","filter","toValidEntry","isBetween","startClocks","relative","endTime","startTime","duration","timing","addDuration","start","end","errorMargin"],"sources":["../../../../src/domain/rumEventsCollection/resource/matchRequestTiming.js"],"sourcesContent":["import { toValidEntry } from './resourceUtils'\nimport { map, filter, addDuration } from '@cloudcare/browser-core'\n\n/**\n * Look for corresponding timing in resource timing buffer\n *\n * Observations:\n * - Timing (start, end) are nested inside the request (start, end)\n * - Browsers generate a timing entry for OPTIONS request\n *\n * Strategy:\n * - from valid nested entries\n * - if a single timing match, return the timing\n * - if two following timings match (OPTIONS request), return the timing for the actual request\n * - otherwise we can't decide, return undefined\n */\nexport function matchRequestTiming(request) {\n  if (!performance || !('getEntriesByName' in performance)) {\n    return\n  }\n  var sameNameEntries = performance.getEntriesByName(request.url, 'resource')\n\n  if (!sameNameEntries.length || !('toJSON' in sameNameEntries[0])) {\n    return\n  }\n  var candidates = map(sameNameEntries, function (entry) {\n    return entry.toJSON()\n  })\n\n  candidates = filter(candidates, toValidEntry)\n  candidates = filter(candidates, function (entry) {\n    return isBetween(\n      entry,\n      request.startClocks.relative,\n      endTime({\n        startTime: request.startClocks.relative,\n        duration: request.duration\n      })\n    )\n  })\n\n  if (candidates.length === 1) {\n    return candidates[0]\n  }\n  return\n}\n\nfunction endTime(timing) {\n  return addDuration(timing.startTime, timing.duration)\n}\n\nfunction isBetween(timing, start, end) {\n  // eslint-disable-next-line @typescript-eslint/restrict-plus-operands\n  var errorMargin = 1\n  return (\n    timing.startTime >= start - errorMargin &&\n    endTime(timing) <= addDuration(end, errorMargin)\n  )\n}\n"],"mappings":";;;;;;AAAA,IAAAA,cAAA,GAAAC,OAAA;AACA,IAAAC,YAAA,GAAAD,OAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASE,kBAAkBA,CAACC,OAAO,EAAE;EAC1C,IAAI,CAACC,WAAW,IAAI,EAAE,kBAAkB,IAAIA,WAAW,CAAC,EAAE;IACxD;EACF;EACA,IAAIC,eAAe,GAAGD,WAAW,CAACE,gBAAgB,CAACH,OAAO,CAACI,GAAG,EAAE,UAAU,CAAC;EAE3E,IAAI,CAACF,eAAe,CAACG,MAAM,IAAI,EAAE,QAAQ,IAAIH,eAAe,CAAC,CAAC,CAAC,CAAC,EAAE;IAChE;EACF;EACA,IAAII,UAAU,GAAG,IAAAC,gBAAG,EAACL,eAAe,EAAE,UAAUM,KAAK,EAAE;IACrD,OAAOA,KAAK,CAACC,MAAM,CAAC,CAAC;EACvB,CAAC,CAAC;EAEFH,UAAU,GAAG,IAAAI,mBAAM,EAACJ,UAAU,EAAEK,2BAAY,CAAC;EAC7CL,UAAU,GAAG,IAAAI,mBAAM,EAACJ,UAAU,EAAE,UAAUE,KAAK,EAAE;IAC/C,OAAOI,SAAS,CACdJ,KAAK,EACLR,OAAO,CAACa,WAAW,CAACC,QAAQ,EAC5BC,OAAO,CAAC;MACNC,SAAS,EAAEhB,OAAO,CAACa,WAAW,CAACC,QAAQ;MACvCG,QAAQ,EAAEjB,OAAO,CAACiB;IACpB,CAAC,CACH,CAAC;EACH,CAAC,CAAC;EAEF,IAAIX,UAAU,CAACD,MAAM,KAAK,CAAC,EAAE;IAC3B,OAAOC,UAAU,CAAC,CAAC,CAAC;EACtB;EACA;AACF;AAEA,SAASS,OAAOA,CAACG,MAAM,EAAE;EACvB,OAAO,IAAAC,wBAAW,EAACD,MAAM,CAACF,SAAS,EAAEE,MAAM,CAACD,QAAQ,CAAC;AACvD;AAEA,SAASL,SAASA,CAACM,MAAM,EAAEE,KAAK,EAAEC,GAAG,EAAE;EACrC;EACA,IAAIC,WAAW,GAAG,CAAC;EACnB,OACEJ,MAAM,CAACF,SAAS,IAAII,KAAK,GAAGE,WAAW,IACvCP,OAAO,CAACG,MAAM,CAAC,IAAI,IAAAC,wBAAW,EAACE,GAAG,EAAEC,WAAW,CAAC;AAEpD","ignoreList":[]}