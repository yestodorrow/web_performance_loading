{"version":3,"file":"getSelectorsFromElement.js","names":["_browserCore","require","_getActionNameFromElement","STABLE_ATTRIBUTES","DEFAULT_PROGRAMMATIC_ACTION_NAME_ATTRIBUTE","exports","GLOBALLY_UNIQUE_SELECTOR_GETTERS","getStableAttributeSelector","getIDSelector","UNIQUE_AMONG_CHILDREN_SELECTOR_GETTERS","getClassSelector","getTagNameSelector","getSelectorFromElement","targetElement","actionNameAttribute","targetElementSelector","element","nodeName","globallyUniqueSelector","findSelector","isSelectorUniqueGlobally","uniqueSelectorAmongChildren","isSelectorUniqueAmongSiblings","combineSelector","getPositionSelector","parentElement","isGeneratedValue","value","test","id","cssEscape","tagName","classList","length","i","className","selector","getAttributeSelector","attributeName","hasAttribute","getAttribute","sibling","firstElementChild","elementIndex","nextElementSibling","selectorGetters","predicate","childSelector","selectorGetter","elementSelector","fullSelector","ownerDocument","body","querySelectorAll","supportScopeSelector","parent","child","supportScopeSelectorCache","undefined","document","querySelector","_unused"],"sources":["../../../../src/domain/rumEventsCollection/actions/getSelectorsFromElement.js"],"sourcesContent":["import { cssEscape } from '@cloudcare/browser-core'\nimport { DEFAULT_PROGRAMMATIC_ACTION_NAME_ATTRIBUTE } from './getActionNameFromElement'\n/**\n * Stable attributes are attributes that are commonly used to identify parts of a UI (ex:\n * component). Those attribute values should not be generated randomly (hardcoded most of the time)\n * and stay the same across deploys. They are not necessarily unique across the document.\n */\nexport var STABLE_ATTRIBUTES = [\n  DEFAULT_PROGRAMMATIC_ACTION_NAME_ATTRIBUTE,\n  // Common test attributes (list provided by google recorder)\n  'data-testid',\n  'data-test',\n  'data-qa',\n  'data-cy',\n  'data-test-id',\n  'data-qa-id',\n  'data-testing',\n  // FullStory decorator attributes:\n  'data-component',\n  'data-element',\n  'data-source-file'\n]\n// Selectors to use if they target a single element on the whole document. Those selectors are\n// considered as \"stable\" and uniquely identify an element regardless of the page state. If we find\n// one, we should consider the selector \"complete\" and stop iterating over ancestors.\nvar GLOBALLY_UNIQUE_SELECTOR_GETTERS = [\n  getStableAttributeSelector,\n  getIDSelector\n]\n\n// Selectors to use if they target a single element among an element descendants. Those selectors\n// are more brittle than \"globally unique\" selectors and should be combined with ancestor selectors\n// to improve specificity.\nvar UNIQUE_AMONG_CHILDREN_SELECTOR_GETTERS = [\n  getStableAttributeSelector,\n  getClassSelector,\n  getTagNameSelector\n]\n\nexport function getSelectorFromElement(targetElement, actionNameAttribute) {\n  var targetElementSelector = ''\n  var element = targetElement\n\n  while (element && element.nodeName !== 'HTML') {\n    var globallyUniqueSelector = findSelector(\n      element,\n      GLOBALLY_UNIQUE_SELECTOR_GETTERS,\n      isSelectorUniqueGlobally,\n      actionNameAttribute,\n      targetElementSelector\n    )\n    if (globallyUniqueSelector) {\n      return globallyUniqueSelector\n    }\n\n    var uniqueSelectorAmongChildren = findSelector(\n      element,\n      UNIQUE_AMONG_CHILDREN_SELECTOR_GETTERS,\n      isSelectorUniqueAmongSiblings,\n      actionNameAttribute,\n      targetElementSelector\n    )\n    targetElementSelector =\n      uniqueSelectorAmongChildren ||\n      combineSelector(getPositionSelector(element), targetElementSelector)\n\n    element = element.parentElement\n  }\n\n  return targetElementSelector\n}\nfunction isGeneratedValue(value) {\n  // To compute the \"URL path group\", the backend replaces every URL path parts as a question mark\n  // if it thinks the part is an identifier. The condition it uses is to checks whether a digit is\n  // present.\n  //\n  // Here, we use the same strategy: if a the value contains a digit, we consider it generated. This\n  // strategy might be a bit naive and fail in some cases, but there are many fallbacks to generate\n  // CSS selectors so it should be fine most of the time. We might want to allow customers to\n  // provide their own `isGeneratedValue` at some point.\n  return /[0-9]/.test(value)\n}\nfunction getIDSelector(element) {\n  if (element.id && !isGeneratedValue(element.id)) {\n    return '#' + cssEscape(element.id)\n  }\n}\n\nfunction getClassSelector(element) {\n  if (element.tagName === 'BODY') {\n    return\n  }\n  if (element.classList.length > 0) {\n    for (var i = 0; i < element.classList.length; i += 1) {\n      var className = element.classList[i]\n      if (isGeneratedValue(className)) {\n        continue\n      }\n\n      return cssEscape(element.tagName) + '.' + cssEscape(className)\n    }\n  }\n}\nfunction getTagNameSelector(element) {\n  return cssEscape(element.tagName)\n}\nfunction getStableAttributeSelector(element, actionNameAttribute) {\n  if (actionNameAttribute) {\n    var selector = getAttributeSelector(actionNameAttribute)\n    if (selector) {\n      return selector\n    }\n  }\n\n  for (var i = 0; i < STABLE_ATTRIBUTES.length; i++) {\n    var attributeName = STABLE_ATTRIBUTES[i]\n    var selector = getAttributeSelector(attributeName)\n    if (selector) {\n      return selector\n    }\n  }\n\n  function getAttributeSelector(attributeName) {\n    if (element.hasAttribute(attributeName)) {\n      return (\n        cssEscape(element.tagName) +\n        '[' +\n        attributeName +\n        '=\"' +\n        cssEscape(element.getAttribute(attributeName)) +\n        '\"]'\n      )\n    }\n  }\n}\n\nfunction getPositionSelector(element) {\n  var sibling = element.parentElement && element.parentElement.firstElementChild\n  var elementIndex = 1\n\n  while (sibling && sibling !== element) {\n    if (sibling.tagName === element.tagName) {\n      elementIndex += 1\n    }\n    sibling = sibling.nextElementSibling\n  }\n  var tagName = cssEscape(element.tagName)\n  // 伪元素需要做特殊处理，没有nth-of-type选择器\n  if (/^::/.test(tagName)) {\n    return tagName\n  }\n  return tagName + ':nth-of-type(' + elementIndex + ')'\n}\n\nfunction findSelector(\n  element,\n  selectorGetters,\n  predicate,\n  actionNameAttribute,\n  childSelector\n) {\n  for (var i = 0; i < selectorGetters.length; i++) {\n    var selectorGetter = selectorGetters[i]\n    var elementSelector = selectorGetter(element, actionNameAttribute)\n    if (!elementSelector) {\n      continue\n    }\n    var fullSelector = combineSelector(elementSelector, childSelector)\n    if (predicate(element, fullSelector)) {\n      return fullSelector\n    }\n  }\n}\n\nfunction isSelectorUniqueGlobally(element, selector) {\n  return element.ownerDocument.body.querySelectorAll(selector).length === 1\n}\n/**\n * Check whether the selector is unique among the element siblings. In other words, it returns true\n * if \"ELEMENT_PARENT > SELECTOR\" returns a single element.\n *\n * The result will be less accurate on browsers that don't support :scope (i. e. IE): it will check\n * for any element matching the selector contained in the parent (in other words,\n * \"ELEMENT_PARENT SELECTOR\" returns a single element), regardless of whether the selector is a\n * direct descendent of the element parent. This should not impact results too much: if it\n * inaccurately returns false, we'll just fall back to another strategy.\n */\nfunction isSelectorUniqueAmongSiblings(element, selector) {\n  return (\n    element.parentElement.querySelectorAll(\n      supportScopeSelector() ? combineSelector(':scope', selector) : selector\n    ).length === 1\n  )\n}\nfunction combineSelector(parent, child) {\n  return child ? parent + '>' + child : parent\n}\nvar supportScopeSelectorCache\nexport function supportScopeSelector() {\n  if (supportScopeSelectorCache === undefined) {\n    try {\n      document.querySelector(':scope')\n      supportScopeSelectorCache = true\n    } catch {\n      supportScopeSelectorCache = false\n    }\n  }\n  return supportScopeSelectorCache\n}\n"],"mappings":"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","ignoreList":[]}