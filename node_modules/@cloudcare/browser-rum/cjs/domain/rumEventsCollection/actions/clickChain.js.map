{"version":3,"file":"clickChain.js","names":["_browserCore","require","MAX_DURATION_BETWEEN_CLICKS","ONE_SECOND","exports","MAX_DISTANCE_BETWEEN_CLICKS","ClickChainStatus","WaitingForMoreClicks","WaitingForClicksToStop","Finalized","createClickChain","firstClick","onFinalize","bufferedClicks","status","maxDurationBetweenClicksTimeout","appendClick","click","stopObservable","subscribe","tryFinalize","push","clearTimeout","setTimeout","dontAcceptMoreClick","every","isStopped","tryAppend","length","areEventsSimilar","event","stop","first","second","target","mouseEventDistance","timeStamp","origin","other","Math","sqrt","pow","clientX","clientY"],"sources":["../../../../src/domain/rumEventsCollection/actions/clickChain.js"],"sourcesContent":["import {\n  ONE_SECOND,\n  every,\n  setTimeout,\n  clearTimeout\n} from '@cloudcare/browser-core'\n\nexport var MAX_DURATION_BETWEEN_CLICKS = ONE_SECOND\nexport var MAX_DISTANCE_BETWEEN_CLICKS = 100\n\nvar ClickChainStatus = {\n  WaitingForMoreClicks: 0,\n  WaitingForClicksToStop: 1,\n  Finalized: 2\n}\n\nexport function createClickChain(firstClick, onFinalize) {\n  var bufferedClicks = []\n  var status = ClickChainStatus.WaitingForMoreClicks\n  var maxDurationBetweenClicksTimeout\n  appendClick(firstClick)\n\n  function appendClick(click) {\n    click.stopObservable.subscribe(tryFinalize)\n    bufferedClicks.push(click)\n    clearTimeout(maxDurationBetweenClicksTimeout)\n    maxDurationBetweenClicksTimeout = setTimeout(\n      dontAcceptMoreClick,\n      MAX_DURATION_BETWEEN_CLICKS\n    )\n  }\n\n  function tryFinalize() {\n    if (\n      status === ClickChainStatus.WaitingForClicksToStop &&\n      every(bufferedClicks, function (click) {\n        return click.isStopped()\n      })\n    ) {\n      status = ClickChainStatus.Finalized\n      onFinalize(bufferedClicks)\n    }\n  }\n\n  function dontAcceptMoreClick() {\n    clearTimeout(maxDurationBetweenClicksTimeout)\n    if (status === ClickChainStatus.WaitingForMoreClicks) {\n      status = ClickChainStatus.WaitingForClicksToStop\n      tryFinalize()\n    }\n  }\n\n  return {\n    tryAppend: function (click) {\n      if (status !== ClickChainStatus.WaitingForMoreClicks) {\n        return false\n      }\n\n      if (\n        bufferedClicks.length > 0 &&\n        !areEventsSimilar(\n          bufferedClicks[bufferedClicks.length - 1].event,\n          click.event\n        )\n      ) {\n        dontAcceptMoreClick()\n        return false\n      }\n\n      appendClick(click)\n      return true\n    },\n    stop: function () {\n      dontAcceptMoreClick()\n    }\n  }\n}\n\n/**\n * Checks whether two events are similar by comparing their target, position and timestamp\n */\nfunction areEventsSimilar(first, second) {\n  return (\n    first.target === second.target &&\n    mouseEventDistance(first, second) <= MAX_DISTANCE_BETWEEN_CLICKS &&\n    first.timeStamp - second.timeStamp <= MAX_DURATION_BETWEEN_CLICKS\n  )\n}\n\nfunction mouseEventDistance(origin, other) {\n  return Math.sqrt(\n    Math.pow(origin.clientX - other.clientX, 2) +\n      Math.pow(origin.clientY - other.clientY, 2)\n  )\n}\n"],"mappings":"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","ignoreList":[]}