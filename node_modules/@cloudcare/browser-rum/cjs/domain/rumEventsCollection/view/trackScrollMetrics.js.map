{"version":3,"file":"trackScrollMetrics.js","names":["_browserCore","require","_initViewportObservable","THROTTLE_SCROLL_DURATION","ONE_SECOND","exports","trackScrollMetrics","configuration","viewStart","callback","scrollValues","undefined","createScrollValuesObservable","maxScrollDepth","maxScrollHeight","maxScrollHeightTime","subscription","subscribe","data","scrollDepth","scrollTop","scrollHeight","shouldUpdate","now","relativeNow","elapsed","relative","maxDepth","Math","min","maxDepthScrollTop","stop","unsubscribe","computeScrollValues","getScrollY","viewport","getViewportDimension","height","round","document","scrollingElement","documentElement","throttleDuration","Observable","observable","notify","window","ResizeObserver","throttledNotify","throttle","leading","trailing","observerTarget","resizeObserver","monitor","throttled","observe","eventListener","addEventListener","DOM_EVENT","SCROLL","passive","cancel","unobserve"],"sources":["../../../../src/domain/rumEventsCollection/view/trackScrollMetrics.js"],"sourcesContent":["import {\n  ONE_SECOND,\n  elapsed,\n  relativeNow,\n  throttle,\n  addEventListener,\n  DOM_EVENT,\n  getScrollY,\n  monitor,\n  Observable\n} from '@cloudcare/browser-core'\nimport { getViewportDimension } from '../../initViewportObservable'\n\n/** Arbitrary scroll throttle duration */\nexport var THROTTLE_SCROLL_DURATION = ONE_SECOND\n\nexport function trackScrollMetrics(\n  configuration,\n  viewStart,\n  callback,\n  scrollValues\n) {\n  if (scrollValues === undefined) {\n    scrollValues = createScrollValuesObservable(configuration)\n  }\n  var maxScrollDepth = 0\n  var maxScrollHeight = 0\n  var maxScrollHeightTime = 0\n  var subscription = scrollValues.subscribe(function (data) {\n    var scrollDepth = data.scrollDepth\n    var scrollTop = data.scrollTop\n    var scrollHeight = data.scrollHeight\n    var shouldUpdate = false\n\n    if (scrollDepth > maxScrollDepth) {\n      maxScrollDepth = scrollDepth\n      shouldUpdate = true\n    }\n\n    if (scrollHeight > maxScrollHeight) {\n      maxScrollHeight = scrollHeight\n      var now = relativeNow()\n      maxScrollHeightTime = elapsed(viewStart.relative, now)\n      shouldUpdate = true\n    }\n\n    if (shouldUpdate) {\n      callback({\n        maxDepth: Math.min(maxScrollDepth, maxScrollHeight),\n        maxDepthScrollTop: scrollTop,\n        maxScrollHeight: maxScrollHeight,\n        maxScrollHeightTime: maxScrollHeightTime\n      })\n    }\n  })\n\n  return {\n    stop: function () {\n      return subscription.unsubscribe()\n    }\n  }\n}\n\nexport function computeScrollValues() {\n  var scrollTop = getScrollY()\n\n  var viewport = getViewportDimension()\n  var height = viewport.height\n  var scrollHeight = Math.round(\n    (document.scrollingElement || document.documentElement).scrollHeight\n  )\n  var scrollDepth = Math.round(height + scrollTop)\n\n  return {\n    scrollHeight: scrollHeight,\n    scrollDepth: scrollDepth,\n    scrollTop: scrollTop\n  }\n}\nexport function createScrollValuesObservable(configuration, throttleDuration) {\n  if (throttleDuration === undefined) {\n    throttleDuration = THROTTLE_SCROLL_DURATION\n  }\n  return new Observable(function (observable) {\n    function notify() {\n      observable.notify(computeScrollValues())\n    }\n\n    if (window.ResizeObserver) {\n      var throttledNotify = throttle(notify, throttleDuration, {\n        leading: false,\n        trailing: true\n      })\n\n      var observerTarget = document.scrollingElement || document.documentElement\n      var resizeObserver = new ResizeObserver(\n        monitor(throttledNotify.throttled)\n      )\n      resizeObserver.observe(observerTarget)\n      var eventListener = addEventListener(\n        window,\n        DOM_EVENT.SCROLL,\n        throttledNotify.throttled,\n        {\n          passive: true\n        }\n      )\n\n      return function () {\n        throttledNotify.cancel()\n        resizeObserver.unobserve(observerTarget)\n        eventListener.stop()\n      }\n    }\n  })\n}\n"],"mappings":";;;;;;;;;AAAA,IAAAA,YAAA,GAAAC,OAAA;AAWA,IAAAC,uBAAA,GAAAD,OAAA;AAEA;AACO,IAAIE,wBAAwB,GAAGC,uBAAU;AAAAC,OAAA,CAAAF,wBAAA,GAAAA,wBAAA;AAEzC,SAASG,kBAAkBA,CAChCC,aAAa,EACbC,SAAS,EACTC,QAAQ,EACRC,YAAY,EACZ;EACA,IAAIA,YAAY,KAAKC,SAAS,EAAE;IAC9BD,YAAY,GAAGE,4BAA4B,CAACL,aAAa,CAAC;EAC5D;EACA,IAAIM,cAAc,GAAG,CAAC;EACtB,IAAIC,eAAe,GAAG,CAAC;EACvB,IAAIC,mBAAmB,GAAG,CAAC;EAC3B,IAAIC,YAAY,GAAGN,YAAY,CAACO,SAAS,CAAC,UAAUC,IAAI,EAAE;IACxD,IAAIC,WAAW,GAAGD,IAAI,CAACC,WAAW;IAClC,IAAIC,SAAS,GAAGF,IAAI,CAACE,SAAS;IAC9B,IAAIC,YAAY,GAAGH,IAAI,CAACG,YAAY;IACpC,IAAIC,YAAY,GAAG,KAAK;IAExB,IAAIH,WAAW,GAAGN,cAAc,EAAE;MAChCA,cAAc,GAAGM,WAAW;MAC5BG,YAAY,GAAG,IAAI;IACrB;IAEA,IAAID,YAAY,GAAGP,eAAe,EAAE;MAClCA,eAAe,GAAGO,YAAY;MAC9B,IAAIE,GAAG,GAAG,IAAAC,wBAAW,EAAC,CAAC;MACvBT,mBAAmB,GAAG,IAAAU,oBAAO,EAACjB,SAAS,CAACkB,QAAQ,EAAEH,GAAG,CAAC;MACtDD,YAAY,GAAG,IAAI;IACrB;IAEA,IAAIA,YAAY,EAAE;MAChBb,QAAQ,CAAC;QACPkB,QAAQ,EAAEC,IAAI,CAACC,GAAG,CAAChB,cAAc,EAAEC,eAAe,CAAC;QACnDgB,iBAAiB,EAAEV,SAAS;QAC5BN,eAAe,EAAEA,eAAe;QAChCC,mBAAmB,EAAEA;MACvB,CAAC,CAAC;IACJ;EACF,CAAC,CAAC;EAEF,OAAO;IACLgB,IAAI,EAAE,SAAAA,KAAA,EAAY;MAChB,OAAOf,YAAY,CAACgB,WAAW,CAAC,CAAC;IACnC;EACF,CAAC;AACH;AAEO,SAASC,mBAAmBA,CAAA,EAAG;EACpC,IAAIb,SAAS,GAAG,IAAAc,uBAAU,EAAC,CAAC;EAE5B,IAAIC,QAAQ,GAAG,IAAAC,4CAAoB,EAAC,CAAC;EACrC,IAAIC,MAAM,GAAGF,QAAQ,CAACE,MAAM;EAC5B,IAAIhB,YAAY,GAAGO,IAAI,CAACU,KAAK,CAC3B,CAACC,QAAQ,CAACC,gBAAgB,IAAID,QAAQ,CAACE,eAAe,EAAEpB,YAC1D,CAAC;EACD,IAAIF,WAAW,GAAGS,IAAI,CAACU,KAAK,CAACD,MAAM,GAAGjB,SAAS,CAAC;EAEhD,OAAO;IACLC,YAAY,EAAEA,YAAY;IAC1BF,WAAW,EAAEA,WAAW;IACxBC,SAAS,EAAEA;EACb,CAAC;AACH;AACO,SAASR,4BAA4BA,CAACL,aAAa,EAAEmC,gBAAgB,EAAE;EAC5E,IAAIA,gBAAgB,KAAK/B,SAAS,EAAE;IAClC+B,gBAAgB,GAAGvC,wBAAwB;EAC7C;EACA,OAAO,IAAIwC,uBAAU,CAAC,UAAUC,UAAU,EAAE;IAC1C,SAASC,MAAMA,CAAA,EAAG;MAChBD,UAAU,CAACC,MAAM,CAACZ,mBAAmB,CAAC,CAAC,CAAC;IAC1C;IAEA,IAAIa,MAAM,CAACC,cAAc,EAAE;MACzB,IAAIC,eAAe,GAAG,IAAAC,qBAAQ,EAACJ,MAAM,EAAEH,gBAAgB,EAAE;QACvDQ,OAAO,EAAE,KAAK;QACdC,QAAQ,EAAE;MACZ,CAAC,CAAC;MAEF,IAAIC,cAAc,GAAGb,QAAQ,CAACC,gBAAgB,IAAID,QAAQ,CAACE,eAAe;MAC1E,IAAIY,cAAc,GAAG,IAAIN,cAAc,CACrC,IAAAO,oBAAO,EAACN,eAAe,CAACO,SAAS,CACnC,CAAC;MACDF,cAAc,CAACG,OAAO,CAACJ,cAAc,CAAC;MACtC,IAAIK,aAAa,GAAG,IAAAC,6BAAgB,EAClCZ,MAAM,EACNa,sBAAS,CAACC,MAAM,EAChBZ,eAAe,CAACO,SAAS,EACzB;QACEM,OAAO,EAAE;MACX,CACF,CAAC;MAED,OAAO,YAAY;QACjBb,eAAe,CAACc,MAAM,CAAC,CAAC;QACxBT,cAAc,CAACU,SAAS,CAACX,cAAc,CAAC;QACxCK,aAAa,CAAC1B,IAAI,CAAC,CAAC;MACtB,CAAC;IACH;EACF,CAAC,CAAC;AACJ","ignoreList":[]}