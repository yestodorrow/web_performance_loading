{"version":3,"file":"viewCollection.js","names":["_browserCore","require","_trackViews","startViewCollection","lifeCycle","configuration","location","domMutationObservable","locationChangeObservable","pageStateHistory","recorderApi","initialViewOptions","subscribe","LifeCycleEventType","VIEW_UPDATED","view","notify","RAW_RUM_EVENT_COLLECTED","processViewUpdate","trackViews","trackViewsManually","computePerformanceViewDetails","navigationTimings","undefined","fetchStart","responseEnd","domInteractive","domContentLoaded","domComplete","loadEventEnd","loadEventStart","domContentLoadedEventEnd","details","isNumber","fpt","toServerDuration","apdexLevel","parseInt","tti","dom_ready","load","resource_load_time","dom","replayStats","getReplayStats","id","pageStates","findAll","startClocks","relative","duration","viewEvent","_gc","document_version","documentVersion","replay_stats","page_states","date","timeStamp","type","RumEventType","VIEW","action","count","eventCounts","actionCount","frustration","frustrationCount","cumulative_layout_shift","findByPath","commonViewMetrics","cumulative_layout_shift_target_selector","first_byte","initialViewMetrics","dom_complete","dom_content_loaded","dom_interactive","error","errorCount","first_contentful_paint","first_input_delay","first_input_time","first_input_target_selector","interaction_to_next_paint","interaction_to_next_paint_target_selector","is_active","isActive","name","largest_contentful_paint","largest_contentful_paint_element_selector","load_event","loading_time","discardNegativeDuration","loadingTime","loading_type","loadingType","long_task","longTaskCount","resource","resourceCount","time_spent","display","scroll","max_depth","maxDepth","max_depth_scroll_top","maxDepthScrollTop","max_scroll_height","maxScrollHeight","max_scroll_height_time","maxScrollHeightTime","session","has_replay","sessionIsActive","privacy","replay_level","defaultPrivacyLevel","isEmptyObject","customTimings","custom_timings","mapValues","extend2Lev","rawRumEvent","startTime","domainContext"],"sources":["../../../../src/domain/rumEventsCollection/view/viewCollection.js"],"sourcesContent":["import {\n  isEmptyObject,\n  mapValues,\n  toServerDuration,\n  isNumber,\n  RumEventType,\n  LifeCycleEventType,\n  extend2Lev,\n  findByPath\n} from '@cloudcare/browser-core'\nimport { trackViews } from './trackViews'\nexport function startViewCollection(\n  lifeCycle,\n  configuration,\n  location,\n  domMutationObservable,\n  locationChangeObservable,\n  pageStateHistory,\n  recorderApi,\n  initialViewOptions\n) {\n  lifeCycle.subscribe(LifeCycleEventType.VIEW_UPDATED, function (view) {\n    lifeCycle.notify(\n      LifeCycleEventType.RAW_RUM_EVENT_COLLECTED,\n      processViewUpdate(view, configuration, recorderApi, pageStateHistory)\n    )\n  })\n\n  return trackViews(\n    location,\n    lifeCycle,\n    domMutationObservable,\n    configuration,\n    locationChangeObservable,\n    !configuration.trackViewsManually,\n    initialViewOptions\n  )\n}\nfunction computePerformanceViewDetails(navigationTimings) {\n  if (!navigationTimings) {\n    return undefined\n  }\n  var fetchStart = navigationTimings.fetchStart,\n    responseEnd = navigationTimings.responseEnd,\n    domInteractive = navigationTimings.domInteractive,\n    domContentLoaded = navigationTimings.domContentLoaded,\n    domComplete = navigationTimings.domComplete,\n    loadEventEnd = navigationTimings.loadEventEnd,\n    loadEventStart = navigationTimings.loadEventStart,\n    domContentLoadedEventEnd = navigationTimings.domContentLoadedEventEnd\n  var details = {}\n  if (\n    isNumber(responseEnd) &&\n    isNumber(fetchStart) &&\n    responseEnd !== fetchStart\n  ) {\n    details.fpt = toServerDuration(responseEnd - fetchStart)\n    var apdexLevel = parseInt((responseEnd - fetchStart) / 1000) // 秒数取整\n    details.apdexLevel = apdexLevel > 9 ? 9 : apdexLevel\n  }\n  if (\n    isNumber(domInteractive) &&\n    isNumber(fetchStart) &&\n    domInteractive !== fetchStart\n  ) {\n    details.tti = toServerDuration(domInteractive - fetchStart)\n  }\n  if (\n    isNumber(domContentLoaded) &&\n    isNumber(fetchStart) &&\n    domContentLoaded !== fetchStart\n  ) {\n    details.dom_ready = toServerDuration(domContentLoaded - fetchStart)\n  }\n  // Make sure a connection occurred\n  if (\n    isNumber(loadEventEnd) &&\n    isNumber(fetchStart) &&\n    loadEventEnd !== fetchStart\n  ) {\n    details.load = toServerDuration(loadEventEnd - fetchStart)\n  }\n  if (\n    isNumber(loadEventStart) &&\n    isNumber(domContentLoadedEventEnd) &&\n    loadEventStart !== domContentLoadedEventEnd\n  ) {\n    details.resource_load_time = toServerDuration(\n      loadEventStart - domContentLoadedEventEnd\n    )\n  }\n  if (\n    isNumber(domComplete) &&\n    isNumber(domInteractive) &&\n    domComplete !== domInteractive\n  ) {\n    details.dom = toServerDuration(domComplete - domInteractive)\n  }\n  return details\n}\n\nfunction processViewUpdate(view, configuration, recorderApi, pageStateHistory) {\n  var replayStats = recorderApi.getReplayStats(view.id)\n  var pageStates = pageStateHistory.findAll(\n    view.startClocks.relative,\n    view.duration\n  )\n  var viewEvent = {\n    _gc: {\n      document_version: view.documentVersion,\n      replay_stats: replayStats,\n      page_states: pageStates\n    },\n    date: view.startClocks.timeStamp,\n    type: RumEventType.VIEW,\n    view: {\n      action: {\n        count: view.eventCounts.actionCount\n      },\n      frustration: {\n        count: view.eventCounts.frustrationCount\n      },\n      cumulative_layout_shift: findByPath(\n        view.commonViewMetrics,\n        'cumulativeLayoutShift.value'\n      ),\n      cumulative_layout_shift_target_selector: findByPath(\n        view.commonViewMetrics,\n        'cumulativeLayoutShift.targetSelector'\n      ),\n      first_byte: toServerDuration(\n        findByPath(view.initialViewMetrics, 'navigationTimings.firstByte')\n      ),\n      dom_complete: toServerDuration(\n        findByPath(view.initialViewMetrics, 'navigationTimings.domComplete')\n      ),\n      dom_content_loaded: toServerDuration(\n        findByPath(\n          view.initialViewMetrics,\n          'navigationTimings.domContentLoaded'\n        )\n      ),\n      dom_interactive: toServerDuration(\n        findByPath(view.initialViewMetrics, 'navigationTimings.domInteractive')\n      ),\n      error: {\n        count: view.eventCounts.errorCount\n      },\n      first_contentful_paint: toServerDuration(\n        findByPath(view.initialViewMetrics, 'firstContentfulPaint')\n      ),\n      first_input_delay: toServerDuration(\n        findByPath(view.initialViewMetrics, 'firstInput.delay')\n      ),\n      first_input_time: toServerDuration(\n        findByPath(view.initialViewMetrics, 'firstInput.time')\n      ),\n      first_input_target_selector: findByPath(\n        view.initialViewMetrics,\n        'firstInput.targetSelector'\n      ),\n      interaction_to_next_paint: toServerDuration(\n        findByPath(view.commonViewMetrics, 'interactionToNextPaint.value')\n      ),\n      interaction_to_next_paint_target_selector: findByPath(\n        view.commonViewMetrics,\n        'interactionToNextPaint.targetSelector'\n      ),\n      is_active: view.isActive,\n      name: view.name,\n      largest_contentful_paint: toServerDuration(\n        findByPath(view.initialViewMetrics, 'largestContentfulPaint.value')\n      ),\n      largest_contentful_paint_element_selector: findByPath(\n        view.initialViewMetrics,\n        'largestContentfulPaint.targetSelector'\n      ),\n      load_event: toServerDuration(\n        findByPath(view.initialViewMetrics, 'navigationTimings.loadEvent')\n      ),\n      loading_time: discardNegativeDuration(\n        toServerDuration(view.commonViewMetrics.loadingTime)\n      ),\n      loading_type: view.loadingType,\n      long_task: {\n        count: view.eventCounts.longTaskCount\n      },\n      resource: {\n        count: view.eventCounts.resourceCount\n      },\n      time_spent: toServerDuration(view.duration)\n    },\n    display: view.commonViewMetrics.scroll\n      ? {\n          scroll: {\n            max_depth: view.commonViewMetrics.scroll.maxDepth,\n            max_depth_scroll_top:\n              view.commonViewMetrics.scroll.maxDepthScrollTop,\n            max_scroll_height: view.commonViewMetrics.scroll.maxScrollHeight,\n            max_scroll_height_time: toServerDuration(\n              view.commonViewMetrics.scroll.maxScrollHeightTime\n            )\n          }\n        }\n      : undefined,\n    session: {\n      has_replay: replayStats ? true : undefined,\n      is_active: view.sessionIsActive ? undefined : false\n    },\n    privacy: {\n      replay_level: configuration.defaultPrivacyLevel\n    }\n  }\n  if (!isEmptyObject(view.customTimings)) {\n    viewEvent.view.custom_timings = mapValues(\n      view.customTimings,\n      toServerDuration\n    )\n  }\n  viewEvent = extend2Lev(viewEvent, {\n    view: computePerformanceViewDetails(\n      view.initialViewMetrics.navigationTimings\n    )\n  })\n  return {\n    rawRumEvent: viewEvent,\n    startTime: view.startClocks.relative,\n    domainContext: {\n      location: view.location\n    }\n  }\n}\n\nfunction discardNegativeDuration(duration) {\n  return isNumber(duration) && duration < 0 ? undefined : duration\n}\n"],"mappings":"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","ignoreList":[]}