{"version":3,"file":"getDocumentTraceId.js","names":["_browserCore","require","INITIAL_DOCUMENT_OUTDATED_TRACE_ID_THRESHOLD","ONE_MINUTE","exports","getDocumentTraceId","document","data","getDocumentTraceDataFromMeta","getDocumentTraceDataFromComment","traceTime","Date","now","undefined","traceId","traceIdMeta","querySelector","traceTimeMeta","createDocumentTraceData","content","comment","findTraceComment","findCommaSeparatedValue","rawTraceTime","Number","i","childNodes","length","getTraceCommentFromNode","body","node","isTextNode","isCommentNode","match"],"sources":["../../../src/domain/tracing/getDocumentTraceId.js"],"sourcesContent":["import {\n  findCommaSeparatedValue,\n  ONE_MINUTE,\n  isCommentNode,\n  isTextNode\n} from '@cloudcare/browser-core'\n\nexport var INITIAL_DOCUMENT_OUTDATED_TRACE_ID_THRESHOLD = 2 * ONE_MINUTE\n\nexport function getDocumentTraceId(document) {\n  var data =\n    getDocumentTraceDataFromMeta(document) ||\n    getDocumentTraceDataFromComment(document)\n\n  if (\n    !data ||\n    data.traceTime <= Date.now() - INITIAL_DOCUMENT_OUTDATED_TRACE_ID_THRESHOLD\n  ) {\n    return undefined\n  }\n\n  return data.traceId\n}\n\nexport function getDocumentTraceDataFromMeta(document) {\n  var traceIdMeta = document.querySelector('meta[name=df-trace-id]')\n  var traceTimeMeta = document.querySelector('meta[name=df-trace-time]')\n  return createDocumentTraceData(\n    traceIdMeta && traceIdMeta.content,\n    traceTimeMeta && traceTimeMeta.content\n  )\n}\n\nexport function getDocumentTraceDataFromComment(document) {\n  var comment = findTraceComment(document)\n  if (!comment) {\n    return undefined\n  }\n  return createDocumentTraceData(\n    findCommaSeparatedValue(comment, 'trace-id'),\n    findCommaSeparatedValue(comment, 'trace-time')\n  )\n}\n\nexport function createDocumentTraceData(traceId, rawTraceTime) {\n  var traceTime = rawTraceTime && Number(rawTraceTime)\n  if (!traceId || !traceTime) {\n    return undefined\n  }\n\n  return {\n    traceId: traceId,\n    traceTime: traceTime\n  }\n}\n\nexport function findTraceComment(document) {\n  // 1. Try to find the comment as a direct child of the document\n  // Note: TSLint advises to use a 'for of', but TS doesn't allow to use 'for of' if the iterated\n  // value is not an array or string (here, a NodeList).\n  // tslint:disable-next-line: prefer-for-of\n  for (var i = 0; i < document.childNodes.length; i += 1) {\n    var comment = getTraceCommentFromNode(document.childNodes[i])\n    if (comment) {\n      return comment\n    }\n  }\n\n  // 2. If the comment is placed after the </html> tag, but have some space or new lines before or\n  // after, the DOM parser will lift it (and the surrounding text) at the end of the <body> tag.\n  // Try to look for the comment at the end of the <body> by by iterating over its child nodes in\n  // reverse order, stoping if we come accross a non-text node.\n  if (document.body) {\n    for (var i = document.body.childNodes.length - 1; i >= 0; i -= 1) {\n      var node = document.body.childNodes[i]\n      var comment = getTraceCommentFromNode(node)\n      if (comment) {\n        return comment\n      }\n      if (!isTextNode(node)) {\n        break\n      }\n    }\n  }\n}\n\nfunction getTraceCommentFromNode(node) {\n  if (node && isCommentNode(node)) {\n    var match = node.data.match(/^\\s*GUANCE;(.*?)\\s*$/)\n    if (match) {\n      return match[1]\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;AAAA,IAAAA,YAAA,GAAAC,OAAA;AAOO,IAAIC,4CAA4C,GAAG,CAAC,GAAGC,uBAAU;AAAAC,OAAA,CAAAF,4CAAA,GAAAA,4CAAA;AAEjE,SAASG,kBAAkBA,CAACC,QAAQ,EAAE;EAC3C,IAAIC,IAAI,GACNC,4BAA4B,CAACF,QAAQ,CAAC,IACtCG,+BAA+B,CAACH,QAAQ,CAAC;EAE3C,IACE,CAACC,IAAI,IACLA,IAAI,CAACG,SAAS,IAAIC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGV,4CAA4C,EAC3E;IACA,OAAOW,SAAS;EAClB;EAEA,OAAON,IAAI,CAACO,OAAO;AACrB;AAEO,SAASN,4BAA4BA,CAACF,QAAQ,EAAE;EACrD,IAAIS,WAAW,GAAGT,QAAQ,CAACU,aAAa,CAAC,wBAAwB,CAAC;EAClE,IAAIC,aAAa,GAAGX,QAAQ,CAACU,aAAa,CAAC,0BAA0B,CAAC;EACtE,OAAOE,uBAAuB,CAC5BH,WAAW,IAAIA,WAAW,CAACI,OAAO,EAClCF,aAAa,IAAIA,aAAa,CAACE,OACjC,CAAC;AACH;AAEO,SAASV,+BAA+BA,CAACH,QAAQ,EAAE;EACxD,IAAIc,OAAO,GAAGC,gBAAgB,CAACf,QAAQ,CAAC;EACxC,IAAI,CAACc,OAAO,EAAE;IACZ,OAAOP,SAAS;EAClB;EACA,OAAOK,uBAAuB,CAC5B,IAAAI,oCAAuB,EAACF,OAAO,EAAE,UAAU,CAAC,EAC5C,IAAAE,oCAAuB,EAACF,OAAO,EAAE,YAAY,CAC/C,CAAC;AACH;AAEO,SAASF,uBAAuBA,CAACJ,OAAO,EAAES,YAAY,EAAE;EAC7D,IAAIb,SAAS,GAAGa,YAAY,IAAIC,MAAM,CAACD,YAAY,CAAC;EACpD,IAAI,CAACT,OAAO,IAAI,CAACJ,SAAS,EAAE;IAC1B,OAAOG,SAAS;EAClB;EAEA,OAAO;IACLC,OAAO,EAAEA,OAAO;IAChBJ,SAAS,EAAEA;EACb,CAAC;AACH;AAEO,SAASW,gBAAgBA,CAACf,QAAQ,EAAE;EACzC;EACA;EACA;EACA;EACA,KAAK,IAAImB,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGnB,QAAQ,CAACoB,UAAU,CAACC,MAAM,EAAEF,CAAC,IAAI,CAAC,EAAE;IACtD,IAAIL,OAAO,GAAGQ,uBAAuB,CAACtB,QAAQ,CAACoB,UAAU,CAACD,CAAC,CAAC,CAAC;IAC7D,IAAIL,OAAO,EAAE;MACX,OAAOA,OAAO;IAChB;EACF;;EAEA;EACA;EACA;EACA;EACA,IAAId,QAAQ,CAACuB,IAAI,EAAE;IACjB,KAAK,IAAIJ,CAAC,GAAGnB,QAAQ,CAACuB,IAAI,CAACH,UAAU,CAACC,MAAM,GAAG,CAAC,EAAEF,CAAC,IAAI,CAAC,EAAEA,CAAC,IAAI,CAAC,EAAE;MAChE,IAAIK,IAAI,GAAGxB,QAAQ,CAACuB,IAAI,CAACH,UAAU,CAACD,CAAC,CAAC;MACtC,IAAIL,OAAO,GAAGQ,uBAAuB,CAACE,IAAI,CAAC;MAC3C,IAAIV,OAAO,EAAE;QACX,OAAOA,OAAO;MAChB;MACA,IAAI,CAAC,IAAAW,uBAAU,EAACD,IAAI,CAAC,EAAE;QACrB;MACF;IACF;EACF;AACF;AAEA,SAASF,uBAAuBA,CAACE,IAAI,EAAE;EACrC,IAAIA,IAAI,IAAI,IAAAE,0BAAa,EAACF,IAAI,CAAC,EAAE;IAC/B,IAAIG,KAAK,GAAGH,IAAI,CAACvB,IAAI,CAAC0B,KAAK,CAAC,sBAAsB,CAAC;IACnD,IAAIA,KAAK,EAAE;MACT,OAAOA,KAAK,CAAC,CAAC,CAAC;IACjB;EACF;AACF","ignoreList":[]}