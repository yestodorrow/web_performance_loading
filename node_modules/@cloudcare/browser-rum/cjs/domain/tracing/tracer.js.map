{"version":3,"file":"tracer.js","names":["_browserCore","require","_ddtraceTracer","_skywalkingTracer","_jaegerTracer","_zipkinSingleTracer","_zipkinMultiTracer","_w3cTraceParentTracer","isTracingOption","item","expectedItem","getType","isMatchOption","match","isString","traceType","clearTracingIfNeeded","context","status","isAborted","traceId","undefined","spanId","traceSampled","startTracer","configuration","sessionManager","traceFetch","injectHeadersIfTracingAllowed","tracingHeaders","input","Request","init","headers","each","value","key","append","shallowClone","Headers","forEach","push","isArray","header","headersMap","concat","objectEntries","traceXhr","xhr","name","setRequestHeader","inject","findTrackedSession","tracingOption","find","allowedTracingUrls","matchList","url","isNumber","tracingSampleRate","performDraw","tracer","TraceType","DDTRACE","DDtraceTracer","SKYWALKING_V3","SkyWalkingTracer","ZIPKIN_MULTI_HEADER","ZipkinMultiTracer","JAEGER","JaegerTracer","W3C_TRACEPARENT","W3cTraceParentTracer","W3C_TRACEPARENT_64","ZIPKIN_SINGLE_HEADER","ZipkinSingleTracer","isTracingSupported","getTraceId","getSpanId","makeTracingHeaders"],"sources":["../../../src/domain/tracing/tracer.js"],"sourcesContent":["import {\n  objectEntries,\n  each,\n  shallowClone,\n  isArray,\n  TraceType,\n  performDraw,\n  isNumber,\n  getType,\n  find,\n  isMatchOption,\n  matchList,\n  isString\n} from '@cloudcare/browser-core'\nimport { DDtraceTracer } from './ddtraceTracer'\nimport { SkyWalkingTracer } from './skywalkingTracer'\nimport { JaegerTracer } from './jaegerTracer'\nimport { ZipkinSingleTracer } from './zipkinSingleTracer'\nimport { ZipkinMultiTracer } from './zipkinMultiTracer'\nimport { W3cTraceParentTracer } from './w3cTraceParentTracer'\n\nexport function isTracingOption(item) {\n  var expectedItem = item\n  return (\n    getType(expectedItem) === 'object' &&\n    isMatchOption(expectedItem.match) &&\n    isString(expectedItem.traceType)\n  )\n}\nexport function clearTracingIfNeeded(context) {\n  if (context.status === 0 && !context.isAborted) {\n    context.traceId = undefined\n    context.spanId = undefined\n    context.traceSampled = undefined\n  }\n}\n\nexport function startTracer(configuration, sessionManager) {\n  return {\n    clearTracingIfNeeded: clearTracingIfNeeded,\n    traceFetch: function (context) {\n      return injectHeadersIfTracingAllowed(\n        configuration,\n        context,\n        sessionManager,\n        function (tracingHeaders) {\n          if (\n            context.input instanceof Request &&\n            (!context.init || !context.init.headers)\n          ) {\n            context.input = new Request(context.input)\n            each(tracingHeaders, function (value, key) {\n              context.input.headers.append(key, value)\n            })\n          } else {\n            context.init = shallowClone(context.init)\n            var headers = []\n            if (context.init.headers instanceof Headers) {\n              context.init.headers.forEach(function (value, key) {\n                headers.push([key, value])\n              })\n            } else if (isArray(context.init.headers)) {\n              each(context.init.headers, function (header) {\n                headers.push(header)\n              })\n            } else if (context.init.headers) {\n              each(context.init.headers, function (value, key) {\n                headers.push([key, value])\n              })\n            }\n            // context.init.headers = headers.concat(objectEntries(tracingHeaders))\n            // 转换成对象，兼容部分\n            var headersMap = {}\n            each(\n              headers.concat(objectEntries(tracingHeaders)),\n              function (header) {\n                headersMap[header[0]] = header[1]\n              }\n            )\n            context.init.headers = headersMap\n          }\n        }\n      )\n    },\n    traceXhr: function (context, xhr) {\n      return injectHeadersIfTracingAllowed(\n        configuration,\n        context,\n        sessionManager,\n        function (tracingHeaders) {\n          each(tracingHeaders, function (value, name) {\n            xhr.setRequestHeader(name, value)\n          })\n        }\n      )\n    }\n  }\n}\n\nexport function injectHeadersIfTracingAllowed(\n  configuration,\n  context,\n  sessionManager,\n  inject\n) {\n  if (!sessionManager.findTrackedSession()) {\n    return\n  }\n  var tracingOption = find(\n    configuration.allowedTracingUrls,\n    function (tracingOption) {\n      return matchList([tracingOption.match], context.url, true)\n    }\n  )\n  if (!tracingOption) {\n    return\n  }\n  var traceSampled =\n    !isNumber(configuration.tracingSampleRate) ||\n    performDraw(configuration.tracingSampleRate)\n  var tracer,\n    traceType = tracingOption.traceType\n  switch (traceType) {\n    case TraceType.DDTRACE:\n      tracer = new DDtraceTracer(traceSampled)\n      break\n    case TraceType.SKYWALKING_V3:\n      tracer = new SkyWalkingTracer(configuration, context.url, traceSampled)\n      break\n    case TraceType.ZIPKIN_MULTI_HEADER:\n      tracer = new ZipkinMultiTracer(configuration, traceSampled)\n      break\n    case TraceType.JAEGER:\n      tracer = new JaegerTracer(configuration, traceSampled)\n      break\n    case TraceType.W3C_TRACEPARENT:\n      tracer = new W3cTraceParentTracer(traceSampled)\n      break\n    case TraceType.W3C_TRACEPARENT_64:\n      tracer = new W3cTraceParentTracer(traceSampled, true)\n      break\n    case TraceType.ZIPKIN_SINGLE_HEADER:\n      tracer = new ZipkinSingleTracer(configuration, traceSampled)\n      break\n    default:\n      break\n  }\n  if (!tracer || !tracer.isTracingSupported()) {\n    return\n  }\n\n  context.traceId = tracer.getTraceId()\n  context.spanId = tracer.getSpanId()\n  context.traceSampled = traceSampled\n  inject(tracer.makeTracingHeaders())\n}\n"],"mappings":"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","ignoreList":[]}