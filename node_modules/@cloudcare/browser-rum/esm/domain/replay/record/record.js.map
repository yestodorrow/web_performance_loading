{"version":3,"file":"record.js","names":["timeStampNow","getScrollX","getScrollY","getViewportDimension","RecordType","IncrementalSource","serializeDocument","SerializationContextStatus","initObservers","getVisualViewport","assembleIncrementalSnapshot","createElementsScrollPositions","initShadowRootsController","record","options","emit","Error","elementsScrollPositions","mutationCb","mutation","Mutation","inputCb","s","Input","shadowRootsController","configuration","takeFullSnapshot","timestamp","serializationContext","status","INITIAL_FULL_SNAPSHOT","_viewportDimension","width","height","data","href","window","location","type","Meta","has_focus","document","hasFocus","Focus","node","initialOffset","left","top","FullSnapshot","visualViewport","VisualViewport","_initObservers","lifeCycle","mediaInteractionCb","p","MediaInteraction","mouseInteractionCb","mouseInteractionRecord","mousemoveCb","positions","source","scrollCb","Scroll","styleSheetCb","r","StyleSheetRule","viewportResizeCb","d","ViewportResize","frustrationCb","frustrationRecord","focusCb","visualViewportResizeCb","stopObservers","stop","flushMutationsFromObservers","flush","flushMutations","takeSubsequentFullSnapshot","SUBSEQUENT_FULL_SNAPSHOT"],"sources":["../../../../src/domain/replay/record/record.js"],"sourcesContent":["import { timeStampNow, getScrollX, getScrollY } from '@cloudcare/browser-core'\nimport { getViewportDimension } from '../../initViewportObservable'\n\nimport { RecordType, IncrementalSource } from '../../../types'\nimport { serializeDocument, SerializationContextStatus } from './serialize'\nimport { initObservers } from './observers'\n\nimport { getVisualViewport } from './viewports'\nimport { assembleIncrementalSnapshot } from './utils'\nimport { createElementsScrollPositions } from './elementsScrollPositions'\nimport { initShadowRootsController } from './shadowRootsController'\n\nexport function record(options) {\n  var emit = options.emit\n  // runtime checks for user options\n  if (!emit) {\n    throw new Error('emit function is required')\n  }\n\n  var elementsScrollPositions = createElementsScrollPositions()\n\n  var mutationCb = function (mutation) {\n    emit(assembleIncrementalSnapshot(IncrementalSource.Mutation, mutation))\n  }\n  var inputCb = function (s) {\n    emit(assembleIncrementalSnapshot(IncrementalSource.Input, s))\n  }\n\n  var shadowRootsController = initShadowRootsController(options.configuration, {\n    mutationCb,\n    inputCb\n  })\n\n  var takeFullSnapshot = function (timestamp, serializationContext) {\n    if (typeof timestamp === 'undefined') {\n      timestamp = timeStampNow()\n    }\n    if (typeof serializationContext === 'undefined') {\n      serializationContext = {\n        status: SerializationContextStatus.INITIAL_FULL_SNAPSHOT,\n        elementsScrollPositions: elementsScrollPositions,\n        shadowRootsController: shadowRootsController\n      }\n    }\n    var _viewportDimension = getViewportDimension()\n    var width = _viewportDimension.width\n    var height = _viewportDimension.height\n    emit({\n      data: {\n        height: height,\n        href: window.location.href,\n        width: width\n      },\n      type: RecordType.Meta,\n      timestamp: timestamp\n    })\n\n    emit({\n      data: {\n        has_focus: document.hasFocus()\n      },\n      type: RecordType.Focus,\n      timestamp: timestamp\n    })\n\n    emit({\n      data: {\n        node: serializeDocument(\n          document,\n          options.configuration,\n          serializationContext\n        ),\n        initialOffset: {\n          left: getScrollX(),\n          top: getScrollY()\n        }\n      },\n      type: RecordType.FullSnapshot,\n      timestamp: timestamp\n    })\n\n    if (window.visualViewport) {\n      emit({\n        data: getVisualViewport(),\n        type: RecordType.VisualViewport,\n        timestamp: timestamp\n      })\n    }\n  }\n\n  takeFullSnapshot()\n  var _initObservers = initObservers({\n    lifeCycle: options.lifeCycle,\n    configuration: options.configuration,\n    elementsScrollPositions: elementsScrollPositions,\n    inputCb: inputCb,\n    mediaInteractionCb: function (p) {\n      emit(assembleIncrementalSnapshot(IncrementalSource.MediaInteraction, p))\n    },\n    mouseInteractionCb: function (mouseInteractionRecord) {\n      emit(mouseInteractionRecord)\n    },\n    mousemoveCb: function (positions, source) {\n      emit(assembleIncrementalSnapshot(source, { positions: positions }))\n    },\n    mutationCb: mutationCb,\n    scrollCb: function (p) {\n      emit(assembleIncrementalSnapshot(IncrementalSource.Scroll, p))\n    },\n    styleSheetCb: function (r) {\n      emit(assembleIncrementalSnapshot(IncrementalSource.StyleSheetRule, r))\n    },\n    viewportResizeCb: function (d) {\n      emit(assembleIncrementalSnapshot(IncrementalSource.ViewportResize, d))\n    },\n    frustrationCb: function (frustrationRecord) {\n      emit(frustrationRecord)\n    },\n    focusCb: function (data) {\n      emit({\n        data: data,\n        type: RecordType.Focus,\n        timestamp: timeStampNow()\n      })\n    },\n    visualViewportResizeCb: function (data) {\n      emit({\n        data: data,\n        type: RecordType.VisualViewport,\n        timestamp: timeStampNow()\n      })\n    },\n    shadowRootsController: shadowRootsController\n  })\n  var stopObservers = _initObservers.stop\n  var flushMutationsFromObservers = _initObservers.flush\n  function flushMutations() {\n    shadowRootsController.flush()\n    flushMutationsFromObservers()\n  }\n\n  return {\n    stop: function () {\n      shadowRootsController.stop()\n      stopObservers()\n    },\n    takeSubsequentFullSnapshot: function (timestamp) {\n      flushMutations()\n      takeFullSnapshot(timestamp, {\n        shadowRootsController: shadowRootsController,\n        status: SerializationContextStatus.SUBSEQUENT_FULL_SNAPSHOT,\n        elementsScrollPositions: elementsScrollPositions\n      })\n    },\n    flushMutations: flushMutations,\n    shadowRootsController: shadowRootsController\n  }\n}\n"],"mappings":"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","ignoreList":[]}