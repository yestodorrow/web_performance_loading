{"version":3,"file":"deflateEncoder.js","names":["addEventListener","concatBuffers","addTelemetryDebug","DeflateEncoderStreamId","REPLAY","createDeflateEncoder","worker","streamId","rawBytesCount","compressedData","compressedDataTrailer","nextWriteActionId","pendingWriteActions","wokerListener","params","data","type","nextPendingAction","shift","id","additionalBytesCount","result","push","trailer","callback","removeMessageListener","stop","getEncodedBytes","length","Uint8Array","concat","getEncodedBytesCount","reduce","total","buffer","getRawBytesCount","write","postMessage","action","reset"],"sources":["../../../../src/domain/replay/deflate/deflateEncoder.js"],"sourcesContent":["import {\n  addEventListener,\n  concatBuffers,\n  addTelemetryDebug\n} from '@cloudcare/browser-core'\nexport var DeflateEncoderStreamId = {\n  REPLAY: 1\n}\nexport function createDeflateEncoder(worker, streamId) {\n  var rawBytesCount = 0\n  var compressedData = []\n  var compressedDataTrailer\n\n  var nextWriteActionId = 0\n  var pendingWriteActions = []\n\n  var wokerListener = addEventListener(worker, 'message', function (params) {\n    var data = params.data\n    if (data.type !== 'wrote' || data.streamId !== streamId) {\n      return\n    }\n\n    var nextPendingAction = pendingWriteActions.shift()\n    if (nextPendingAction && nextPendingAction.id === data.id) {\n      if (data.id === 0) {\n        // Initial state\n        rawBytesCount = data.additionalBytesCount\n        compressedData = [data.result]\n      } else {\n        rawBytesCount += data.additionalBytesCount\n        compressedData.push(data.result)\n      }\n      compressedDataTrailer = data.trailer\n      nextPendingAction.callback()\n    } else {\n      removeMessageListener()\n      addTelemetryDebug('Worker responses received out of order.')\n    }\n  })\n  var removeMessageListener = wokerListener.stop\n  return {\n    getEncodedBytes: function () {\n      if (!compressedData.length) {\n        return new Uint8Array(0)\n      }\n\n      return concatBuffers(compressedData.concat(compressedDataTrailer))\n    },\n\n    getEncodedBytesCount: function () {\n      if (!compressedData.length) {\n        return 0\n      }\n\n      return (\n        compressedData.reduce(function (total, buffer) {\n          return total + buffer.length\n        }, 0) + compressedDataTrailer.length\n      )\n    },\n\n    getRawBytesCount: function () {\n      return rawBytesCount\n    },\n\n    write: function (data, callback) {\n      worker.postMessage({\n        action: 'write',\n        id: nextWriteActionId,\n        data: data,\n        streamId: streamId\n      })\n      pendingWriteActions.push({\n        id: nextWriteActionId,\n        callback: callback\n      })\n      nextWriteActionId += 1\n    },\n\n    reset: function () {\n      worker.postMessage({\n        action: 'reset',\n        streamId: streamId\n      })\n      nextWriteActionId = 0\n    }\n  }\n}\n"],"mappings":"AAAA,SACEA,gBAAgB,EAChBC,aAAa,EACbC,iBAAiB,QACZ,yBAAyB;AAChC,OAAO,IAAIC,sBAAsB,GAAG;EAClCC,MAAM,EAAE;AACV,CAAC;AACD,OAAO,SAASC,oBAAoBA,CAACC,MAAM,EAAEC,QAAQ,EAAE;EACrD,IAAIC,aAAa,GAAG,CAAC;EACrB,IAAIC,cAAc,GAAG,EAAE;EACvB,IAAIC,qBAAqB;EAEzB,IAAIC,iBAAiB,GAAG,CAAC;EACzB,IAAIC,mBAAmB,GAAG,EAAE;EAE5B,IAAIC,aAAa,GAAGb,gBAAgB,CAACM,MAAM,EAAE,SAAS,EAAE,UAAUQ,MAAM,EAAE;IACxE,IAAIC,IAAI,GAAGD,MAAM,CAACC,IAAI;IACtB,IAAIA,IAAI,CAACC,IAAI,KAAK,OAAO,IAAID,IAAI,CAACR,QAAQ,KAAKA,QAAQ,EAAE;MACvD;IACF;IAEA,IAAIU,iBAAiB,GAAGL,mBAAmB,CAACM,KAAK,CAAC,CAAC;IACnD,IAAID,iBAAiB,IAAIA,iBAAiB,CAACE,EAAE,KAAKJ,IAAI,CAACI,EAAE,EAAE;MACzD,IAAIJ,IAAI,CAACI,EAAE,KAAK,CAAC,EAAE;QACjB;QACAX,aAAa,GAAGO,IAAI,CAACK,oBAAoB;QACzCX,cAAc,GAAG,CAACM,IAAI,CAACM,MAAM,CAAC;MAChC,CAAC,MAAM;QACLb,aAAa,IAAIO,IAAI,CAACK,oBAAoB;QAC1CX,cAAc,CAACa,IAAI,CAACP,IAAI,CAACM,MAAM,CAAC;MAClC;MACAX,qBAAqB,GAAGK,IAAI,CAACQ,OAAO;MACpCN,iBAAiB,CAACO,QAAQ,CAAC,CAAC;IAC9B,CAAC,MAAM;MACLC,qBAAqB,CAAC,CAAC;MACvBvB,iBAAiB,CAAC,yCAAyC,CAAC;IAC9D;EACF,CAAC,CAAC;EACF,IAAIuB,qBAAqB,GAAGZ,aAAa,CAACa,IAAI;EAC9C,OAAO;IACLC,eAAe,EAAE,SAAAA,gBAAA,EAAY;MAC3B,IAAI,CAAClB,cAAc,CAACmB,MAAM,EAAE;QAC1B,OAAO,IAAIC,UAAU,CAAC,CAAC,CAAC;MAC1B;MAEA,OAAO5B,aAAa,CAACQ,cAAc,CAACqB,MAAM,CAACpB,qBAAqB,CAAC,CAAC;IACpE,CAAC;IAEDqB,oBAAoB,EAAE,SAAAA,qBAAA,EAAY;MAChC,IAAI,CAACtB,cAAc,CAACmB,MAAM,EAAE;QAC1B,OAAO,CAAC;MACV;MAEA,OACEnB,cAAc,CAACuB,MAAM,CAAC,UAAUC,KAAK,EAAEC,MAAM,EAAE;QAC7C,OAAOD,KAAK,GAAGC,MAAM,CAACN,MAAM;MAC9B,CAAC,EAAE,CAAC,CAAC,GAAGlB,qBAAqB,CAACkB,MAAM;IAExC,CAAC;IAEDO,gBAAgB,EAAE,SAAAA,iBAAA,EAAY;MAC5B,OAAO3B,aAAa;IACtB,CAAC;IAED4B,KAAK,EAAE,SAAAA,MAAUrB,IAAI,EAAES,QAAQ,EAAE;MAC/BlB,MAAM,CAAC+B,WAAW,CAAC;QACjBC,MAAM,EAAE,OAAO;QACfnB,EAAE,EAAER,iBAAiB;QACrBI,IAAI,EAAEA,IAAI;QACVR,QAAQ,EAAEA;MACZ,CAAC,CAAC;MACFK,mBAAmB,CAACU,IAAI,CAAC;QACvBH,EAAE,EAAER,iBAAiB;QACrBa,QAAQ,EAAEA;MACZ,CAAC,CAAC;MACFb,iBAAiB,IAAI,CAAC;IACxB,CAAC;IAED4B,KAAK,EAAE,SAAAA,MAAA,EAAY;MACjBjC,MAAM,CAAC+B,WAAW,CAAC;QACjBC,MAAM,EAAE,OAAO;QACf/B,QAAQ,EAAEA;MACZ,CAAC,CAAC;MACFI,iBAAiB,GAAG,CAAC;IACvB;EACF,CAAC;AACH","ignoreList":[]}