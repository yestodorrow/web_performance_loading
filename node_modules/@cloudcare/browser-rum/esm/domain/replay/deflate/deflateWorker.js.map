{"version":3,"file":"deflateWorker.js","names":["display","includes","setTimeout","addEventListener","addTelemetryError","ONE_SECOND","INITIALIZATION_TIME_OUT_DELAY","createDeflateWorker","Worker","URL","createObjectURL","Blob","__BUILD_ENV__WORKER_STRING__","DeflateWorkerStatus","Nil","Loading","Error","Initialized","state","status","startDeflateWorker","onInitializationFailure","createDeflateWorkerImpl","undefined","doStartDeflateWorker","initializationFailureCallbacks","push","worker","resetDeflateWorkerState","getDeflateWorkerStatus","onError","event","data","type","error","streamId","onInitialized","version","postMessage","action","onTimeout","forEach","callback","Event","isMessageCspRelated","message","worker_version","stream_id"],"sources":["../../../../src/domain/replay/deflate/deflateWorker.js"],"sourcesContent":["import {\n  display,\n  includes,\n  setTimeout,\n  addEventListener,\n  addTelemetryError,\n  ONE_SECOND\n} from '@cloudcare/browser-core'\n\nexport var INITIALIZATION_TIME_OUT_DELAY = 10 * ONE_SECOND\n\nexport function createDeflateWorker() {\n  return new Worker(\n    URL.createObjectURL(new Blob([__BUILD_ENV__WORKER_STRING__]))\n  )\n}\n/**\n * In order to be sure that the worker is correctly working, we need a round trip of\n * initialization messages, making the creation asynchronous.\n * These worker lifecycle states handle this case.\n */\nexport var DeflateWorkerStatus = {\n  Nil: 0,\n  Loading: 1,\n  Error: 2,\n  Initialized: 3\n}\n\nvar state = { status: DeflateWorkerStatus.Nil }\n\nexport function startDeflateWorker(\n  onInitializationFailure,\n  createDeflateWorkerImpl\n) {\n  if (createDeflateWorkerImpl === undefined) {\n    createDeflateWorkerImpl = createDeflateWorker\n  }\n  if (state.status === DeflateWorkerStatus.Nil) {\n    doStartDeflateWorker(createDeflateWorkerImpl)\n  }\n  switch (state.status) {\n    case DeflateWorkerStatus.Loading:\n      state.initializationFailureCallbacks.push(onInitializationFailure)\n      return state.worker\n    case DeflateWorkerStatus.Initialized:\n      return state.worker\n  }\n}\n\nexport function resetDeflateWorkerState() {\n  state = { status: DeflateWorkerStatus.Nil }\n}\nexport function getDeflateWorkerStatus() {\n  return state.status\n}\n\n/**\n * Starts the deflate worker and handle messages and errors\n *\n * The spec allow browsers to handle worker errors differently:\n * - Chromium throws an exception\n * - Firefox fires an error event\n *\n * more details: https://bugzilla.mozilla.org/show_bug.cgi?id=1736865#c2\n */\nexport function doStartDeflateWorker(createDeflateWorkerImpl) {\n  if (createDeflateWorkerImpl === undefined) {\n    createDeflateWorkerImpl = createDeflateWorker\n  }\n  try {\n    var worker = createDeflateWorkerImpl()\n    addEventListener(worker, 'error', onError)\n    addEventListener(worker, 'message', function (event) {\n      var data = event.data\n      if (data.type === 'errored') {\n        onError(data.error, data.streamId)\n      } else if (data.type === 'initialized') {\n        onInitialized(data.version)\n      }\n    })\n    worker.postMessage({ action: 'init' })\n    setTimeout(onTimeout, INITIALIZATION_TIME_OUT_DELAY)\n    state = {\n      status: DeflateWorkerStatus.Loading,\n      worker: worker,\n      initializationFailureCallbacks: []\n    }\n  } catch (error) {\n    onError(error)\n  }\n}\nfunction onTimeout() {\n  if (state.status === DeflateWorkerStatus.Loading) {\n    display.error(\n      'Session Replay recording failed to start: a timeout occurred while initializing the Worker'\n    )\n    state.initializationFailureCallbacks.forEach(function (callback) {\n      callback()\n    })\n    state = { status: DeflateWorkerStatus.Error }\n  }\n}\nfunction onInitialized(version) {\n  if (state.status === DeflateWorkerStatus.Loading) {\n    state = {\n      status: DeflateWorkerStatus.Initialized,\n      worker: state.worker,\n      version: version\n    }\n  }\n}\n\nfunction onError(error, streamId) {\n  if (state.status === DeflateWorkerStatus.Loading) {\n    display.error(\n      'Session Replay recording failed to start: an error occurred while creating the Worker:',\n      error\n    )\n    if (\n      error instanceof Event ||\n      (error instanceof Error && isMessageCspRelated(error.message))\n    ) {\n      display.error('Please make sure CSP is correctly configured !!!')\n    } else {\n      addTelemetryError(error)\n    }\n    if (state.status === DeflateWorkerStatus.Loading) {\n      state.initializationFailureCallbacks.forEach(function (callback) {\n        callback()\n      })\n    }\n    state = { status: DeflateWorkerStatus.Error }\n  } else {\n    addTelemetryError(error, {\n      worker_version:\n        state.status === DeflateWorkerStatus.Initialized && state.version,\n      stream_id: streamId\n    })\n  }\n}\nfunction isMessageCspRelated(message) {\n  return (\n    includes(message, 'Content Security Policy') ||\n    // Related to `require-trusted-types-for` CSP: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/require-trusted-types-for\n    includes(message, \"requires 'TrustedScriptURL'\")\n  )\n}\n"],"mappings":"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","ignoreList":[]}