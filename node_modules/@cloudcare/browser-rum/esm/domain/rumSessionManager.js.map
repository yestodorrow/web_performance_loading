{"version":3,"file":"rumSessionManager.js","names":["performDraw","startSessionManager","LifeCycleEventType","noop","Observable","RUM_SESSION_KEY","RumSessionPlan","WITHOUT_SESSION_REPLAY","WITH_SESSION_REPLAY","RumTrackingType","NOT_TRACKED","TRACKED_WITH_SESSION_REPLAY","TRACKED_WITHOUT_SESSION_REPLAY","startRumSessionManager","configuration","lifeCycle","sessionManager","cookieOptions","rawTrackingType","computeSessionState","expireObservable","subscribe","notify","SESSION_EXPIRED","renewObservable","SESSION_RENEWED","findTrackedSession","startTime","session","findActiveSession","isTypeTracked","trackingType","plan","id","sessionReplayAllowed","expire","startRumSessionManagerStub","hasValidRumSession","sessionSampleRate","sessionReplaySampleRate","isTracked","rumSessionType"],"sources":["../../src/domain/rumSessionManager.js"],"sourcesContent":["import {\n  performDraw,\n  startSessionManager,\n  LifeCycleEventType,\n  noop,\n  Observable\n} from '@cloudcare/browser-core'\n\nexport var RUM_SESSION_KEY = 'rum'\n\nexport var RumSessionPlan = {\n  WITHOUT_SESSION_REPLAY: 1,\n  WITH_SESSION_REPLAY: 2\n}\n\nexport var RumTrackingType = {\n  NOT_TRACKED: '0',\n  // Note: the \"tracking type\" value (stored in the session cookie) does not match the \"session\n  // plan\" value (sent in RUM events). This is expected, and was done to keep retrocompatibility\n  // with active sessions when upgrading the SDK.\n  TRACKED_WITH_SESSION_REPLAY: '1',\n  TRACKED_WITHOUT_SESSION_REPLAY: '2'\n}\n\nexport function startRumSessionManager(configuration, lifeCycle) {\n  var sessionManager = startSessionManager(\n    configuration.cookieOptions,\n    RUM_SESSION_KEY,\n    function (rawTrackingType) {\n      return computeSessionState(configuration, rawTrackingType)\n    }\n  )\n\n  sessionManager.expireObservable.subscribe(function () {\n    lifeCycle.notify(LifeCycleEventType.SESSION_EXPIRED)\n  })\n\n  sessionManager.renewObservable.subscribe(function () {\n    lifeCycle.notify(LifeCycleEventType.SESSION_RENEWED)\n  })\n\n  return {\n    findTrackedSession: function (startTime) {\n      var session = sessionManager.findActiveSession(startTime)\n      if (!session || !isTypeTracked(session.trackingType)) {\n        return\n      }\n      var plan =\n        session.trackingType === RumTrackingType.TRACKED_WITH_SESSION_REPLAY\n          ? RumSessionPlan.WITH_SESSION_REPLAY\n          : RumSessionPlan.WITHOUT_SESSION_REPLAY\n      return {\n        id: session.id,\n        plan: plan,\n        sessionReplayAllowed: plan === RumSessionPlan.WITH_SESSION_REPLAY\n      }\n    },\n    expire: sessionManager.expire,\n    expireObservable: sessionManager.expireObservable\n  }\n}\n\n/**\n * Start a tracked replay session stub\n * It needs to be a premium plan in order to get long tasks\n */\nexport function startRumSessionManagerStub() {\n  var session = {\n    id: '00000000-aaaa-0000-aaaa-000000000000',\n    plan: RumSessionPlan.WITHOUT_SESSION_REPLAY, // plan value should not be taken into account for mobile\n    sessionReplayAllowed: false\n  }\n  return {\n    findTrackedSession: function () {\n      return session\n    },\n    expire: noop,\n    expireObservable: new Observable()\n  }\n}\n\nfunction computeSessionState(configuration, rawTrackingType) {\n  var trackingType\n  if (hasValidRumSession(rawTrackingType)) {\n    trackingType = rawTrackingType\n  } else if (!performDraw(configuration.sessionSampleRate)) {\n    trackingType = RumTrackingType.NOT_TRACKED\n  } else if (!performDraw(configuration.sessionReplaySampleRate)) {\n    trackingType = RumTrackingType.TRACKED_WITHOUT_SESSION_REPLAY\n  } else {\n    trackingType = RumTrackingType.TRACKED_WITH_SESSION_REPLAY\n  }\n  return {\n    trackingType: trackingType,\n    isTracked: isTypeTracked(trackingType)\n  }\n}\n\nfunction hasValidRumSession(trackingType) {\n  return (\n    trackingType === RumTrackingType.NOT_TRACKED ||\n    trackingType === RumTrackingType.TRACKED_WITH_SESSION_REPLAY ||\n    trackingType === RumTrackingType.TRACKED_WITHOUT_SESSION_REPLAY\n  )\n}\n\nfunction isTypeTracked(rumSessionType) {\n  return (\n    rumSessionType === RumTrackingType.TRACKED_WITHOUT_SESSION_REPLAY ||\n    rumSessionType === RumTrackingType.TRACKED_WITH_SESSION_REPLAY\n  )\n}\n"],"mappings":"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","ignoreList":[]}