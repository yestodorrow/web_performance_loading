{"version":3,"file":"tracer.js","names":["objectEntries","each","shallowClone","isArray","TraceType","performDraw","isNumber","getType","find","isMatchOption","matchList","isString","DDtraceTracer","SkyWalkingTracer","JaegerTracer","ZipkinSingleTracer","ZipkinMultiTracer","W3cTraceParentTracer","isTracingOption","item","expectedItem","match","traceType","clearTracingIfNeeded","context","status","isAborted","traceId","undefined","spanId","traceSampled","startTracer","configuration","sessionManager","traceFetch","injectHeadersIfTracingAllowed","tracingHeaders","input","Request","init","headers","value","key","append","Headers","forEach","push","header","headersMap","concat","traceXhr","xhr","name","setRequestHeader","inject","findTrackedSession","tracingOption","allowedTracingUrls","url","tracingSampleRate","tracer","DDTRACE","SKYWALKING_V3","ZIPKIN_MULTI_HEADER","JAEGER","W3C_TRACEPARENT","W3C_TRACEPARENT_64","ZIPKIN_SINGLE_HEADER","isTracingSupported","getTraceId","getSpanId","makeTracingHeaders"],"sources":["../../../src/domain/tracing/tracer.js"],"sourcesContent":["import {\n  objectEntries,\n  each,\n  shallowClone,\n  isArray,\n  TraceType,\n  performDraw,\n  isNumber,\n  getType,\n  find,\n  isMatchOption,\n  matchList,\n  isString\n} from '@cloudcare/browser-core'\nimport { DDtraceTracer } from './ddtraceTracer'\nimport { SkyWalkingTracer } from './skywalkingTracer'\nimport { JaegerTracer } from './jaegerTracer'\nimport { ZipkinSingleTracer } from './zipkinSingleTracer'\nimport { ZipkinMultiTracer } from './zipkinMultiTracer'\nimport { W3cTraceParentTracer } from './w3cTraceParentTracer'\n\nexport function isTracingOption(item) {\n  var expectedItem = item\n  return (\n    getType(expectedItem) === 'object' &&\n    isMatchOption(expectedItem.match) &&\n    isString(expectedItem.traceType)\n  )\n}\nexport function clearTracingIfNeeded(context) {\n  if (context.status === 0 && !context.isAborted) {\n    context.traceId = undefined\n    context.spanId = undefined\n    context.traceSampled = undefined\n  }\n}\n\nexport function startTracer(configuration, sessionManager) {\n  return {\n    clearTracingIfNeeded: clearTracingIfNeeded,\n    traceFetch: function (context) {\n      return injectHeadersIfTracingAllowed(\n        configuration,\n        context,\n        sessionManager,\n        function (tracingHeaders) {\n          if (\n            context.input instanceof Request &&\n            (!context.init || !context.init.headers)\n          ) {\n            context.input = new Request(context.input)\n            each(tracingHeaders, function (value, key) {\n              context.input.headers.append(key, value)\n            })\n          } else {\n            context.init = shallowClone(context.init)\n            var headers = []\n            if (context.init.headers instanceof Headers) {\n              context.init.headers.forEach(function (value, key) {\n                headers.push([key, value])\n              })\n            } else if (isArray(context.init.headers)) {\n              each(context.init.headers, function (header) {\n                headers.push(header)\n              })\n            } else if (context.init.headers) {\n              each(context.init.headers, function (value, key) {\n                headers.push([key, value])\n              })\n            }\n            // context.init.headers = headers.concat(objectEntries(tracingHeaders))\n            // 转换成对象，兼容部分\n            var headersMap = {}\n            each(\n              headers.concat(objectEntries(tracingHeaders)),\n              function (header) {\n                headersMap[header[0]] = header[1]\n              }\n            )\n            context.init.headers = headersMap\n          }\n        }\n      )\n    },\n    traceXhr: function (context, xhr) {\n      return injectHeadersIfTracingAllowed(\n        configuration,\n        context,\n        sessionManager,\n        function (tracingHeaders) {\n          each(tracingHeaders, function (value, name) {\n            xhr.setRequestHeader(name, value)\n          })\n        }\n      )\n    }\n  }\n}\n\nexport function injectHeadersIfTracingAllowed(\n  configuration,\n  context,\n  sessionManager,\n  inject\n) {\n  if (!sessionManager.findTrackedSession()) {\n    return\n  }\n  var tracingOption = find(\n    configuration.allowedTracingUrls,\n    function (tracingOption) {\n      return matchList([tracingOption.match], context.url, true)\n    }\n  )\n  if (!tracingOption) {\n    return\n  }\n  var traceSampled =\n    !isNumber(configuration.tracingSampleRate) ||\n    performDraw(configuration.tracingSampleRate)\n  var tracer,\n    traceType = tracingOption.traceType\n  switch (traceType) {\n    case TraceType.DDTRACE:\n      tracer = new DDtraceTracer(traceSampled)\n      break\n    case TraceType.SKYWALKING_V3:\n      tracer = new SkyWalkingTracer(configuration, context.url, traceSampled)\n      break\n    case TraceType.ZIPKIN_MULTI_HEADER:\n      tracer = new ZipkinMultiTracer(configuration, traceSampled)\n      break\n    case TraceType.JAEGER:\n      tracer = new JaegerTracer(configuration, traceSampled)\n      break\n    case TraceType.W3C_TRACEPARENT:\n      tracer = new W3cTraceParentTracer(traceSampled)\n      break\n    case TraceType.W3C_TRACEPARENT_64:\n      tracer = new W3cTraceParentTracer(traceSampled, true)\n      break\n    case TraceType.ZIPKIN_SINGLE_HEADER:\n      tracer = new ZipkinSingleTracer(configuration, traceSampled)\n      break\n    default:\n      break\n  }\n  if (!tracer || !tracer.isTracingSupported()) {\n    return\n  }\n\n  context.traceId = tracer.getTraceId()\n  context.spanId = tracer.getSpanId()\n  context.traceSampled = traceSampled\n  inject(tracer.makeTracingHeaders())\n}\n"],"mappings":"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","ignoreList":[]}