{"version":3,"file":"w3cTraceParentTracer.js","names":["TraceIdentifier","getCrypto","assign","randomTraceId","digits","n","i","rand","Math","floor","random","W3cTraceParentTracer","traceSampled","isHexTraceId","_traceId","_spanId","_traceSampled","prototype","isTracingSupported","undefined","getSpanId","toDecimalString","toPaddedHexadecimalString","getTraceId","getTraceParent","makeTracingHeaders","baseHeaders","traceparent"],"sources":["../../../src/domain/tracing/w3cTraceParentTracer.js"],"sourcesContent":["import { TraceIdentifier, getCrypto } from './traceIdentifier'\nimport { assign } from '@cloudcare/browser-core'\n\n// === Generate a random 64-bit number in fixed-length hex format\nfunction randomTraceId() {\n  var digits = '0123456789abcdef'\n  var n = ''\n  for (var i = 0; i < 16; i += 1) {\n    var rand = Math.floor(Math.random() * 16)\n    n += digits[rand]\n  }\n  return n\n}\n/**\n *\n * @param {*} traceSampled\n * @param {*} isHexTraceId 是否需要转换成10进制上报数据\n */\nexport function W3cTraceParentTracer(traceSampled, isHexTraceId) {\n  this._traceId = new TraceIdentifier()\n  this._spanId = new TraceIdentifier()\n  this._traceSampled = traceSampled\n  this.isHexTraceId = isHexTraceId\n}\nW3cTraceParentTracer.prototype = {\n  isTracingSupported: function () {\n    return getCrypto() !== undefined\n  },\n  getSpanId: function () {\n    return this.isHexTraceId\n      ? this._spanId.toDecimalString()\n      : this._spanId.toPaddedHexadecimalString()\n  },\n  getTraceId: function () {\n    if (this.isHexTraceId) {\n      // 转化为二进制之后上报\n      return this._traceId.toDecimalString()\n    } else {\n      return (\n        this._traceId.toPaddedHexadecimalString() +\n        this._spanId.toPaddedHexadecimalString()\n      )\n    }\n  },\n  getTraceParent: function () {\n    // '{version}-{traceId}-{spanId}-{sampleDecision}'\n    if (this.isHexTraceId) {\n      // 短64位，前面补0\n      return (\n        '00-0000000000000000' +\n        this._traceId.toPaddedHexadecimalString() +\n        '-' +\n        this._spanId.toPaddedHexadecimalString() +\n        '-' +\n        (this._traceSampled ? '01' : '00')\n      )\n    } else {\n      return (\n        '00-' +\n        this.getTraceId() +\n        '-' +\n        this.getSpanId() +\n        '-' +\n        (this._traceSampled ? '01' : '00')\n      )\n    }\n  },\n  makeTracingHeaders: function () {\n    var baseHeaders = {\n      traceparent: this.getTraceParent()\n    }\n    if (this.isHexTraceId) {\n      return assign(baseHeaders, {\n        'x-gc-trace-id': this.getTraceId(),\n        'x-gc-span-id': this.getSpanId()\n      })\n    }\n    return baseHeaders\n  }\n}\n"],"mappings":"AAAA,SAASA,eAAe,EAAEC,SAAS,QAAQ,mBAAmB;AAC9D,SAASC,MAAM,QAAQ,yBAAyB;;AAEhD;AACA,SAASC,aAAaA,CAAA,EAAG;EACvB,IAAIC,MAAM,GAAG,kBAAkB;EAC/B,IAAIC,CAAC,GAAG,EAAE;EACV,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,EAAE,EAAEA,CAAC,IAAI,CAAC,EAAE;IAC9B,IAAIC,IAAI,GAAGC,IAAI,CAACC,KAAK,CAACD,IAAI,CAACE,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC;IACzCL,CAAC,IAAID,MAAM,CAACG,IAAI,CAAC;EACnB;EACA,OAAOF,CAAC;AACV;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASM,oBAAoBA,CAACC,YAAY,EAAEC,YAAY,EAAE;EAC/D,IAAI,CAACC,QAAQ,GAAG,IAAId,eAAe,CAAC,CAAC;EACrC,IAAI,CAACe,OAAO,GAAG,IAAIf,eAAe,CAAC,CAAC;EACpC,IAAI,CAACgB,aAAa,GAAGJ,YAAY;EACjC,IAAI,CAACC,YAAY,GAAGA,YAAY;AAClC;AACAF,oBAAoB,CAACM,SAAS,GAAG;EAC/BC,kBAAkB,EAAE,SAAAA,mBAAA,EAAY;IAC9B,OAAOjB,SAAS,CAAC,CAAC,KAAKkB,SAAS;EAClC,CAAC;EACDC,SAAS,EAAE,SAAAA,UAAA,EAAY;IACrB,OAAO,IAAI,CAACP,YAAY,GACpB,IAAI,CAACE,OAAO,CAACM,eAAe,CAAC,CAAC,GAC9B,IAAI,CAACN,OAAO,CAACO,yBAAyB,CAAC,CAAC;EAC9C,CAAC;EACDC,UAAU,EAAE,SAAAA,WAAA,EAAY;IACtB,IAAI,IAAI,CAACV,YAAY,EAAE;MACrB;MACA,OAAO,IAAI,CAACC,QAAQ,CAACO,eAAe,CAAC,CAAC;IACxC,CAAC,MAAM;MACL,OACE,IAAI,CAACP,QAAQ,CAACQ,yBAAyB,CAAC,CAAC,GACzC,IAAI,CAACP,OAAO,CAACO,yBAAyB,CAAC,CAAC;IAE5C;EACF,CAAC;EACDE,cAAc,EAAE,SAAAA,eAAA,EAAY;IAC1B;IACA,IAAI,IAAI,CAACX,YAAY,EAAE;MACrB;MACA,OACE,qBAAqB,GACrB,IAAI,CAACC,QAAQ,CAACQ,yBAAyB,CAAC,CAAC,GACzC,GAAG,GACH,IAAI,CAACP,OAAO,CAACO,yBAAyB,CAAC,CAAC,GACxC,GAAG,IACF,IAAI,CAACN,aAAa,GAAG,IAAI,GAAG,IAAI,CAAC;IAEtC,CAAC,MAAM;MACL,OACE,KAAK,GACL,IAAI,CAACO,UAAU,CAAC,CAAC,GACjB,GAAG,GACH,IAAI,CAACH,SAAS,CAAC,CAAC,GAChB,GAAG,IACF,IAAI,CAACJ,aAAa,GAAG,IAAI,GAAG,IAAI,CAAC;IAEtC;EACF,CAAC;EACDS,kBAAkB,EAAE,SAAAA,mBAAA,EAAY;IAC9B,IAAIC,WAAW,GAAG;MAChBC,WAAW,EAAE,IAAI,CAACH,cAAc,CAAC;IACnC,CAAC;IACD,IAAI,IAAI,CAACX,YAAY,EAAE;MACrB,OAAOX,MAAM,CAACwB,WAAW,EAAE;QACzB,eAAe,EAAE,IAAI,CAACH,UAAU,CAAC,CAAC;QAClC,cAAc,EAAE,IAAI,CAACH,SAAS,CAAC;MACjC,CAAC,CAAC;IACJ;IACA,OAAOM,WAAW;EACpB;AACF,CAAC","ignoreList":[]}