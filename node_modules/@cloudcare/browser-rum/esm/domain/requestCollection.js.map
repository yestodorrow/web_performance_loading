{"version":3,"file":"requestCollection.js","names":["RequestType","initFetchObservable","initXhrObservable","LifeCycleEventType","tryToClone","readBytesFromStream","elapsed","timeStampNow","isAllowedRequestUrl","startTracer","nextRequestIndex","startRequestCollection","lifeCycle","configuration","sessionManager","tracer","trackXhr","trackFetch","subscription","subscribe","rawContext","context","url","state","traceXhr","xhr","requestIndex","getNextRequestIndex","notify","REQUEST_STARTED","clearTracingIfNeeded","REQUEST_COMPLETED","duration","method","spanId","startClocks","status","traceId","traceSampled","type","XHR","stop","unsubscribe","traceFetch","waitForResponseToComplete","responseType","FETCH","response","init","input","result","callback","clonedResponse","body","timeStamp","bytesLimit","Number","POSITIVE_INFINITY","collectStreamBody"],"sources":["../../src/domain/requestCollection.js"],"sourcesContent":["import {\n  RequestType,\n  initFetchObservable,\n  initXhrObservable,\n  LifeCycleEventType,\n  tryToClone,\n  readBytesFromStream,\n  elapsed,\n  timeStampNow\n} from '@cloudcare/browser-core'\nimport { isAllowedRequestUrl } from './rumEventsCollection/resource/resourceUtils'\nimport { startTracer } from './tracing/tracer'\n\nvar nextRequestIndex = 1\n\nexport function startRequestCollection(\n  lifeCycle,\n  configuration,\n  sessionManager\n) {\n  var tracer = startTracer(configuration, sessionManager)\n  trackXhr(lifeCycle, configuration, tracer)\n  trackFetch(lifeCycle, configuration, tracer)\n}\n\nexport function trackXhr(lifeCycle, configuration, tracer) {\n  var subscription = initXhrObservable().subscribe(function (rawContext) {\n    var context = rawContext\n    if (!isAllowedRequestUrl(configuration, context.url)) {\n      return\n    }\n\n    switch (context.state) {\n      case 'start':\n        tracer.traceXhr(context, context.xhr)\n        context.requestIndex = getNextRequestIndex()\n\n        lifeCycle.notify(LifeCycleEventType.REQUEST_STARTED, {\n          requestIndex: context.requestIndex,\n          url: context.url\n        })\n        break\n      case 'complete':\n        tracer.clearTracingIfNeeded(context)\n        lifeCycle.notify(LifeCycleEventType.REQUEST_COMPLETED, {\n          duration: context.duration,\n          method: context.method,\n          requestIndex: context.requestIndex,\n          spanId: context.spanId,\n          startClocks: context.startClocks,\n          status: context.status,\n          traceId: context.traceId,\n          traceSampled: context.traceSampled,\n          type: RequestType.XHR,\n          url: context.url,\n          xhr: context.xhr\n        })\n        break\n    }\n  })\n\n  return {\n    stop: function () {\n      return subscription.unsubscribe()\n    }\n  }\n}\n\nexport function trackFetch(lifeCycle, configuration, tracer) {\n  var subscription = initFetchObservable().subscribe(function (rawContext) {\n    var context = rawContext\n    if (!isAllowedRequestUrl(configuration, context.url)) {\n      return\n    }\n\n    switch (context.state) {\n      case 'start':\n        tracer.traceFetch(context)\n        context.requestIndex = getNextRequestIndex()\n\n        lifeCycle.notify(LifeCycleEventType.REQUEST_STARTED, {\n          requestIndex: context.requestIndex,\n          url: context.url\n        })\n        break\n      case 'resolve':\n        waitForResponseToComplete(context, function (duration) {\n          tracer.clearTracingIfNeeded(context)\n          lifeCycle.notify(LifeCycleEventType.REQUEST_COMPLETED, {\n            duration: duration,\n            method: context.method,\n            requestIndex: context.requestIndex,\n            responseType: context.responseType,\n            spanId: context.spanId,\n            startClocks: context.startClocks,\n            status: context.status,\n            traceId: context.traceId,\n            traceSampled: context.traceSampled,\n            type: RequestType.FETCH,\n            url: context.url,\n            response: context.response,\n            init: context.init,\n            input: context.input\n          })\n        })\n        break\n    }\n  })\n  return {\n    stop: function () {\n      return subscription.unsubscribe()\n    }\n  }\n}\n\nfunction getNextRequestIndex() {\n  var result = nextRequestIndex\n  nextRequestIndex += 1\n  return result\n}\n\nfunction waitForResponseToComplete(context, callback) {\n  var clonedResponse = context.response && tryToClone(context.response)\n  if (!clonedResponse || !clonedResponse.body) {\n    // do not try to wait for the response if the clone failed, fetch error or null body\n    callback(elapsed(context.startClocks.timeStamp, timeStampNow()))\n  } else {\n    readBytesFromStream(\n      clonedResponse.body,\n      function () {\n        callback(elapsed(context.startClocks.timeStamp, timeStampNow()))\n      },\n      {\n        bytesLimit: Number.POSITIVE_INFINITY,\n        collectStreamBody: false\n      }\n    )\n  }\n}\n"],"mappings":"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","ignoreList":[]}