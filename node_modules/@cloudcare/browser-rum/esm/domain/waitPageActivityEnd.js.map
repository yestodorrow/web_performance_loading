{"version":3,"file":"waitPageActivityEnd.js","names":["Observable","each","timeStampNow","LifeCycleEventType","some","matchList","instrumentMethodAndCallOriginal","setTimeout","clearTimeout","PAGE_ACTIVITY_VALIDATION_DELAY","PAGE_ACTIVITY_END_DELAY","waitPageActivityEnd","lifeCycle","domMutationObservable","configuration","pageActivityEndCallback","maxDuration","pageActivityObservable","createPageActivityObservable","doWaitPageActivityEnd","pageActivityEndTimeoutId","hasCompleted","validationTimeoutId","complete","hadActivity","maxDurationTimeoutId","undefined","end","pageActivitySubscription","subscribe","data","isBusy","lastChangeTime","stop","unsubscribe","event","observable","subscriptions","firstRequestIndex","pendingRequestsCount","push","notifyPageActivity","PERFORMANCE_ENTRIES_COLLECTED","entries","entry","entryType","isExcludedUrl","name","REQUEST_STARTED","startEvent","url","requestIndex","REQUEST_COMPLETED","request","_trackWindowOpen","trackWindowOpen","stopTrackingWindowOpen","s","notify","requestUrl","excludedActivityUrls","callback","window","before"],"sources":["../../src/domain/waitPageActivityEnd.js"],"sourcesContent":["import {\n  Observable,\n  each,\n  timeStampNow,\n  LifeCycleEventType,\n  some,\n  matchList,\n  instrumentMethodAndCallOriginal,\n  setTimeout,\n  clearTimeout\n} from '@cloudcare/browser-core'\n\n// Delay to wait for a page activity to validate the tracking process\nexport var PAGE_ACTIVITY_VALIDATION_DELAY = 100\n// Delay to wait after a page activity to end the tracking process\nexport var PAGE_ACTIVITY_END_DELAY = 100\n\n/**\n * Wait for the page activity end\n *\n * Detection lifecycle:\n * ```\n *                        Wait page activity end\n *              .-------------------'--------------------.\n *              v                                        v\n *     [Wait for a page activity ]          [Wait for a maximum duration]\n *     [timeout: VALIDATION_DELAY]          [  timeout: maxDuration     ]\n *          /                  \\                           |\n *         v                    v                          |\n *  [No page activity]   [Page activity]                   |\n *         |                   |,----------------------.   |\n *         v                   v                       |   |\n *     (Discard)     [Wait for a page activity]        |   |\n *                   [   timeout: END_DELAY   ]        |   |\n *                       /                \\            |   |\n *                      v                  v           |   |\n *             [No page activity]    [Page activity]   |   |\n *                      |                 |            |   |\n *                      |                 '------------'   |\n *                      '-----------. ,--------------------'\n *                                   v\n *                                 (End)\n * ```\n *\n * Note: by assuming that maxDuration is greater than VALIDATION_DELAY, we are sure that if the\n * process is still alive after maxDuration, it has been validated.\n */\nexport function waitPageActivityEnd(\n  lifeCycle,\n  domMutationObservable,\n  configuration,\n  pageActivityEndCallback,\n  maxDuration\n) {\n  var pageActivityObservable = createPageActivityObservable(\n    lifeCycle,\n    domMutationObservable,\n    configuration\n  )\n  return doWaitPageActivityEnd(\n    pageActivityObservable,\n    pageActivityEndCallback,\n    maxDuration\n  )\n}\n\nexport function doWaitPageActivityEnd(\n  pageActivityObservable,\n  pageActivityEndCallback,\n  maxDuration\n) {\n  var pageActivityEndTimeoutId\n  var hasCompleted = false\n\n  var validationTimeoutId = setTimeout(function () {\n    complete({ hadActivity: false })\n  }, PAGE_ACTIVITY_VALIDATION_DELAY)\n\n  var maxDurationTimeoutId =\n    maxDuration !== undefined\n      ? setTimeout(function () {\n          return complete({ hadActivity: true, end: timeStampNow() })\n        }, maxDuration)\n      : undefined\n\n  var pageActivitySubscription = pageActivityObservable.subscribe(function (\n    data\n  ) {\n    var isBusy = data.isBusy\n    clearTimeout(validationTimeoutId)\n    clearTimeout(pageActivityEndTimeoutId)\n    var lastChangeTime = timeStampNow()\n    if (!isBusy) {\n      pageActivityEndTimeoutId = setTimeout(function () {\n        complete({ hadActivity: true, end: lastChangeTime })\n      }, PAGE_ACTIVITY_END_DELAY)\n    }\n  })\n\n  var stop = function () {\n    hasCompleted = true\n    clearTimeout(validationTimeoutId)\n    clearTimeout(pageActivityEndTimeoutId)\n    clearTimeout(maxDurationTimeoutId)\n    pageActivitySubscription.unsubscribe()\n  }\n\n  function complete(event) {\n    if (hasCompleted) {\n      return\n    }\n    stop()\n    pageActivityEndCallback(event)\n  }\n  return { stop: stop }\n}\n\nexport function createPageActivityObservable(\n  lifeCycle,\n  domMutationObservable,\n  configuration\n) {\n  return new Observable(function (observable) {\n    var subscriptions = []\n    var firstRequestIndex\n    var pendingRequestsCount = 0\n\n    subscriptions.push(\n      domMutationObservable.subscribe(notifyPageActivity),\n      lifeCycle.subscribe(\n        LifeCycleEventType.PERFORMANCE_ENTRIES_COLLECTED,\n        function (entries) {\n          if (\n            some(entries, function (entry) {\n              return (\n                entry.entryType === 'resource' &&\n                !isExcludedUrl(configuration, entry.name)\n              )\n            })\n          ) {\n            notifyPageActivity()\n          }\n        }\n      ),\n      lifeCycle.subscribe(\n        LifeCycleEventType.REQUEST_STARTED,\n        function (startEvent) {\n          if (isExcludedUrl(configuration, startEvent.url)) {\n            return\n          }\n\n          if (firstRequestIndex === undefined) {\n            firstRequestIndex = startEvent.requestIndex\n          }\n          pendingRequestsCount += 1\n          notifyPageActivity()\n        }\n      ),\n      lifeCycle.subscribe(\n        LifeCycleEventType.REQUEST_COMPLETED,\n        function (request) {\n          if (\n            isExcludedUrl(configuration, request.url) ||\n            firstRequestIndex === undefined ||\n            // If the request started before the tracking start, ignore it\n            request.requestIndex < firstRequestIndex\n          ) {\n            return\n          }\n          pendingRequestsCount -= 1\n          notifyPageActivity()\n        }\n      )\n    )\n\n    var _trackWindowOpen = trackWindowOpen(notifyPageActivity)\n    var stopTrackingWindowOpen = _trackWindowOpen.stop\n    return function () {\n      stopTrackingWindowOpen()\n      each(subscriptions, function (s) {\n        s.unsubscribe()\n      })\n    }\n\n    function notifyPageActivity() {\n      observable.notify({ isBusy: pendingRequestsCount > 0 })\n    }\n  })\n}\n\nfunction isExcludedUrl(configuration, requestUrl) {\n  return matchList(configuration.excludedActivityUrls, requestUrl)\n}\n\nfunction trackWindowOpen(callback) {\n  return instrumentMethodAndCallOriginal(window, 'open', { before: callback })\n}\n"],"mappings":"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","ignoreList":[]}