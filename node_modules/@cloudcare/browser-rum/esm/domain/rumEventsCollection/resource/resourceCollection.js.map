{"version":3,"file":"resourceCollection.js","names":["getStatusGroup","UUID","extend2Lev","relativeToClocks","urlParse","getQueryParamsFromUrl","replaceNumberCharByPath","RequestType","ResourceType","RumEventType","LifeCycleEventType","toServerDuration","some","isNullUndefinedDefaultValue","matchRequestTiming","computePerformanceResourceDetails","computePerformanceResourceDuration","computeResourceKind","computeSize","isRequestKind","is304","isCacheHit","isResourceUrlLimit","isLongDataUrl","sanitizeDataUrl","PageState","startResourceCollection","lifeCycle","configuration","sessionManager","pageStateHistory","subscribe","REQUEST_COMPLETED","request","rawEvent","processRequest","notify","RAW_RUM_EVENT_COLLECTED","PERFORMANCE_ENTRIES_COLLECTED","entries","i","length","entry","entryType","name","resourceUrlLimit","processResourceEntry","matchingTiming","startClocks","startTime","shouldIndex","shouldIndexResource","tracingInfo","computeRequestTracingInfo","type","XHR","FETCH","correspondingTimingOverrides","computePerformanceEntryMetrics","undefined","duration","computeRequestDuration","pageStateInfo","computePageStateInfo","urlObj","url","getParse","resourceEvent","date","timeStamp","resource","id","method","status","statusGroup","urlHost","Host","urlPath","Path","urlPathGroup","urlQuery","RESOURCE","relative","rawRumEvent","domainContext","performanceEntry","xhr","response","requestInput","input","requestInit","init","error","computeEntryTracingInfo","entryMetrics","statusCode","responseStatus","resourceStart","findTrackedSession","timing","hasBeenTraced","traceSampled","traceId","spanId","_gc","page_states","findAll","page_was_discarded","String","document","wasDiscarded","requestCrosseds","requestCrossedFrozenState","pageState","state","FROZEN"],"sources":["../../../../src/domain/rumEventsCollection/resource/resourceCollection.js"],"sourcesContent":["import {\n  getStatusGroup,\n  UUID,\n  extend2Lev,\n  relativeToClocks,\n  urlParse,\n  getQueryParamsFromUrl,\n  replaceNumberCharByPath,\n  RequestType,\n  ResourceType,\n  RumEventType,\n  LifeCycleEventType,\n  toServerDuration,\n  some,\n  isNullUndefinedDefaultValue\n} from '@cloudcare/browser-core'\nimport { matchRequestTiming } from './matchRequestTiming'\nimport {\n  computePerformanceResourceDetails,\n  computePerformanceResourceDuration,\n  computeResourceKind,\n  computeSize,\n  isRequestKind,\n  is304,\n  isCacheHit,\n  isResourceUrlLimit,\n  isLongDataUrl,\n  sanitizeDataUrl\n} from './resourceUtils'\nimport { PageState } from '../../contexts/pageStateHistory.js'\nexport function startResourceCollection(\n  lifeCycle,\n  configuration,\n  sessionManager,\n  pageStateHistory\n) {\n  lifeCycle.subscribe(LifeCycleEventType.REQUEST_COMPLETED, function (request) {\n    var rawEvent = processRequest(\n      request,\n      configuration,\n      sessionManager,\n      pageStateHistory\n    )\n    if (rawEvent) {\n      lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, rawEvent)\n    }\n  })\n\n  lifeCycle.subscribe(\n    LifeCycleEventType.PERFORMANCE_ENTRIES_COLLECTED,\n    function (entries) {\n      for (var i = 0; i < entries.length; i++) {\n        var entry = entries[i]\n        if (\n          entry.entryType === 'resource' &&\n          !isRequestKind(entry) &&\n          !isResourceUrlLimit(entry.name, configuration.resourceUrlLimit)\n        ) {\n          var rawEvent = processResourceEntry(\n            entry,\n            configuration,\n            sessionManager,\n            pageStateHistory\n          )\n          if (rawEvent) {\n            lifeCycle.notify(\n              LifeCycleEventType.RAW_RUM_EVENT_COLLECTED,\n              rawEvent\n            )\n          }\n        }\n      }\n    }\n  )\n}\n\nfunction processRequest(\n  request,\n  configuration,\n  sessionManager,\n  pageStateHistory\n) {\n  var matchingTiming = matchRequestTiming(request)\n  var startClocks = matchingTiming\n    ? relativeToClocks(matchingTiming.startTime)\n    : request.startClocks\n  var shouldIndex = shouldIndexResource(\n    configuration,\n    sessionManager,\n    startClocks\n  )\n  var tracingInfo = computeRequestTracingInfo(request)\n  if (!shouldIndex && !tracingInfo) {\n    return\n  }\n  var type =\n    request.type === RequestType.XHR ? ResourceType.XHR : ResourceType.FETCH\n  var correspondingTimingOverrides = matchingTiming\n    ? computePerformanceEntryMetrics(matchingTiming)\n    : undefined\n\n  var duration = computeRequestDuration(\n    pageStateHistory,\n    startClocks,\n    request.duration\n  )\n  var pageStateInfo = computePageStateInfo(\n    pageStateHistory,\n    startClocks,\n    isNullUndefinedDefaultValue(\n      matchingTiming && matchingTiming.duration,\n      request.duration\n    )\n  )\n  var urlObj = urlParse(request.url).getParse()\n  var resourceEvent = extend2Lev(\n    {\n      date: startClocks.timeStamp,\n      resource: {\n        id: UUID,\n        type: type,\n        duration: duration,\n        method: request.method,\n        status: request.status,\n        statusGroup: getStatusGroup(request.status),\n        url: isLongDataUrl(request.url)\n          ? sanitizeDataUrl(request.url)\n          : request.url,\n        urlHost: urlObj.Host,\n        urlPath: urlObj.Path,\n        urlPathGroup: replaceNumberCharByPath(urlObj.Path),\n        urlQuery: getQueryParamsFromUrl(request.url)\n      },\n      type: RumEventType.RESOURCE\n    },\n    tracingInfo,\n    correspondingTimingOverrides,\n    pageStateInfo\n  )\n  return {\n    startTime: startClocks.relative,\n    rawRumEvent: resourceEvent,\n    domainContext: {\n      performanceEntry: matchingTiming,\n      xhr: request.xhr,\n      response: request.response,\n      requestInput: request.input,\n      requestInit: request.init,\n      error: request.error\n    }\n  }\n}\n\nfunction processResourceEntry(\n  entry,\n  configuration,\n  sessionManager,\n  pageStateHistory\n) {\n  var startClocks = relativeToClocks(entry.startTime)\n  var shouldIndex = shouldIndexResource(\n    configuration,\n    sessionManager,\n    startClocks\n  )\n  var tracingInfo = computeEntryTracingInfo(entry)\n  if (!shouldIndex && !tracingInfo) {\n    return\n  }\n  var type = computeResourceKind(entry)\n  var entryMetrics = computePerformanceEntryMetrics(entry)\n  var urlObj = urlParse(entry.name).getParse()\n  var statusCode = ''\n  if (entry.responseStatus !== 0) {\n    statusCode = entry.responseStatus\n  } else if (is304(entry)) {\n    statusCode = 304\n  } else if (isCacheHit(entry)) {\n    statusCode = 200\n  }\n  var pageStateInfo = computePageStateInfo(\n    pageStateHistory,\n    startClocks,\n    entry.duration\n  )\n\n  var resourceEvent = extend2Lev(\n    {\n      date: startClocks.timeStamp,\n      resource: {\n        id: UUID(),\n        type: type,\n        url: entry.name,\n        urlHost: urlObj.Host,\n        urlPath: urlObj.Path,\n        urlPathGroup: replaceNumberCharByPath(urlObj.Path),\n        urlQuery: getQueryParamsFromUrl(entry.name),\n        method: 'GET',\n        status: statusCode,\n        statusGroup: getStatusGroup(statusCode)\n      },\n      type: RumEventType.RESOURCE\n    },\n    tracingInfo,\n    entryMetrics,\n    pageStateInfo\n  )\n  return {\n    startTime: startClocks.relative,\n    rawRumEvent: resourceEvent,\n    domainContext: {\n      performanceEntry: entry\n    }\n  }\n}\nfunction shouldIndexResource(configuration, sessionManager, resourceStart) {\n  return sessionManager.findTrackedSession(resourceStart.relative)\n}\n\nfunction computePerformanceEntryMetrics(timing) {\n  return {\n    resource: extend2Lev(\n      {},\n      {\n        duration: computePerformanceResourceDuration(timing)\n      },\n      computeSize(timing),\n      computePerformanceResourceDetails(timing)\n    )\n  }\n}\n\nfunction computeRequestTracingInfo(request) {\n  var hasBeenTraced = request.traceSampled && request.traceId && request.spanId\n  if (!hasBeenTraced) {\n    return undefined\n  }\n  return {\n    _gc: {\n      spanId: request.spanId,\n      traceId: request.traceId\n    },\n    resource: { id: UUID() }\n  }\n}\nfunction computePageStateInfo(pageStateHistory, startClocks, duration) {\n  return {\n    _gc: {\n      page_states: pageStateHistory.findAll(startClocks.relative, duration),\n      page_was_discarded: String(document.wasDiscarded)\n    }\n  }\n}\nfunction computeRequestDuration(pageStateHistory, startClocks, duration) {\n  const requestCrosseds = pageStateHistory.findAll(\n    startClocks.relative,\n    duration\n  )\n  var requestCrossedFrozenState\n  if (requestCrosseds) {\n    requestCrossedFrozenState = some(requestCrosseds, function (pageState) {\n      return pageState.state === PageState.FROZEN\n    })\n  }\n  return !requestCrossedFrozenState ? toServerDuration(duration) : undefined\n}\nfunction computeEntryTracingInfo(entry) {\n  return entry.traceId ? { _gc: { traceId: entry.traceId } } : undefined\n}\n"],"mappings":"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","ignoreList":[]}