{"version":3,"file":"viewCollection.js","names":["isEmptyObject","mapValues","toServerDuration","isNumber","RumEventType","LifeCycleEventType","extend2Lev","findByPath","trackViews","startViewCollection","lifeCycle","configuration","location","domMutationObservable","locationChangeObservable","pageStateHistory","recorderApi","initialViewOptions","subscribe","VIEW_UPDATED","view","notify","RAW_RUM_EVENT_COLLECTED","processViewUpdate","trackViewsManually","computePerformanceViewDetails","navigationTimings","undefined","fetchStart","responseEnd","domInteractive","domContentLoaded","domComplete","loadEventEnd","loadEventStart","domContentLoadedEventEnd","details","fpt","apdexLevel","parseInt","tti","dom_ready","load","resource_load_time","dom","replayStats","getReplayStats","id","pageStates","findAll","startClocks","relative","duration","viewEvent","_gc","document_version","documentVersion","replay_stats","page_states","date","timeStamp","type","VIEW","action","count","eventCounts","actionCount","frustration","frustrationCount","cumulative_layout_shift","commonViewMetrics","cumulative_layout_shift_target_selector","first_byte","initialViewMetrics","dom_complete","dom_content_loaded","dom_interactive","error","errorCount","first_contentful_paint","first_input_delay","first_input_time","first_input_target_selector","interaction_to_next_paint","interaction_to_next_paint_target_selector","is_active","isActive","name","largest_contentful_paint","largest_contentful_paint_element_selector","load_event","loading_time","discardNegativeDuration","loadingTime","loading_type","loadingType","long_task","longTaskCount","resource","resourceCount","time_spent","display","scroll","max_depth","maxDepth","max_depth_scroll_top","maxDepthScrollTop","max_scroll_height","maxScrollHeight","max_scroll_height_time","maxScrollHeightTime","session","has_replay","sessionIsActive","privacy","replay_level","defaultPrivacyLevel","customTimings","custom_timings","rawRumEvent","startTime","domainContext"],"sources":["../../../../src/domain/rumEventsCollection/view/viewCollection.js"],"sourcesContent":["import {\n  isEmptyObject,\n  mapValues,\n  toServerDuration,\n  isNumber,\n  RumEventType,\n  LifeCycleEventType,\n  extend2Lev,\n  findByPath\n} from '@cloudcare/browser-core'\nimport { trackViews } from './trackViews'\nexport function startViewCollection(\n  lifeCycle,\n  configuration,\n  location,\n  domMutationObservable,\n  locationChangeObservable,\n  pageStateHistory,\n  recorderApi,\n  initialViewOptions\n) {\n  lifeCycle.subscribe(LifeCycleEventType.VIEW_UPDATED, function (view) {\n    lifeCycle.notify(\n      LifeCycleEventType.RAW_RUM_EVENT_COLLECTED,\n      processViewUpdate(view, configuration, recorderApi, pageStateHistory)\n    )\n  })\n\n  return trackViews(\n    location,\n    lifeCycle,\n    domMutationObservable,\n    configuration,\n    locationChangeObservable,\n    !configuration.trackViewsManually,\n    initialViewOptions\n  )\n}\nfunction computePerformanceViewDetails(navigationTimings) {\n  if (!navigationTimings) {\n    return undefined\n  }\n  var fetchStart = navigationTimings.fetchStart,\n    responseEnd = navigationTimings.responseEnd,\n    domInteractive = navigationTimings.domInteractive,\n    domContentLoaded = navigationTimings.domContentLoaded,\n    domComplete = navigationTimings.domComplete,\n    loadEventEnd = navigationTimings.loadEventEnd,\n    loadEventStart = navigationTimings.loadEventStart,\n    domContentLoadedEventEnd = navigationTimings.domContentLoadedEventEnd\n  var details = {}\n  if (\n    isNumber(responseEnd) &&\n    isNumber(fetchStart) &&\n    responseEnd !== fetchStart\n  ) {\n    details.fpt = toServerDuration(responseEnd - fetchStart)\n    var apdexLevel = parseInt((responseEnd - fetchStart) / 1000) // 秒数取整\n    details.apdexLevel = apdexLevel > 9 ? 9 : apdexLevel\n  }\n  if (\n    isNumber(domInteractive) &&\n    isNumber(fetchStart) &&\n    domInteractive !== fetchStart\n  ) {\n    details.tti = toServerDuration(domInteractive - fetchStart)\n  }\n  if (\n    isNumber(domContentLoaded) &&\n    isNumber(fetchStart) &&\n    domContentLoaded !== fetchStart\n  ) {\n    details.dom_ready = toServerDuration(domContentLoaded - fetchStart)\n  }\n  // Make sure a connection occurred\n  if (\n    isNumber(loadEventEnd) &&\n    isNumber(fetchStart) &&\n    loadEventEnd !== fetchStart\n  ) {\n    details.load = toServerDuration(loadEventEnd - fetchStart)\n  }\n  if (\n    isNumber(loadEventStart) &&\n    isNumber(domContentLoadedEventEnd) &&\n    loadEventStart !== domContentLoadedEventEnd\n  ) {\n    details.resource_load_time = toServerDuration(\n      loadEventStart - domContentLoadedEventEnd\n    )\n  }\n  if (\n    isNumber(domComplete) &&\n    isNumber(domInteractive) &&\n    domComplete !== domInteractive\n  ) {\n    details.dom = toServerDuration(domComplete - domInteractive)\n  }\n  return details\n}\n\nfunction processViewUpdate(view, configuration, recorderApi, pageStateHistory) {\n  var replayStats = recorderApi.getReplayStats(view.id)\n  var pageStates = pageStateHistory.findAll(\n    view.startClocks.relative,\n    view.duration\n  )\n  var viewEvent = {\n    _gc: {\n      document_version: view.documentVersion,\n      replay_stats: replayStats,\n      page_states: pageStates\n    },\n    date: view.startClocks.timeStamp,\n    type: RumEventType.VIEW,\n    view: {\n      action: {\n        count: view.eventCounts.actionCount\n      },\n      frustration: {\n        count: view.eventCounts.frustrationCount\n      },\n      cumulative_layout_shift: findByPath(\n        view.commonViewMetrics,\n        'cumulativeLayoutShift.value'\n      ),\n      cumulative_layout_shift_target_selector: findByPath(\n        view.commonViewMetrics,\n        'cumulativeLayoutShift.targetSelector'\n      ),\n      first_byte: toServerDuration(\n        findByPath(view.initialViewMetrics, 'navigationTimings.firstByte')\n      ),\n      dom_complete: toServerDuration(\n        findByPath(view.initialViewMetrics, 'navigationTimings.domComplete')\n      ),\n      dom_content_loaded: toServerDuration(\n        findByPath(\n          view.initialViewMetrics,\n          'navigationTimings.domContentLoaded'\n        )\n      ),\n      dom_interactive: toServerDuration(\n        findByPath(view.initialViewMetrics, 'navigationTimings.domInteractive')\n      ),\n      error: {\n        count: view.eventCounts.errorCount\n      },\n      first_contentful_paint: toServerDuration(\n        findByPath(view.initialViewMetrics, 'firstContentfulPaint')\n      ),\n      first_input_delay: toServerDuration(\n        findByPath(view.initialViewMetrics, 'firstInput.delay')\n      ),\n      first_input_time: toServerDuration(\n        findByPath(view.initialViewMetrics, 'firstInput.time')\n      ),\n      first_input_target_selector: findByPath(\n        view.initialViewMetrics,\n        'firstInput.targetSelector'\n      ),\n      interaction_to_next_paint: toServerDuration(\n        findByPath(view.commonViewMetrics, 'interactionToNextPaint.value')\n      ),\n      interaction_to_next_paint_target_selector: findByPath(\n        view.commonViewMetrics,\n        'interactionToNextPaint.targetSelector'\n      ),\n      is_active: view.isActive,\n      name: view.name,\n      largest_contentful_paint: toServerDuration(\n        findByPath(view.initialViewMetrics, 'largestContentfulPaint.value')\n      ),\n      largest_contentful_paint_element_selector: findByPath(\n        view.initialViewMetrics,\n        'largestContentfulPaint.targetSelector'\n      ),\n      load_event: toServerDuration(\n        findByPath(view.initialViewMetrics, 'navigationTimings.loadEvent')\n      ),\n      loading_time: discardNegativeDuration(\n        toServerDuration(view.commonViewMetrics.loadingTime)\n      ),\n      loading_type: view.loadingType,\n      long_task: {\n        count: view.eventCounts.longTaskCount\n      },\n      resource: {\n        count: view.eventCounts.resourceCount\n      },\n      time_spent: toServerDuration(view.duration)\n    },\n    display: view.commonViewMetrics.scroll\n      ? {\n          scroll: {\n            max_depth: view.commonViewMetrics.scroll.maxDepth,\n            max_depth_scroll_top:\n              view.commonViewMetrics.scroll.maxDepthScrollTop,\n            max_scroll_height: view.commonViewMetrics.scroll.maxScrollHeight,\n            max_scroll_height_time: toServerDuration(\n              view.commonViewMetrics.scroll.maxScrollHeightTime\n            )\n          }\n        }\n      : undefined,\n    session: {\n      has_replay: replayStats ? true : undefined,\n      is_active: view.sessionIsActive ? undefined : false\n    },\n    privacy: {\n      replay_level: configuration.defaultPrivacyLevel\n    }\n  }\n  if (!isEmptyObject(view.customTimings)) {\n    viewEvent.view.custom_timings = mapValues(\n      view.customTimings,\n      toServerDuration\n    )\n  }\n  viewEvent = extend2Lev(viewEvent, {\n    view: computePerformanceViewDetails(\n      view.initialViewMetrics.navigationTimings\n    )\n  })\n  return {\n    rawRumEvent: viewEvent,\n    startTime: view.startClocks.relative,\n    domainContext: {\n      location: view.location\n    }\n  }\n}\n\nfunction discardNegativeDuration(duration) {\n  return isNumber(duration) && duration < 0 ? undefined : duration\n}\n"],"mappings":"AAAA,SACEA,aAAa,EACbC,SAAS,EACTC,gBAAgB,EAChBC,QAAQ,EACRC,YAAY,EACZC,kBAAkB,EAClBC,UAAU,EACVC,UAAU,QACL,yBAAyB;AAChC,SAASC,UAAU,QAAQ,cAAc;AACzC,OAAO,SAASC,mBAAmBA,CACjCC,SAAS,EACTC,aAAa,EACbC,QAAQ,EACRC,qBAAqB,EACrBC,wBAAwB,EACxBC,gBAAgB,EAChBC,WAAW,EACXC,kBAAkB,EAClB;EACAP,SAAS,CAACQ,SAAS,CAACb,kBAAkB,CAACc,YAAY,EAAE,UAAUC,IAAI,EAAE;IACnEV,SAAS,CAACW,MAAM,CACdhB,kBAAkB,CAACiB,uBAAuB,EAC1CC,iBAAiB,CAACH,IAAI,EAAET,aAAa,EAAEK,WAAW,EAAED,gBAAgB,CACtE,CAAC;EACH,CAAC,CAAC;EAEF,OAAOP,UAAU,CACfI,QAAQ,EACRF,SAAS,EACTG,qBAAqB,EACrBF,aAAa,EACbG,wBAAwB,EACxB,CAACH,aAAa,CAACa,kBAAkB,EACjCP,kBACF,CAAC;AACH;AACA,SAASQ,6BAA6BA,CAACC,iBAAiB,EAAE;EACxD,IAAI,CAACA,iBAAiB,EAAE;IACtB,OAAOC,SAAS;EAClB;EACA,IAAIC,UAAU,GAAGF,iBAAiB,CAACE,UAAU;IAC3CC,WAAW,GAAGH,iBAAiB,CAACG,WAAW;IAC3CC,cAAc,GAAGJ,iBAAiB,CAACI,cAAc;IACjDC,gBAAgB,GAAGL,iBAAiB,CAACK,gBAAgB;IACrDC,WAAW,GAAGN,iBAAiB,CAACM,WAAW;IAC3CC,YAAY,GAAGP,iBAAiB,CAACO,YAAY;IAC7CC,cAAc,GAAGR,iBAAiB,CAACQ,cAAc;IACjDC,wBAAwB,GAAGT,iBAAiB,CAACS,wBAAwB;EACvE,IAAIC,OAAO,GAAG,CAAC,CAAC;EAChB,IACEjC,QAAQ,CAAC0B,WAAW,CAAC,IACrB1B,QAAQ,CAACyB,UAAU,CAAC,IACpBC,WAAW,KAAKD,UAAU,EAC1B;IACAQ,OAAO,CAACC,GAAG,GAAGnC,gBAAgB,CAAC2B,WAAW,GAAGD,UAAU,CAAC;IACxD,IAAIU,UAAU,GAAGC,QAAQ,CAAC,CAACV,WAAW,GAAGD,UAAU,IAAI,IAAI,CAAC,EAAC;IAC7DQ,OAAO,CAACE,UAAU,GAAGA,UAAU,GAAG,CAAC,GAAG,CAAC,GAAGA,UAAU;EACtD;EACA,IACEnC,QAAQ,CAAC2B,cAAc,CAAC,IACxB3B,QAAQ,CAACyB,UAAU,CAAC,IACpBE,cAAc,KAAKF,UAAU,EAC7B;IACAQ,OAAO,CAACI,GAAG,GAAGtC,gBAAgB,CAAC4B,cAAc,GAAGF,UAAU,CAAC;EAC7D;EACA,IACEzB,QAAQ,CAAC4B,gBAAgB,CAAC,IAC1B5B,QAAQ,CAACyB,UAAU,CAAC,IACpBG,gBAAgB,KAAKH,UAAU,EAC/B;IACAQ,OAAO,CAACK,SAAS,GAAGvC,gBAAgB,CAAC6B,gBAAgB,GAAGH,UAAU,CAAC;EACrE;EACA;EACA,IACEzB,QAAQ,CAAC8B,YAAY,CAAC,IACtB9B,QAAQ,CAACyB,UAAU,CAAC,IACpBK,YAAY,KAAKL,UAAU,EAC3B;IACAQ,OAAO,CAACM,IAAI,GAAGxC,gBAAgB,CAAC+B,YAAY,GAAGL,UAAU,CAAC;EAC5D;EACA,IACEzB,QAAQ,CAAC+B,cAAc,CAAC,IACxB/B,QAAQ,CAACgC,wBAAwB,CAAC,IAClCD,cAAc,KAAKC,wBAAwB,EAC3C;IACAC,OAAO,CAACO,kBAAkB,GAAGzC,gBAAgB,CAC3CgC,cAAc,GAAGC,wBACnB,CAAC;EACH;EACA,IACEhC,QAAQ,CAAC6B,WAAW,CAAC,IACrB7B,QAAQ,CAAC2B,cAAc,CAAC,IACxBE,WAAW,KAAKF,cAAc,EAC9B;IACAM,OAAO,CAACQ,GAAG,GAAG1C,gBAAgB,CAAC8B,WAAW,GAAGF,cAAc,CAAC;EAC9D;EACA,OAAOM,OAAO;AAChB;AAEA,SAASb,iBAAiBA,CAACH,IAAI,EAAET,aAAa,EAAEK,WAAW,EAAED,gBAAgB,EAAE;EAC7E,IAAI8B,WAAW,GAAG7B,WAAW,CAAC8B,cAAc,CAAC1B,IAAI,CAAC2B,EAAE,CAAC;EACrD,IAAIC,UAAU,GAAGjC,gBAAgB,CAACkC,OAAO,CACvC7B,IAAI,CAAC8B,WAAW,CAACC,QAAQ,EACzB/B,IAAI,CAACgC,QACP,CAAC;EACD,IAAIC,SAAS,GAAG;IACdC,GAAG,EAAE;MACHC,gBAAgB,EAAEnC,IAAI,CAACoC,eAAe;MACtCC,YAAY,EAAEZ,WAAW;MACzBa,WAAW,EAAEV;IACf,CAAC;IACDW,IAAI,EAAEvC,IAAI,CAAC8B,WAAW,CAACU,SAAS;IAChCC,IAAI,EAAEzD,YAAY,CAAC0D,IAAI;IACvB1C,IAAI,EAAE;MACJ2C,MAAM,EAAE;QACNC,KAAK,EAAE5C,IAAI,CAAC6C,WAAW,CAACC;MAC1B,CAAC;MACDC,WAAW,EAAE;QACXH,KAAK,EAAE5C,IAAI,CAAC6C,WAAW,CAACG;MAC1B,CAAC;MACDC,uBAAuB,EAAE9D,UAAU,CACjCa,IAAI,CAACkD,iBAAiB,EACtB,6BACF,CAAC;MACDC,uCAAuC,EAAEhE,UAAU,CACjDa,IAAI,CAACkD,iBAAiB,EACtB,sCACF,CAAC;MACDE,UAAU,EAAEtE,gBAAgB,CAC1BK,UAAU,CAACa,IAAI,CAACqD,kBAAkB,EAAE,6BAA6B,CACnE,CAAC;MACDC,YAAY,EAAExE,gBAAgB,CAC5BK,UAAU,CAACa,IAAI,CAACqD,kBAAkB,EAAE,+BAA+B,CACrE,CAAC;MACDE,kBAAkB,EAAEzE,gBAAgB,CAClCK,UAAU,CACRa,IAAI,CAACqD,kBAAkB,EACvB,oCACF,CACF,CAAC;MACDG,eAAe,EAAE1E,gBAAgB,CAC/BK,UAAU,CAACa,IAAI,CAACqD,kBAAkB,EAAE,kCAAkC,CACxE,CAAC;MACDI,KAAK,EAAE;QACLb,KAAK,EAAE5C,IAAI,CAAC6C,WAAW,CAACa;MAC1B,CAAC;MACDC,sBAAsB,EAAE7E,gBAAgB,CACtCK,UAAU,CAACa,IAAI,CAACqD,kBAAkB,EAAE,sBAAsB,CAC5D,CAAC;MACDO,iBAAiB,EAAE9E,gBAAgB,CACjCK,UAAU,CAACa,IAAI,CAACqD,kBAAkB,EAAE,kBAAkB,CACxD,CAAC;MACDQ,gBAAgB,EAAE/E,gBAAgB,CAChCK,UAAU,CAACa,IAAI,CAACqD,kBAAkB,EAAE,iBAAiB,CACvD,CAAC;MACDS,2BAA2B,EAAE3E,UAAU,CACrCa,IAAI,CAACqD,kBAAkB,EACvB,2BACF,CAAC;MACDU,yBAAyB,EAAEjF,gBAAgB,CACzCK,UAAU,CAACa,IAAI,CAACkD,iBAAiB,EAAE,8BAA8B,CACnE,CAAC;MACDc,yCAAyC,EAAE7E,UAAU,CACnDa,IAAI,CAACkD,iBAAiB,EACtB,uCACF,CAAC;MACDe,SAAS,EAAEjE,IAAI,CAACkE,QAAQ;MACxBC,IAAI,EAAEnE,IAAI,CAACmE,IAAI;MACfC,wBAAwB,EAAEtF,gBAAgB,CACxCK,UAAU,CAACa,IAAI,CAACqD,kBAAkB,EAAE,8BAA8B,CACpE,CAAC;MACDgB,yCAAyC,EAAElF,UAAU,CACnDa,IAAI,CAACqD,kBAAkB,EACvB,uCACF,CAAC;MACDiB,UAAU,EAAExF,gBAAgB,CAC1BK,UAAU,CAACa,IAAI,CAACqD,kBAAkB,EAAE,6BAA6B,CACnE,CAAC;MACDkB,YAAY,EAAEC,uBAAuB,CACnC1F,gBAAgB,CAACkB,IAAI,CAACkD,iBAAiB,CAACuB,WAAW,CACrD,CAAC;MACDC,YAAY,EAAE1E,IAAI,CAAC2E,WAAW;MAC9BC,SAAS,EAAE;QACThC,KAAK,EAAE5C,IAAI,CAAC6C,WAAW,CAACgC;MAC1B,CAAC;MACDC,QAAQ,EAAE;QACRlC,KAAK,EAAE5C,IAAI,CAAC6C,WAAW,CAACkC;MAC1B,CAAC;MACDC,UAAU,EAAElG,gBAAgB,CAACkB,IAAI,CAACgC,QAAQ;IAC5C,CAAC;IACDiD,OAAO,EAAEjF,IAAI,CAACkD,iBAAiB,CAACgC,MAAM,GAClC;MACEA,MAAM,EAAE;QACNC,SAAS,EAAEnF,IAAI,CAACkD,iBAAiB,CAACgC,MAAM,CAACE,QAAQ;QACjDC,oBAAoB,EAClBrF,IAAI,CAACkD,iBAAiB,CAACgC,MAAM,CAACI,iBAAiB;QACjDC,iBAAiB,EAAEvF,IAAI,CAACkD,iBAAiB,CAACgC,MAAM,CAACM,eAAe;QAChEC,sBAAsB,EAAE3G,gBAAgB,CACtCkB,IAAI,CAACkD,iBAAiB,CAACgC,MAAM,CAACQ,mBAChC;MACF;IACF,CAAC,GACDnF,SAAS;IACboF,OAAO,EAAE;MACPC,UAAU,EAAEnE,WAAW,GAAG,IAAI,GAAGlB,SAAS;MAC1C0D,SAAS,EAAEjE,IAAI,CAAC6F,eAAe,GAAGtF,SAAS,GAAG;IAChD,CAAC;IACDuF,OAAO,EAAE;MACPC,YAAY,EAAExG,aAAa,CAACyG;IAC9B;EACF,CAAC;EACD,IAAI,CAACpH,aAAa,CAACoB,IAAI,CAACiG,aAAa,CAAC,EAAE;IACtChE,SAAS,CAACjC,IAAI,CAACkG,cAAc,GAAGrH,SAAS,CACvCmB,IAAI,CAACiG,aAAa,EAClBnH,gBACF,CAAC;EACH;EACAmD,SAAS,GAAG/C,UAAU,CAAC+C,SAAS,EAAE;IAChCjC,IAAI,EAAEK,6BAA6B,CACjCL,IAAI,CAACqD,kBAAkB,CAAC/C,iBAC1B;EACF,CAAC,CAAC;EACF,OAAO;IACL6F,WAAW,EAAElE,SAAS;IACtBmE,SAAS,EAAEpG,IAAI,CAAC8B,WAAW,CAACC,QAAQ;IACpCsE,aAAa,EAAE;MACb7G,QAAQ,EAAEQ,IAAI,CAACR;IACjB;EACF,CAAC;AACH;AAEA,SAASgF,uBAAuBA,CAACxC,QAAQ,EAAE;EACzC,OAAOjD,QAAQ,CAACiD,QAAQ,CAAC,IAAIA,QAAQ,GAAG,CAAC,GAAGzB,SAAS,GAAGyB,QAAQ;AAClE","ignoreList":[]}