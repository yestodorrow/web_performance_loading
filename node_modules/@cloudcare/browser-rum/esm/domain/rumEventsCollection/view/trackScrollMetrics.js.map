{"version":3,"file":"trackScrollMetrics.js","names":["ONE_SECOND","elapsed","relativeNow","throttle","addEventListener","DOM_EVENT","getScrollY","monitor","Observable","getViewportDimension","THROTTLE_SCROLL_DURATION","trackScrollMetrics","configuration","viewStart","callback","scrollValues","undefined","createScrollValuesObservable","maxScrollDepth","maxScrollHeight","maxScrollHeightTime","subscription","subscribe","data","scrollDepth","scrollTop","scrollHeight","shouldUpdate","now","relative","maxDepth","Math","min","maxDepthScrollTop","stop","unsubscribe","computeScrollValues","viewport","height","round","document","scrollingElement","documentElement","throttleDuration","observable","notify","window","ResizeObserver","throttledNotify","leading","trailing","observerTarget","resizeObserver","throttled","observe","eventListener","SCROLL","passive","cancel","unobserve"],"sources":["../../../../src/domain/rumEventsCollection/view/trackScrollMetrics.js"],"sourcesContent":["import {\n  ONE_SECOND,\n  elapsed,\n  relativeNow,\n  throttle,\n  addEventListener,\n  DOM_EVENT,\n  getScrollY,\n  monitor,\n  Observable\n} from '@cloudcare/browser-core'\nimport { getViewportDimension } from '../../initViewportObservable'\n\n/** Arbitrary scroll throttle duration */\nexport var THROTTLE_SCROLL_DURATION = ONE_SECOND\n\nexport function trackScrollMetrics(\n  configuration,\n  viewStart,\n  callback,\n  scrollValues\n) {\n  if (scrollValues === undefined) {\n    scrollValues = createScrollValuesObservable(configuration)\n  }\n  var maxScrollDepth = 0\n  var maxScrollHeight = 0\n  var maxScrollHeightTime = 0\n  var subscription = scrollValues.subscribe(function (data) {\n    var scrollDepth = data.scrollDepth\n    var scrollTop = data.scrollTop\n    var scrollHeight = data.scrollHeight\n    var shouldUpdate = false\n\n    if (scrollDepth > maxScrollDepth) {\n      maxScrollDepth = scrollDepth\n      shouldUpdate = true\n    }\n\n    if (scrollHeight > maxScrollHeight) {\n      maxScrollHeight = scrollHeight\n      var now = relativeNow()\n      maxScrollHeightTime = elapsed(viewStart.relative, now)\n      shouldUpdate = true\n    }\n\n    if (shouldUpdate) {\n      callback({\n        maxDepth: Math.min(maxScrollDepth, maxScrollHeight),\n        maxDepthScrollTop: scrollTop,\n        maxScrollHeight: maxScrollHeight,\n        maxScrollHeightTime: maxScrollHeightTime\n      })\n    }\n  })\n\n  return {\n    stop: function () {\n      return subscription.unsubscribe()\n    }\n  }\n}\n\nexport function computeScrollValues() {\n  var scrollTop = getScrollY()\n\n  var viewport = getViewportDimension()\n  var height = viewport.height\n  var scrollHeight = Math.round(\n    (document.scrollingElement || document.documentElement).scrollHeight\n  )\n  var scrollDepth = Math.round(height + scrollTop)\n\n  return {\n    scrollHeight: scrollHeight,\n    scrollDepth: scrollDepth,\n    scrollTop: scrollTop\n  }\n}\nexport function createScrollValuesObservable(configuration, throttleDuration) {\n  if (throttleDuration === undefined) {\n    throttleDuration = THROTTLE_SCROLL_DURATION\n  }\n  return new Observable(function (observable) {\n    function notify() {\n      observable.notify(computeScrollValues())\n    }\n\n    if (window.ResizeObserver) {\n      var throttledNotify = throttle(notify, throttleDuration, {\n        leading: false,\n        trailing: true\n      })\n\n      var observerTarget = document.scrollingElement || document.documentElement\n      var resizeObserver = new ResizeObserver(\n        monitor(throttledNotify.throttled)\n      )\n      resizeObserver.observe(observerTarget)\n      var eventListener = addEventListener(\n        window,\n        DOM_EVENT.SCROLL,\n        throttledNotify.throttled,\n        {\n          passive: true\n        }\n      )\n\n      return function () {\n        throttledNotify.cancel()\n        resizeObserver.unobserve(observerTarget)\n        eventListener.stop()\n      }\n    }\n  })\n}\n"],"mappings":"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","ignoreList":[]}