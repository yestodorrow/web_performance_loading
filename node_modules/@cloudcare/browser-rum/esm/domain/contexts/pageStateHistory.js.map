{"version":3,"file":"pageStateHistory.js","names":["elapsed","ContextHistory","SESSION_TIME_OUT_DELAY","toServerDuration","addEventListeners","relativeNow","DOM_EVENT","MAX_PAGE_STATE_ENTRIES","MAX_PAGE_STATE_ENTRIES_SELECTABLE","PAGE_STATE_CONTEXT_TIME_OUT_DELAY","PageState","ACTIVE","PASSIVE","HIDDEN","FROZEN","TERMINATED","startPageStateHistory","maxPageStateEntriesSelectable","undefined","pageStateHistory","currentPageState","addPageState","getPageState","_addEventListeners","window","PAGE_SHOW","FOCUS","BLUR","VISIBILITY_CHANGE","RESUME","FREEZE","PAGE_HIDE","event","computePageState","timeStamp","capture","stopEventListeners","stop","nextPageState","startTime","closeActive","add","state","findAll","eventStartTime","duration","pageStateEntries","length","pageStateServerEntries","limit","Math","max","index","pageState","relativeStartTime","push","start","isInActivePageStateAt","pageStateEntry","find","type","persisted","document","visibilityState","hasFocus"],"sources":["../../../src/domain/contexts/pageStateHistory.js"],"sourcesContent":["import {\n  elapsed,\n  ContextHistory,\n  SESSION_TIME_OUT_DELAY,\n  toServerDuration,\n  addEventListeners,\n  relativeNow,\n  DOM_EVENT\n} from '@cloudcare/browser-core'\n\n// Arbitrary value to cap number of element for memory consumption in the browser\nexport var MAX_PAGE_STATE_ENTRIES = 4000\n// Arbitrary value to cap number of element for backend & to save bandwidth\nexport var MAX_PAGE_STATE_ENTRIES_SELECTABLE = 500\n\nexport var PAGE_STATE_CONTEXT_TIME_OUT_DELAY = SESSION_TIME_OUT_DELAY\n\nexport var PageState = {\n  ACTIVE: 'active',\n  PASSIVE: 'passive',\n  HIDDEN: 'hidden',\n  FROZEN: 'frozen',\n  TERMINATED: 'terminated'\n}\n\nexport function startPageStateHistory(maxPageStateEntriesSelectable) {\n  if (maxPageStateEntriesSelectable === undefined) {\n    maxPageStateEntriesSelectable = MAX_PAGE_STATE_ENTRIES_SELECTABLE\n  }\n  var pageStateHistory = new ContextHistory(\n    PAGE_STATE_CONTEXT_TIME_OUT_DELAY,\n    MAX_PAGE_STATE_ENTRIES\n  )\n\n  var currentPageState\n  addPageState(getPageState(), relativeNow())\n\n  var _addEventListeners = addEventListeners(\n    window,\n    [\n      DOM_EVENT.PAGE_SHOW,\n      DOM_EVENT.FOCUS,\n      DOM_EVENT.BLUR,\n      DOM_EVENT.VISIBILITY_CHANGE,\n      DOM_EVENT.RESUME,\n      DOM_EVENT.FREEZE,\n      DOM_EVENT.PAGE_HIDE\n    ],\n    function (event) {\n      // Only get events fired by the browser to avoid false currentPageState changes done with custom events\n      addPageState(computePageState(event), event.timeStamp)\n    },\n    { capture: true }\n  )\n  var stopEventListeners = _addEventListeners.stop\n\n  function addPageState(nextPageState, startTime) {\n    if (startTime === undefined) {\n      startTime = relativeNow()\n    }\n    if (nextPageState === currentPageState) {\n      return\n    }\n\n    currentPageState = nextPageState\n    pageStateHistory.closeActive(startTime)\n    pageStateHistory.add(\n      { state: currentPageState, startTime: startTime },\n      startTime\n    )\n  }\n\n  return {\n    findAll: function (eventStartTime, duration) {\n      var pageStateEntries = pageStateHistory.findAll(eventStartTime, duration)\n\n      if (pageStateEntries.length === 0) {\n        return\n      }\n\n      var pageStateServerEntries = []\n      // limit the number of entries to return\n      var limit = Math.max(\n        0,\n        pageStateEntries.length - maxPageStateEntriesSelectable\n      )\n\n      // loop page state entries backward to return the selected ones in desc order\n      for (var index = pageStateEntries.length - 1; index >= limit; index--) {\n        var pageState = pageStateEntries[index]\n        // compute the start time relative to the event start time (ex: to be relative to the view start time)\n        var relativeStartTime = elapsed(eventStartTime, pageState.startTime)\n\n        pageStateServerEntries.push({\n          state: pageState.state,\n          start: toServerDuration(relativeStartTime)\n        })\n      }\n\n      return pageStateServerEntries\n    },\n    isInActivePageStateAt: function (startTime) {\n      var pageStateEntry = pageStateHistory.find(startTime)\n      return (\n        pageStateEntry !== undefined &&\n        pageStateEntry.state === PageState.ACTIVE\n      )\n    },\n    addPageState: addPageState,\n    stop: function () {\n      stopEventListeners()\n      pageStateHistory.stop()\n    }\n  }\n}\n\nfunction computePageState(event) {\n  if (event.type === DOM_EVENT.FREEZE) {\n    return PageState.FROZEN\n  } else if (event.type === DOM_EVENT.PAGE_HIDE) {\n    return event.persisted ? PageState.FROZEN : PageState.TERMINATED\n  }\n  return getPageState()\n}\n\nfunction getPageState() {\n  if (document.visibilityState === 'hidden') {\n    return PageState.HIDDEN\n  }\n\n  if (document.hasFocus()) {\n    return PageState.ACTIVE\n  }\n\n  return PageState.PASSIVE\n}\n"],"mappings":"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","ignoreList":[]}