{"version":3,"file":"urlContexts.js","names":["LifeCycleEventType","SESSION_TIME_OUT_DELAY","relativeNow","ContextHistory","replaceNumberCharByPath","getQueryParamsFromUrl","isHashAnAnchor","getPathFromHash","URL_CONTEXT_TIME_OUT_DELAY","startUrlContexts","lifeCycle","locationChangeObservable","location","urlContextHistory","previousViewUrl","subscribe","BEFORE_VIEW_CREATED","data","viewUrl","href","add","buildUrlContext","url","referrer","document","startClocks","relative","AFTER_VIEW_ENDED","closeActive","endClocks","locationChangeSubscription","current","find","changeTime","newLocation","path","pathname","hash","host","pathGroup","urlQuery","findUrl","startTime","stop","unsubscribe"],"sources":["../../../src/domain/contexts/urlContexts.js"],"sourcesContent":["import {\n  LifeCycleEventType,\n  SESSION_TIME_OUT_DELAY,\n  relativeNow,\n  ContextHistory,\n  replaceNumberCharByPath,\n  getQueryParamsFromUrl,\n  isHashAnAnchor,\n  getPathFromHash\n} from '@cloudcare/browser-core'\n\n/**\n * We want to attach to an event:\n * - the url corresponding to its start\n * - the referrer corresponding to the previous view url (or document referrer for initial view)\n */\n\nexport var URL_CONTEXT_TIME_OUT_DELAY = SESSION_TIME_OUT_DELAY\n\nexport function startUrlContexts(\n  lifeCycle,\n  locationChangeObservable,\n  location\n) {\n  var urlContextHistory = new ContextHistory(URL_CONTEXT_TIME_OUT_DELAY)\n\n  var previousViewUrl\n\n  lifeCycle.subscribe(LifeCycleEventType.BEFORE_VIEW_CREATED, function (data) {\n    var viewUrl = location.href\n    urlContextHistory.add(\n      buildUrlContext({\n        url: viewUrl,\n        location: location,\n        referrer: !previousViewUrl ? document.referrer : previousViewUrl\n      }),\n      data.startClocks.relative\n    )\n    previousViewUrl = viewUrl\n  })\n  lifeCycle.subscribe(LifeCycleEventType.AFTER_VIEW_ENDED, function (data) {\n    urlContextHistory.closeActive(data.endClocks.relative)\n  })\n  var locationChangeSubscription = locationChangeObservable.subscribe(function (\n    data\n  ) {\n    var current = urlContextHistory.find()\n    if (current) {\n      var changeTime = relativeNow()\n      urlContextHistory.closeActive(changeTime)\n      urlContextHistory.add(\n        buildUrlContext({\n          url: data.newLocation.href,\n          location: data.newLocation,\n          referrer: current.referrer\n        }),\n        changeTime\n      )\n    }\n  })\n\n  function buildUrlContext(data) {\n    var path = data.location.pathname\n    var hash = data.location.hash\n    if (hash && !isHashAnAnchor(hash)) {\n      path = '/' + getPathFromHash(hash)\n    }\n    return {\n      url: data.url,\n      referrer: data.referrer,\n      host: data.location.host,\n      path: path,\n      pathGroup: replaceNumberCharByPath(path),\n      urlQuery: getQueryParamsFromUrl(data.location.href)\n    }\n  }\n\n  return {\n    findUrl: function (startTime) {\n      return urlContextHistory.find(startTime)\n    },\n    stop: function () {\n      locationChangeSubscription.unsubscribe()\n      urlContextHistory.stop()\n    }\n  }\n}\n"],"mappings":"AAAA,SACEA,kBAAkB,EAClBC,sBAAsB,EACtBC,WAAW,EACXC,cAAc,EACdC,uBAAuB,EACvBC,qBAAqB,EACrBC,cAAc,EACdC,eAAe,QACV,yBAAyB;;AAEhC;AACA;AACA;AACA;AACA;;AAEA,OAAO,IAAIC,0BAA0B,GAAGP,sBAAsB;AAE9D,OAAO,SAASQ,gBAAgBA,CAC9BC,SAAS,EACTC,wBAAwB,EACxBC,QAAQ,EACR;EACA,IAAIC,iBAAiB,GAAG,IAAIV,cAAc,CAACK,0BAA0B,CAAC;EAEtE,IAAIM,eAAe;EAEnBJ,SAAS,CAACK,SAAS,CAACf,kBAAkB,CAACgB,mBAAmB,EAAE,UAAUC,IAAI,EAAE;IAC1E,IAAIC,OAAO,GAAGN,QAAQ,CAACO,IAAI;IAC3BN,iBAAiB,CAACO,GAAG,CACnBC,eAAe,CAAC;MACdC,GAAG,EAAEJ,OAAO;MACZN,QAAQ,EAAEA,QAAQ;MAClBW,QAAQ,EAAE,CAACT,eAAe,GAAGU,QAAQ,CAACD,QAAQ,GAAGT;IACnD,CAAC,CAAC,EACFG,IAAI,CAACQ,WAAW,CAACC,QACnB,CAAC;IACDZ,eAAe,GAAGI,OAAO;EAC3B,CAAC,CAAC;EACFR,SAAS,CAACK,SAAS,CAACf,kBAAkB,CAAC2B,gBAAgB,EAAE,UAAUV,IAAI,EAAE;IACvEJ,iBAAiB,CAACe,WAAW,CAACX,IAAI,CAACY,SAAS,CAACH,QAAQ,CAAC;EACxD,CAAC,CAAC;EACF,IAAII,0BAA0B,GAAGnB,wBAAwB,CAACI,SAAS,CAAC,UAClEE,IAAI,EACJ;IACA,IAAIc,OAAO,GAAGlB,iBAAiB,CAACmB,IAAI,CAAC,CAAC;IACtC,IAAID,OAAO,EAAE;MACX,IAAIE,UAAU,GAAG/B,WAAW,CAAC,CAAC;MAC9BW,iBAAiB,CAACe,WAAW,CAACK,UAAU,CAAC;MACzCpB,iBAAiB,CAACO,GAAG,CACnBC,eAAe,CAAC;QACdC,GAAG,EAAEL,IAAI,CAACiB,WAAW,CAACf,IAAI;QAC1BP,QAAQ,EAAEK,IAAI,CAACiB,WAAW;QAC1BX,QAAQ,EAAEQ,OAAO,CAACR;MACpB,CAAC,CAAC,EACFU,UACF,CAAC;IACH;EACF,CAAC,CAAC;EAEF,SAASZ,eAAeA,CAACJ,IAAI,EAAE;IAC7B,IAAIkB,IAAI,GAAGlB,IAAI,CAACL,QAAQ,CAACwB,QAAQ;IACjC,IAAIC,IAAI,GAAGpB,IAAI,CAACL,QAAQ,CAACyB,IAAI;IAC7B,IAAIA,IAAI,IAAI,CAAC/B,cAAc,CAAC+B,IAAI,CAAC,EAAE;MACjCF,IAAI,GAAG,GAAG,GAAG5B,eAAe,CAAC8B,IAAI,CAAC;IACpC;IACA,OAAO;MACLf,GAAG,EAAEL,IAAI,CAACK,GAAG;MACbC,QAAQ,EAAEN,IAAI,CAACM,QAAQ;MACvBe,IAAI,EAAErB,IAAI,CAACL,QAAQ,CAAC0B,IAAI;MACxBH,IAAI,EAAEA,IAAI;MACVI,SAAS,EAAEnC,uBAAuB,CAAC+B,IAAI,CAAC;MACxCK,QAAQ,EAAEnC,qBAAqB,CAACY,IAAI,CAACL,QAAQ,CAACO,IAAI;IACpD,CAAC;EACH;EAEA,OAAO;IACLsB,OAAO,EAAE,SAAAA,QAAUC,SAAS,EAAE;MAC5B,OAAO7B,iBAAiB,CAACmB,IAAI,CAACU,SAAS,CAAC;IAC1C,CAAC;IACDC,IAAI,EAAE,SAAAA,KAAA,EAAY;MAChBb,0BAA0B,CAACc,WAAW,CAAC,CAAC;MACxC/B,iBAAiB,CAAC8B,IAAI,CAAC,CAAC;IAC1B;EACF,CAAC;AACH","ignoreList":[]}