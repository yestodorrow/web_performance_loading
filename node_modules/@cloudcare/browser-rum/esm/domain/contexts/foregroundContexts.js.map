{"version":3,"file":"foregroundContexts.js","names":["addDuration","addEventListener","DOM_EVENT","elapsed","relativeNow","toServerDuration","MAX_NUMBER_OF_SELECTABLE_FOREGROUND_PERIODS","MAX_NUMBER_OF_STORED_FOREGROUND_PERIODS","foregroundPeriods","startForegroundContexts","document","hasFocus","addNewForegroundPeriod","foregroundTracking","trackFocus","blurTracking","trackBlur","closeForegroundPeriod","isInForegroundAt","selectInForegroundPeriodsFor","stop","length","currentForegroundPeriod","now","undefined","end","push","start","onFocusChange","window","FOCUS","event","isTrusted","onBlurChange","BLUR","startTime","i","foregroundPeriod","eventStartTime","duration","eventEndTime","filteredForegroundPeriods","earliestIndex","Math","max","startDuration","endTime","endDuration","unshift"],"sources":["../../../src/domain/contexts/foregroundContexts.js"],"sourcesContent":["import {\n  addDuration,\n  addEventListener,\n  DOM_EVENT,\n  elapsed,\n  relativeNow,\n  toServerDuration\n} from '@cloudcare/browser-core'\n\n// Arbitrary value to cap number of element mostly for backend & to save bandwidth\nexport var MAX_NUMBER_OF_SELECTABLE_FOREGROUND_PERIODS = 500\n// Arbitrary value to cap number of element mostly for memory consumption in the browser\nexport var MAX_NUMBER_OF_STORED_FOREGROUND_PERIODS = 2500\n\nvar foregroundPeriods = []\n\nexport function startForegroundContexts() {\n  if (document.hasFocus()) {\n    addNewForegroundPeriod()\n  }\n\n  var foregroundTracking = trackFocus(addNewForegroundPeriod)\n  var blurTracking = trackBlur(closeForegroundPeriod)\n  return {\n    isInForegroundAt: isInForegroundAt,\n    selectInForegroundPeriodsFor: selectInForegroundPeriodsFor,\n    stop: function () {\n      foregroundPeriods = []\n      foregroundTracking.stop()\n      blurTracking.stop()\n    }\n  }\n}\n\nexport function addNewForegroundPeriod() {\n  if (foregroundPeriods.length > MAX_NUMBER_OF_STORED_FOREGROUND_PERIODS) {\n    return\n  }\n  var currentForegroundPeriod = foregroundPeriods[foregroundPeriods.length - 1]\n  var now = relativeNow()\n  if (\n    currentForegroundPeriod !== undefined &&\n    currentForegroundPeriod.end === undefined\n  ) {\n    return\n  }\n  foregroundPeriods.push({\n    start: now\n  })\n}\n\nexport function closeForegroundPeriod() {\n  if (foregroundPeriods.length === 0) {\n    return\n  }\n  var currentForegroundPeriod = foregroundPeriods[foregroundPeriods.length - 1]\n  var now = relativeNow()\n  if (currentForegroundPeriod.end !== undefined) {\n    return\n  }\n  currentForegroundPeriod.end = now\n}\n\nfunction trackFocus(onFocusChange) {\n  return addEventListener(window, DOM_EVENT.FOCUS, function (event) {\n    if (!event.isTrusted) {\n      return\n    }\n    onFocusChange()\n  })\n}\n\nfunction trackBlur(onBlurChange) {\n  return addEventListener(window, DOM_EVENT.BLUR, function (event) {\n    if (!event.isTrusted) {\n      return\n    }\n    onBlurChange()\n  })\n}\n\nfunction isInForegroundAt(startTime) {\n  for (var i = foregroundPeriods.length - 1; i >= 0; i--) {\n    var foregroundPeriod = foregroundPeriods[i]\n    if (\n      foregroundPeriod.end !== undefined &&\n      startTime > foregroundPeriod.end\n    ) {\n      break\n    }\n    if (\n      startTime > foregroundPeriod.start &&\n      (foregroundPeriod.end === undefined || startTime < foregroundPeriod.end)\n    ) {\n      return true\n    }\n  }\n  return false\n}\n\nfunction selectInForegroundPeriodsFor(eventStartTime, duration) {\n  var eventEndTime = addDuration(eventStartTime, duration)\n  var filteredForegroundPeriods = []\n\n  var earliestIndex = Math.max(\n    0,\n    foregroundPeriods.length - MAX_NUMBER_OF_SELECTABLE_FOREGROUND_PERIODS\n  )\n  for (var i = foregroundPeriods.length - 1; i >= earliestIndex; i--) {\n    var foregroundPeriod = foregroundPeriods[i]\n    if (\n      foregroundPeriod.end !== undefined &&\n      eventStartTime > foregroundPeriod.end\n    ) {\n      // event starts after the end of the current focus period\n      // since the array is sorted, we can stop looking for foreground periods\n      break\n    }\n    if (eventEndTime < foregroundPeriod.start) {\n      // event ends before the start of the current focus period\n      // continue to previous one\n      continue\n    }\n    var startTime =\n      eventStartTime > foregroundPeriod.start\n        ? eventStartTime\n        : foregroundPeriod.start\n    var startDuration = elapsed(eventStartTime, startTime)\n    var endTime =\n      foregroundPeriod.end === undefined || eventEndTime < foregroundPeriod.end\n        ? eventEndTime\n        : foregroundPeriod.end\n    var endDuration = elapsed(startTime, endTime)\n    filteredForegroundPeriods.unshift({\n      start: toServerDuration(startDuration),\n      duration: toServerDuration(endDuration)\n    })\n  }\n  return filteredForegroundPeriods\n}\n"],"mappings":"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","ignoreList":[]}