{"version":3,"file":"assembly.js","names":["extend2Lev","withSnakeCaseKeys","timeStampNow","isEmptyObject","LifeCycleEventType","RumEventType","deviceInfo","currentDrift","createEventRateLimiter","limitModification","display","assign","round","SessionType","SYNTHETICS","USER","VIEW_MODIFIABLE_FIELD_PATHS","USER_CUSTOMIZABLE_FIELD_PATHS","context","modifiableFieldPathsByEvent","startRumAssembly","configuration","lifeCycle","sessionManager","userSessionManager","viewContexts","urlContexts","actionContexts","displayContext","buildCommonContext","reportError","VIEW","ERROR","RESOURCE","ACTION","LONG_TASK","eventRateLimiters","eventRateLimiterThreshold","subscribe","RAW_RUM_EVENT_COLLECTED","data","startTime","rawRumEvent","savedCommonContext","customerContext","domainContext","viewContext","findView","urlContext","findUrl","session","findTrackedSession","type","undefined","actionId","findActionId","actionIds","findAllActionId","commonContext","rumContext","_gc","sdkName","sdkVersion","drift","session_sample_rate","sessionSampleRate","session_replay_sample_rate","sessionReplaySampleRate","terminal","application","id","applicationId","device","env","service","version","source","date","user","getId","is_signin","is_login","getSessionType","view","name","url","referrer","host","path","pathGroup","urlQuery","action","needToAssembleWithAction","ids","get","rumEvent","serverRumEvent","has_replay","hasReplay","sampled_for_replay","sessionReplayAllowed","shouldSend","beforeSend","notify","RUM_EVENT_COLLECTED","event","result","warn","rateLimitReached","isLimitReached","indexOf","window","_DATAFLUX_SYNTHETICS_BROWSER"],"sources":["../../src/domain/assembly.js"],"sourcesContent":["import {\n  extend2Lev,\n  withSnakeCaseKeys,\n  timeStampNow,\n  isEmptyObject,\n  LifeCycleEventType,\n  RumEventType,\n  deviceInfo,\n  currentDrift,\n  createEventRateLimiter,\n  limitModification,\n  display,\n  assign,\n  round\n} from '@cloudcare/browser-core'\nvar SessionType = {\n  SYNTHETICS: 'synthetics',\n  USER: 'user'\n}\n\nvar VIEW_MODIFIABLE_FIELD_PATHS = {\n  'view.url': 'string',\n  'view.referrer': 'string'\n}\n\nvar USER_CUSTOMIZABLE_FIELD_PATHS = {\n  context: 'object'\n}\n\nvar modifiableFieldPathsByEvent = {}\nexport function startRumAssembly(\n  configuration,\n  lifeCycle,\n  sessionManager,\n  userSessionManager,\n  viewContexts,\n  urlContexts,\n  actionContexts,\n  displayContext,\n  buildCommonContext,\n  reportError\n) {\n  modifiableFieldPathsByEvent[RumEventType.VIEW] = VIEW_MODIFIABLE_FIELD_PATHS\n  modifiableFieldPathsByEvent[RumEventType.ERROR] = assign(\n    {\n      'error.message': 'string',\n      'error.stack': 'string',\n      'error.resource.url': 'string'\n    },\n    USER_CUSTOMIZABLE_FIELD_PATHS,\n    VIEW_MODIFIABLE_FIELD_PATHS\n  )\n  modifiableFieldPathsByEvent[RumEventType.RESOURCE] = assign(\n    {\n      'resource.url': 'string'\n    },\n    USER_CUSTOMIZABLE_FIELD_PATHS,\n    VIEW_MODIFIABLE_FIELD_PATHS\n  )\n  modifiableFieldPathsByEvent[RumEventType.ACTION] = assign(\n    {\n      'action.target.name': 'string'\n    },\n    USER_CUSTOMIZABLE_FIELD_PATHS,\n    VIEW_MODIFIABLE_FIELD_PATHS\n  )\n  modifiableFieldPathsByEvent[RumEventType.LONG_TASK] = assign(\n    {},\n    USER_CUSTOMIZABLE_FIELD_PATHS,\n    VIEW_MODIFIABLE_FIELD_PATHS\n  )\n  var eventRateLimiters = {}\n  eventRateLimiters[RumEventType.ERROR] = createEventRateLimiter(\n    RumEventType.ERROR,\n    configuration.eventRateLimiterThreshold,\n    reportError\n  )\n  eventRateLimiters[RumEventType.ACTION] = createEventRateLimiter(\n    RumEventType.ACTION,\n    configuration.eventRateLimiterThreshold,\n    reportError\n  )\n  lifeCycle.subscribe(\n    LifeCycleEventType.RAW_RUM_EVENT_COLLECTED,\n    function (data) {\n      var startTime = data.startTime\n      var rawRumEvent = data.rawRumEvent\n      var savedCommonContext = data.savedCommonContext\n      var customerContext = data.customerContext\n      var domainContext = data.domainContext\n      var viewContext = viewContexts.findView(startTime)\n      var urlContext = urlContexts.findUrl(startTime)\n      var session = sessionManager.findTrackedSession(\n        rawRumEvent.type !== RumEventType.VIEW ? startTime : undefined\n      )\n\n      if (session && viewContext && urlContext) {\n        var actionId = actionContexts.findActionId(startTime)\n        var actionIds = actionContexts.findAllActionId(startTime)\n        var commonContext = savedCommonContext || buildCommonContext()\n        var rumContext = {\n          _gc: {\n            sdkName: configuration.sdkName,\n            sdkVersion: configuration.sdkVersion,\n            drift: currentDrift(),\n            configuration: {\n              session_sample_rate: round(configuration.sessionSampleRate, 3),\n              session_replay_sample_rate: round(\n                configuration.sessionReplaySampleRate,\n                3\n              )\n            }\n          },\n          terminal: {\n            type: 'web'\n          },\n          application: {\n            id: configuration.applicationId\n          },\n          device: deviceInfo,\n          env: configuration.env || '',\n          service: viewContext.service || configuration.service || 'browser',\n          version: viewContext.version || configuration.version || '',\n          source: 'browser',\n          date: timeStampNow(),\n          user: {\n            id: userSessionManager.getId(),\n            is_signin: 'F',\n            is_login: false\n          },\n          session: {\n            // must be computed on each event because synthetics instrumentation can be done after sdk execution\n            // cf https://github.com/puppeteer/puppeteer/issues/3667\n            type: getSessionType(),\n            id: session.id\n          },\n          view: {\n            id: viewContext.id,\n            name: viewContext.name,\n            url: urlContext.url,\n            referrer: urlContext.referrer,\n            host: urlContext.host,\n            path: urlContext.path,\n            pathGroup: urlContext.pathGroup,\n            urlQuery: urlContext.urlQuery\n          },\n          action:\n            needToAssembleWithAction(rawRumEvent) && actionId\n              ? { id: actionId, ids: actionIds }\n              : undefined,\n          display: displayContext.get()\n        }\n\n        var rumEvent = extend2Lev(rumContext, viewContext, rawRumEvent)\n        var serverRumEvent = withSnakeCaseKeys(rumEvent)\n        var context = extend2Lev({}, commonContext.context, customerContext)\n        if (!isEmptyObject(context)) {\n          serverRumEvent.context = context\n        }\n        if (!('has_replay' in serverRumEvent.session)) {\n          serverRumEvent.session.has_replay = commonContext.hasReplay\n        }\n        if (serverRumEvent.type === 'view') {\n          serverRumEvent.session.sampled_for_replay =\n            session.sessionReplayAllowed\n        }\n        if (!isEmptyObject(commonContext.user)) {\n          // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n          serverRumEvent.user = extend2Lev(\n            {\n              // id: session.getAnonymousID(),\n              is_signin: 'T',\n              is_login: true\n            },\n            commonContext.user\n          )\n        }\n\n        if (\n          shouldSend(\n            serverRumEvent,\n            configuration.beforeSend,\n            domainContext,\n            eventRateLimiters\n          )\n        ) {\n          if (isEmptyObject(serverRumEvent.context)) {\n            delete serverRumEvent.context\n          }\n          lifeCycle.notify(\n            LifeCycleEventType.RUM_EVENT_COLLECTED,\n            serverRumEvent\n          )\n        }\n      }\n    }\n  )\n}\n\nfunction shouldSend(event, beforeSend, domainContext, eventRateLimiters) {\n  if (beforeSend) {\n    var result = limitModification(\n      event,\n      modifiableFieldPathsByEvent[event.type],\n      function (event) {\n        return beforeSend(event, domainContext)\n      }\n    )\n    if (result === false && event.type !== RumEventType.VIEW) {\n      return false\n    }\n    if (result === false) {\n      display.warn(\"Can't dismiss view events using beforeSend!\")\n    }\n  }\n  var rateLimitReached = false\n  if (eventRateLimiters[event.type]) {\n    rateLimitReached = eventRateLimiters[event.type].isLimitReached()\n  }\n  return !rateLimitReached\n}\nfunction needToAssembleWithAction(event) {\n  return (\n    [RumEventType.ERROR, RumEventType.RESOURCE, RumEventType.LONG_TASK].indexOf(\n      event.type\n    ) !== -1\n  )\n}\n\nfunction getSessionType() {\n  return window._DATAFLUX_SYNTHETICS_BROWSER === undefined\n    ? SessionType.USER\n    : SessionType.SYNTHETICS\n}\n"],"mappings":"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","ignoreList":[]}