{"version":3,"file":"recorderApi.js","names":["noop","runOnReadyState","LifeCycleEventType","canUseEventBridge","Observable","relativeNow","PageExitReason","getReplayStats","getReplayStatsImpl","DeflateEncoderStreamId","createDeflateEncoder","startDeflateWorker","DeflateWorkerStatus","getDeflateWorkerStatus","RecorderStatus","Stopped","IntentToStart","Starting","Started","makeRecorderApi","startRecordingImpl","createDeflateWorkerImpl","recorderStartObservable","isBrowserSupported","start","stop","undefined","onRumStart","isRecording","state","status","startStrategy","stopStrategy","viewId","Initialized","lifeCycle","configuration","sessionManager","viewContexts","worker","subscribe","SESSION_EXPIRED","PAGE_EXITED","pageExitEvent","reason","UNLOADING","PAGEHIDE","SESSION_RENEWED","cachedDeflateEncoder","getOrCreateDeflateEncoder","REPLAY","session","findTrackedSession","sessionReplayAllowed","deflateEncoder","recordingImpl","notify","stopRecording","Array","from","CSSSupportsRule","URL","createObjectURL","NodeList","prototype"],"sources":["../../src/boot/recorderApi.js"],"sourcesContent":["import {\n  noop,\n  runOnReadyState,\n  LifeCycleEventType,\n  canUseEventBridge,\n  Observable,\n  relativeNow,\n  PageExitReason\n} from '@cloudcare/browser-core'\n\nimport { getReplayStats as getReplayStatsImpl } from '../domain/replay/replayStats'\nimport {\n  DeflateEncoderStreamId,\n  createDeflateEncoder,\n  startDeflateWorker,\n  DeflateWorkerStatus,\n  getDeflateWorkerStatus\n} from '../domain/replay/deflate'\nvar RecorderStatus = {\n  // The recorder is stopped.\n  Stopped: 0,\n  // The user started the recording while it wasn't possible yet. The recorder should start as soon\n  // as possible.\n  IntentToStart: 1,\n  // The recorder is starting. It does not record anything yet.\n  Starting: 2,\n  // The recorder is started, it records the session.\n  Started: 3\n}\n\nexport function makeRecorderApi(startRecordingImpl, createDeflateWorkerImpl) {\n  var recorderStartObservable = new Observable()\n  if (canUseEventBridge() || !isBrowserSupported()) {\n    return {\n      start: noop,\n      stop: noop,\n      getReplayStats: function () {\n        return undefined\n      },\n      onRumStart: noop,\n      isRecording: function () {\n        return false\n      },\n      recorderStartObservable: recorderStartObservable\n    }\n  }\n\n  var state = {\n    status: RecorderStatus.Stopped\n  }\n\n  var startStrategy = function () {\n    state = { status: RecorderStatus.IntentToStart }\n  }\n  var stopStrategy = function () {\n    state = { status: RecorderStatus.Stopped }\n  }\n  return {\n    start: function () {\n      startStrategy()\n    },\n    stop: function () {\n      stopStrategy()\n    },\n    recorderStartObservable: recorderStartObservable,\n    getReplayStats: function (viewId) {\n      return getDeflateWorkerStatus() === DeflateWorkerStatus.Initialized\n        ? getReplayStatsImpl(viewId)\n        : undefined\n    },\n\n    onRumStart: function (\n      lifeCycle,\n      configuration,\n      sessionManager,\n      viewContexts,\n      worker\n    ) {\n      lifeCycle.subscribe(LifeCycleEventType.SESSION_EXPIRED, function () {\n        if (\n          state.status === RecorderStatus.Starting ||\n          state.status === RecorderStatus.Started\n        ) {\n          stopStrategy()\n          state = { status: RecorderStatus.IntentToStart }\n        }\n      })\n      lifeCycle.subscribe(\n        LifeCycleEventType.PAGE_EXITED,\n        function (pageExitEvent) {\n          if (\n            pageExitEvent.reason === PageExitReason.UNLOADING ||\n            pageExitEvent.reason === PageExitReason.PAGEHIDE\n          ) {\n            stopStrategy()\n          }\n        }\n      )\n      lifeCycle.subscribe(LifeCycleEventType.SESSION_RENEWED, function () {\n        if (state.status === RecorderStatus.IntentToStart) {\n          startStrategy()\n        }\n      })\n      var cachedDeflateEncoder\n      function getOrCreateDeflateEncoder() {\n        if (!cachedDeflateEncoder) {\n          if (!worker) {\n            worker = startDeflateWorker(function () {\n              stopStrategy()\n            }, createDeflateWorkerImpl)\n          }\n          if (worker) {\n            cachedDeflateEncoder = createDeflateEncoder(\n              worker,\n              DeflateEncoderStreamId.REPLAY\n            )\n          }\n        }\n        return cachedDeflateEncoder\n      }\n      startStrategy = function () {\n        var session = sessionManager.findTrackedSession()\n        if (!session || !session.sessionReplayAllowed) {\n          state = { status: RecorderStatus.IntentToStart }\n          return\n        }\n\n        if (\n          state.status === RecorderStatus.Starting ||\n          state.status === RecorderStatus.Started\n        ) {\n          return\n        }\n\n        state = { status: RecorderStatus.Starting }\n\n        runOnReadyState('interactive', function () {\n          if (state.status !== RecorderStatus.Starting) {\n            return\n          }\n          var deflateEncoder = getOrCreateDeflateEncoder()\n          //   var worker = startDeflateWorker(function () {\n          //     stopStrategy()\n          //   }, createDeflateWorkerImpl)\n          if (!deflateEncoder) {\n            state = {\n              status: RecorderStatus.Stopped\n            }\n            return\n          }\n          var recordingImpl = startRecordingImpl(\n            lifeCycle,\n            configuration,\n            sessionManager,\n            viewContexts,\n            deflateEncoder\n          )\n          recorderStartObservable.notify(relativeNow())\n          state = {\n            status: RecorderStatus.Started,\n            stopRecording: recordingImpl.stop\n          }\n        })\n      }\n\n      stopStrategy = function () {\n        if (state.status === RecorderStatus.Stopped) {\n          return\n        }\n\n        if (state.status === RecorderStatus.Started) {\n          state.stopRecording()\n        }\n\n        state = {\n          status: RecorderStatus.Stopped\n        }\n      }\n\n      if (state.status === RecorderStatus.IntentToStart) {\n        startStrategy()\n      }\n    },\n\n    isRecording: function () {\n      return state.status === RecorderStatus.Started\n    }\n  }\n}\n\n/**\n * Test for Browser features used while recording\n */\nfunction isBrowserSupported() {\n  return (\n    // Array.from is a bit less supported by browsers than CSSSupportsRule, but has higher chances\n    // to be polyfilled. Test for both to be more confident. We could add more things if we find out\n    // this test is not sufficient.\n    typeof Array.from === 'function' &&\n    typeof CSSSupportsRule === 'function' &&\n    typeof URL.createObjectURL === 'function' &&\n    'forEach' in NodeList.prototype\n  )\n}\n"],"mappings":"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","ignoreList":[]}