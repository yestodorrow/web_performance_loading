{"version":3,"file":"rum.js","names":["startRumSessionManager","startRumSessionManagerStub","startCacheUsrCache","LifeCycle","LifeCycleEventType","createPageExitObservable","canUseEventBridge","startTelemetry","getEventBridge","TelemetryService","startPerformanceCollection","createDOMMutationObservable","createLocationChangeObservable","startLongTaskCollection","startActionCollection","startRumBatch","startRumEventBridge","startRumAssembly","startDisplayContext","startInternalContext","startUrlContexts","startViewContexts","buildCommonContext","startPageStateHistory","startErrorCollection","startViewCollection","startRequestCollection","startResourceCollection","startRum","configuration","recorderApi","globalContextManager","userContextManager","initialViewOptions","cleanupTasks","lifeCycle","telemetry","startRumTelemetry","setContextProvider","application","id","applicationId","session","findTrackedSession","view","viewContexts","findView","action","actionContexts","findActionId","ids","findAllActionId","reportError","error","notify","RAW_ERROR_COLLECTED","pageExitObservable","subscribe","event","PAGE_EXITED","push","pageExitSubscription","unsubscribe","batch","observable","expireObservable","stop","userSession","domMutationObservable","locationChangeObservable","location","_startRumEventCollection","startRumEventCollection","urlContexts","pageStateHistory","stopRumEventCollection","addAction","_startViewCollection","addTiming","startView","stopViewCollection","_startErrorCollection","addError","internalContext","stopSession","expire","getInternalContext","get","forEach","task","RUM","sessionManager","userSessionManager","_startActionCollection","displayContext"],"sources":["../../src/boot/rum.js"],"sourcesContent":["import {\n  startRumSessionManager,\n  startRumSessionManagerStub\n} from '../domain/rumSessionManager'\nimport { startCacheUsrCache } from '../domain/usr'\nimport {\n  LifeCycle,\n  LifeCycleEventType,\n  createPageExitObservable,\n  canUseEventBridge,\n  startTelemetry,\n  getEventBridge,\n  TelemetryService\n} from '@cloudcare/browser-core'\nimport { startPerformanceCollection } from '../domain/performanceCollection'\nimport { createDOMMutationObservable } from '../domain/domMutationObservable.js'\nimport { createLocationChangeObservable } from '../domain/locationChangeObservable'\nimport { startLongTaskCollection } from '../domain/rumEventsCollection/longTask/longTaskCollection'\nimport { startActionCollection } from '../domain/rumEventsCollection/actions/actionCollection'\nimport { startRumBatch } from '../transport/startRumBatch'\nimport { startRumEventBridge } from '../transport/startRumEventBridge'\nimport { startRumAssembly } from '../domain/assembly'\nimport { startDisplayContext } from '../domain/contexts/displayContext.js'\nimport { startInternalContext } from '../domain/contexts/internalContext'\n// import { startForegroundContexts } from '../domain/contexts/foregroundContexts'\nimport { startUrlContexts } from '../domain/contexts/urlContexts'\nimport { startViewContexts } from '../domain/contexts/viewContexts'\nimport { buildCommonContext } from '../domain/contexts/commonContext'\nimport { startPageStateHistory } from '../domain/contexts/pageStateHistory'\nimport { startErrorCollection } from '../domain/rumEventsCollection/error/errorCollection'\nimport { startViewCollection } from '../domain/rumEventsCollection/view/viewCollection'\nimport { startRequestCollection } from '../domain/requestCollection'\nimport { startResourceCollection } from '../domain/rumEventsCollection/resource/resourceCollection'\n\nexport function startRum(\n  configuration,\n  recorderApi,\n  globalContextManager,\n  userContextManager,\n  initialViewOptions\n) {\n  var cleanupTasks = []\n  var lifeCycle = new LifeCycle()\n  var telemetry = startRumTelemetry(configuration)\n  telemetry.setContextProvider(function () {\n    return {\n      application: {\n        id: configuration.applicationId\n      },\n      session: {\n        id: session.findTrackedSession() && session.findTrackedSession().id\n      },\n      view: {\n        id: viewContexts.findView() && viewContexts.findView().id\n      },\n      action: {\n        id: actionContexts.findActionId(),\n        ids: actionContexts.findAllActionId()\n      }\n    }\n  })\n  var reportError = function (error) {\n    lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, { error: error })\n  }\n  var pageExitObservable = createPageExitObservable()\n  pageExitObservable.subscribe(function (event) {\n    lifeCycle.notify(LifeCycleEventType.PAGE_EXITED, event)\n  })\n  cleanupTasks.push(function () {\n    pageExitSubscription.unsubscribe()\n  })\n  var session = !canUseEventBridge()\n    ? startRumSessionManager(configuration, lifeCycle)\n    : startRumSessionManagerStub()\n  if (!canUseEventBridge()) {\n    var batch = startRumBatch(\n      configuration,\n      lifeCycle,\n      telemetry.observable,\n      reportError,\n      pageExitObservable,\n      session.expireObservable\n    )\n    cleanupTasks.push(function () {\n      batch.stop()\n    })\n  } else {\n    startRumEventBridge(lifeCycle)\n  }\n\n  var userSession = startCacheUsrCache(configuration)\n  var domMutationObservable = createDOMMutationObservable()\n  var locationChangeObservable = createLocationChangeObservable(location)\n  var _startRumEventCollection = startRumEventCollection(\n    lifeCycle,\n    configuration,\n    location,\n    session,\n    userSession,\n    locationChangeObservable,\n    domMutationObservable,\n    function () {\n      return buildCommonContext(\n        globalContextManager,\n        userContextManager,\n        recorderApi\n      )\n    },\n    reportError\n  )\n  var viewContexts = _startRumEventCollection.viewContexts\n  var urlContexts = _startRumEventCollection.urlContexts\n  var actionContexts = _startRumEventCollection.actionContexts\n  var pageStateHistory = _startRumEventCollection.pageStateHistory\n  var stopRumEventCollection = _startRumEventCollection.stop\n  var addAction = _startRumEventCollection.addAction\n\n  cleanupTasks.push(stopRumEventCollection)\n\n  startLongTaskCollection(lifeCycle, session)\n  startResourceCollection(lifeCycle, configuration, session, pageStateHistory)\n\n  var _startViewCollection = startViewCollection(\n    lifeCycle,\n    configuration,\n    location,\n    domMutationObservable,\n    locationChangeObservable,\n    pageStateHistory,\n    recorderApi,\n    initialViewOptions\n  )\n  var addTiming = _startViewCollection.addTiming\n  var startView = _startViewCollection.startView\n  var stopViewCollection = _startViewCollection.stop\n  cleanupTasks.push(stopViewCollection)\n\n  var _startErrorCollection = startErrorCollection(\n    lifeCycle,\n    configuration,\n    pageStateHistory\n  )\n  var addError = _startErrorCollection.addError\n  startRequestCollection(lifeCycle, configuration, session)\n  startPerformanceCollection(lifeCycle, configuration)\n  var internalContext = startInternalContext(\n    configuration.applicationId,\n    session,\n    viewContexts,\n    actionContexts,\n    urlContexts\n  )\n  return {\n    addAction: addAction,\n    addError: addError,\n    addTiming: addTiming,\n    configuration: configuration,\n    lifeCycle: lifeCycle,\n    viewContexts: viewContexts,\n    session: session,\n    startView: startView,\n    stopSession: function () {\n      session.expire()\n    },\n    getInternalContext: internalContext.get,\n    stop: function () {\n      cleanupTasks.forEach(function (task) {\n        task()\n      })\n    }\n  }\n}\nfunction startRumTelemetry(configuration) {\n  const telemetry = startTelemetry(TelemetryService.RUM, configuration)\n  //   if (canUseEventBridge()) {\n  //     const bridge = getEventBridge()\n  //     telemetry.observable.subscribe((event) =>\n  //       bridge.send('internal_telemetry', event)\n  //     )\n  //   }\n  return telemetry\n}\n\nexport function startRumEventCollection(\n  lifeCycle,\n  configuration,\n  location,\n  sessionManager,\n  userSessionManager,\n  locationChangeObservable,\n  domMutationObservable,\n  buildCommonContext,\n  reportError\n) {\n  var viewContexts = startViewContexts(lifeCycle)\n  var urlContexts = startUrlContexts(\n    lifeCycle,\n    locationChangeObservable,\n    location\n  )\n\n  var pageStateHistory = startPageStateHistory()\n  var _startActionCollection = startActionCollection(\n    lifeCycle,\n    domMutationObservable,\n    configuration,\n    pageStateHistory\n  )\n  var actionContexts = _startActionCollection.actionContexts\n  var addAction = _startActionCollection.addAction\n\n  var displayContext = startDisplayContext()\n  startRumAssembly(\n    configuration,\n    lifeCycle,\n    sessionManager,\n    userSessionManager,\n    viewContexts,\n    urlContexts,\n    actionContexts,\n    displayContext,\n    buildCommonContext,\n    reportError\n  )\n  return {\n    viewContexts: viewContexts,\n    urlContexts: urlContexts,\n    pageStateHistory: pageStateHistory,\n    addAction: addAction,\n    actionContexts: actionContexts,\n    stop: function () {\n      viewContexts.stop()\n      urlContexts.stop()\n      pageStateHistory.stop()\n      displayContext.stop()\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}