{"version":3,"file":"startRecording.js","names":["timeStampNow","createHttpRequest","LifeCycleEventType","addTelemetryDebug","record","startSegmentCollection","SEGMENT_BYTES_LIMIT","RecordType","startRecording","lifeCycle","configuration","sessionManager","viewContexts","encoder","httpRequest","reportError","error","notify","RAW_ERROR_COLLECTED","message","replayRequest","sessionReplayEndPoint","segmentCollection","addRecord","stopSegmentCollection","stop","_record","emit","stopRecording","takeSubsequentFullSnapshot","flushMutations","subscribeViewEnded","subscribe","VIEW_ENDED","timestamp","type","ViewEnd","scribeViewCreated","VIEW_CREATED","view","startClocks","timeStamp","unsubscribe"],"sources":["../../src/boot/startRecording.js"],"sourcesContent":["import {\n  timeStampNow,\n  createHttpRequest,\n  LifeCycleEventType,\n  addTelemetryDebug\n} from '@cloudcare/browser-core'\nimport { record } from '../domain/replay/record'\nimport {\n  startSegmentCollection,\n  SEGMENT_BYTES_LIMIT\n} from '../domain/replay/segmentCollection'\nimport { RecordType } from '../types'\n\nexport function startRecording(\n  lifeCycle,\n  configuration,\n  sessionManager,\n  viewContexts,\n  encoder,\n  httpRequest\n) {\n  var reportError = function (error) {\n    lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, { error: error })\n    addTelemetryDebug('Error reported to customer', {\n      'error.message': error.message\n    })\n  }\n\n  var replayRequest =\n    httpRequest ||\n    createHttpRequest(\n      configuration.sessionReplayEndPoint,\n      SEGMENT_BYTES_LIMIT,\n      false,\n      reportError\n    )\n\n  var segmentCollection = startSegmentCollection(\n    lifeCycle,\n    configuration,\n    sessionManager,\n    viewContexts,\n    replayRequest,\n    encoder\n  )\n  var addRecord = segmentCollection.addRecord\n  var stopSegmentCollection = segmentCollection.stop\n\n  var _record = record({\n    emit: addRecord,\n    configuration: configuration,\n    lifeCycle: lifeCycle\n  })\n  var stopRecording = _record.stop\n  var takeSubsequentFullSnapshot = _record.takeSubsequentFullSnapshot\n  var flushMutations = _record.flushMutations\n  var subscribeViewEnded = lifeCycle.subscribe(\n    LifeCycleEventType.VIEW_ENDED,\n    function () {\n      flushMutations()\n      addRecord({\n        timestamp: timeStampNow(),\n        type: RecordType.ViewEnd\n      })\n    }\n  )\n  var scribeViewCreated = lifeCycle.subscribe(\n    LifeCycleEventType.VIEW_CREATED,\n    function (view) {\n      takeSubsequentFullSnapshot(view.startClocks.timeStamp)\n    }\n  )\n\n  return {\n    stop: function () {\n      subscribeViewEnded.unsubscribe()\n      scribeViewCreated.unsubscribe()\n      stopRecording()\n      stopSegmentCollection()\n    }\n  }\n}\n"],"mappings":"AAAA,SACEA,YAAY,EACZC,iBAAiB,EACjBC,kBAAkB,EAClBC,iBAAiB,QACZ,yBAAyB;AAChC,SAASC,MAAM,QAAQ,yBAAyB;AAChD,SACEC,sBAAsB,EACtBC,mBAAmB,QACd,oCAAoC;AAC3C,SAASC,UAAU,QAAQ,UAAU;AAErC,OAAO,SAASC,cAAcA,CAC5BC,SAAS,EACTC,aAAa,EACbC,cAAc,EACdC,YAAY,EACZC,OAAO,EACPC,WAAW,EACX;EACA,IAAIC,WAAW,GAAG,SAAdA,WAAWA,CAAaC,KAAK,EAAE;IACjCP,SAAS,CAACQ,MAAM,CAACf,kBAAkB,CAACgB,mBAAmB,EAAE;MAAEF,KAAK,EAAEA;IAAM,CAAC,CAAC;IAC1Eb,iBAAiB,CAAC,4BAA4B,EAAE;MAC9C,eAAe,EAAEa,KAAK,CAACG;IACzB,CAAC,CAAC;EACJ,CAAC;EAED,IAAIC,aAAa,GACfN,WAAW,IACXb,iBAAiB,CACfS,aAAa,CAACW,qBAAqB,EACnCf,mBAAmB,EACnB,KAAK,EACLS,WACF,CAAC;EAEH,IAAIO,iBAAiB,GAAGjB,sBAAsB,CAC5CI,SAAS,EACTC,aAAa,EACbC,cAAc,EACdC,YAAY,EACZQ,aAAa,EACbP,OACF,CAAC;EACD,IAAIU,SAAS,GAAGD,iBAAiB,CAACC,SAAS;EAC3C,IAAIC,qBAAqB,GAAGF,iBAAiB,CAACG,IAAI;EAElD,IAAIC,OAAO,GAAGtB,MAAM,CAAC;IACnBuB,IAAI,EAAEJ,SAAS;IACfb,aAAa,EAAEA,aAAa;IAC5BD,SAAS,EAAEA;EACb,CAAC,CAAC;EACF,IAAImB,aAAa,GAAGF,OAAO,CAACD,IAAI;EAChC,IAAII,0BAA0B,GAAGH,OAAO,CAACG,0BAA0B;EACnE,IAAIC,cAAc,GAAGJ,OAAO,CAACI,cAAc;EAC3C,IAAIC,kBAAkB,GAAGtB,SAAS,CAACuB,SAAS,CAC1C9B,kBAAkB,CAAC+B,UAAU,EAC7B,YAAY;IACVH,cAAc,CAAC,CAAC;IAChBP,SAAS,CAAC;MACRW,SAAS,EAAElC,YAAY,CAAC,CAAC;MACzBmC,IAAI,EAAE5B,UAAU,CAAC6B;IACnB,CAAC,CAAC;EACJ,CACF,CAAC;EACD,IAAIC,iBAAiB,GAAG5B,SAAS,CAACuB,SAAS,CACzC9B,kBAAkB,CAACoC,YAAY,EAC/B,UAAUC,IAAI,EAAE;IACdV,0BAA0B,CAACU,IAAI,CAACC,WAAW,CAACC,SAAS,CAAC;EACxD,CACF,CAAC;EAED,OAAO;IACLhB,IAAI,EAAE,SAAAA,KAAA,EAAY;MAChBM,kBAAkB,CAACW,WAAW,CAAC,CAAC;MAChCL,iBAAiB,CAACK,WAAW,CAAC,CAAC;MAC/Bd,aAAa,CAAC,CAAC;MACfJ,qBAAqB,CAAC,CAAC;IACzB;EACF,CAAC;AACH","ignoreList":[]}