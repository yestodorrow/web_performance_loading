{"version":3,"file":"startRumBatch.js","names":["Batch","createHttpRequest","LifeCycleEventType","RumEventType","createFlushController","startRumBatch","configuration","lifeCycle","telemetryEventObservable","reportError","pageExitObservable","sessionExpireObservable","batch","makeRumBatch","subscribe","RUM_EVENT_COLLECTED","serverRumEvent","type","VIEW","upsert","view","id","add","event","rumBatch","createRumBatch","rumEndpoint","primaryBatch","primaryFlushController","flushController","endpointUrl","messagesLimit","batchMessagesLimit","bytesLimit","batchBytesLimit","durationLimit","flushTimeout","sendContentTypeByJson","messageBytesLimit","flushObservable","message","key"],"sources":["../../src/transport/startRumBatch.js"],"sourcesContent":["import {\n  Batch,\n  createHttpRequest,\n  LifeCycleEventType,\n  RumEventType,\n  createFlushController\n} from '@cloudcare/browser-core'\n\nexport function startRumBatch(\n  configuration,\n  lifeCycle,\n  telemetryEventObservable,\n  reportError,\n  pageExitObservable,\n  sessionExpireObservable\n) {\n  var batch = makeRumBatch(\n    configuration,\n    reportError,\n    pageExitObservable,\n    sessionExpireObservable\n  )\n\n  lifeCycle.subscribe(\n    LifeCycleEventType.RUM_EVENT_COLLECTED,\n    function (serverRumEvent) {\n      if (serverRumEvent.type === RumEventType.VIEW) {\n        batch.upsert(serverRumEvent, serverRumEvent.view.id)\n      } else {\n        batch.add(serverRumEvent)\n      }\n    }\n  )\n  telemetryEventObservable.subscribe(function (event) {\n    batch.add(event)\n  })\n}\n\nfunction makeRumBatch(\n  configuration,\n  reportError,\n  pageExitObservable,\n  sessionExpireObservable\n) {\n  var rumBatch = createRumBatch(configuration.rumEndpoint)\n  var primaryBatch = rumBatch.batch\n  var primaryFlushController = rumBatch.flushController\n  function createRumBatch(endpointUrl) {\n    var flushController = createFlushController({\n      messagesLimit: configuration.batchMessagesLimit,\n      bytesLimit: configuration.batchBytesLimit,\n      durationLimit: configuration.flushTimeout,\n      pageExitObservable: pageExitObservable,\n      sessionExpireObservable: sessionExpireObservable\n    })\n    var batch = new Batch(\n      createHttpRequest(\n        endpointUrl,\n        configuration.batchBytesLimit,\n        configuration.sendContentTypeByJson,\n        reportError\n      ),\n      flushController,\n      configuration.messageBytesLimit,\n      configuration.sendContentTypeByJson\n    )\n    return {\n      batch: batch,\n      flushController: flushController\n    }\n  }\n\n  return {\n    flushObservable: primaryFlushController.flushObservable,\n    add: function (message) {\n      primaryBatch.add(message)\n    },\n    upsert: function (message, key) {\n      primaryBatch.upsert(message, key)\n    }\n  }\n}\n"],"mappings":"AAAA,SACEA,KAAK,EACLC,iBAAiB,EACjBC,kBAAkB,EAClBC,YAAY,EACZC,qBAAqB,QAChB,yBAAyB;AAEhC,OAAO,SAASC,aAAaA,CAC3BC,aAAa,EACbC,SAAS,EACTC,wBAAwB,EACxBC,WAAW,EACXC,kBAAkB,EAClBC,uBAAuB,EACvB;EACA,IAAIC,KAAK,GAAGC,YAAY,CACtBP,aAAa,EACbG,WAAW,EACXC,kBAAkB,EAClBC,uBACF,CAAC;EAEDJ,SAAS,CAACO,SAAS,CACjBZ,kBAAkB,CAACa,mBAAmB,EACtC,UAAUC,cAAc,EAAE;IACxB,IAAIA,cAAc,CAACC,IAAI,KAAKd,YAAY,CAACe,IAAI,EAAE;MAC7CN,KAAK,CAACO,MAAM,CAACH,cAAc,EAAEA,cAAc,CAACI,IAAI,CAACC,EAAE,CAAC;IACtD,CAAC,MAAM;MACLT,KAAK,CAACU,GAAG,CAACN,cAAc,CAAC;IAC3B;EACF,CACF,CAAC;EACDR,wBAAwB,CAACM,SAAS,CAAC,UAAUS,KAAK,EAAE;IAClDX,KAAK,CAACU,GAAG,CAACC,KAAK,CAAC;EAClB,CAAC,CAAC;AACJ;AAEA,SAASV,YAAYA,CACnBP,aAAa,EACbG,WAAW,EACXC,kBAAkB,EAClBC,uBAAuB,EACvB;EACA,IAAIa,QAAQ,GAAGC,cAAc,CAACnB,aAAa,CAACoB,WAAW,CAAC;EACxD,IAAIC,YAAY,GAAGH,QAAQ,CAACZ,KAAK;EACjC,IAAIgB,sBAAsB,GAAGJ,QAAQ,CAACK,eAAe;EACrD,SAASJ,cAAcA,CAACK,WAAW,EAAE;IACnC,IAAID,eAAe,GAAGzB,qBAAqB,CAAC;MAC1C2B,aAAa,EAAEzB,aAAa,CAAC0B,kBAAkB;MAC/CC,UAAU,EAAE3B,aAAa,CAAC4B,eAAe;MACzCC,aAAa,EAAE7B,aAAa,CAAC8B,YAAY;MACzC1B,kBAAkB,EAAEA,kBAAkB;MACtCC,uBAAuB,EAAEA;IAC3B,CAAC,CAAC;IACF,IAAIC,KAAK,GAAG,IAAIZ,KAAK,CACnBC,iBAAiB,CACf6B,WAAW,EACXxB,aAAa,CAAC4B,eAAe,EAC7B5B,aAAa,CAAC+B,qBAAqB,EACnC5B,WACF,CAAC,EACDoB,eAAe,EACfvB,aAAa,CAACgC,iBAAiB,EAC/BhC,aAAa,CAAC+B,qBAChB,CAAC;IACD,OAAO;MACLzB,KAAK,EAAEA,KAAK;MACZiB,eAAe,EAAEA;IACnB,CAAC;EACH;EAEA,OAAO;IACLU,eAAe,EAAEX,sBAAsB,CAACW,eAAe;IACvDjB,GAAG,EAAE,SAAAA,IAAUkB,OAAO,EAAE;MACtBb,YAAY,CAACL,GAAG,CAACkB,OAAO,CAAC;IAC3B,CAAC;IACDrB,MAAM,EAAE,SAAAA,OAAUqB,OAAO,EAAEC,GAAG,EAAE;MAC9Bd,YAAY,CAACR,MAAM,CAACqB,OAAO,EAAEC,GAAG,CAAC;IACnC;EACF,CAAC;AACH","ignoreList":[]}