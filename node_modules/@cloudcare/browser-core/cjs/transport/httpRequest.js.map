{"version":3,"file":"httpRequest.js","names":["_sendWithRetryStrategy","require","_addEventListener","_monitor","addBatchPrecision","url","indexOf","createHttpRequest","endpointUrl","bytesLimit","sendContentTypeByJson","reportError","contentType","undefined","retryState","newRetryState","sendStrategyForRetry","payload","onResponse","fetchKeepAliveStrategy","send","sendWithRetryStrategy","sendOnExit","sendBeaconStrategy","data","bytesCount","canUseBeacon","navigator","sendBeacon","beaconData","Blob","type","isQueued","e","sendXHR","canUseKeepAlive","isKeepAliveSupported","fetchOption","method","body","keepalive","mode","headers","fetch","then","monitor","response","status","window","Request","_unused","request","XMLHttpRequest","open","setRequestHeader","addEventListener","once"],"sources":["../../src/transport/httpRequest.js"],"sourcesContent":["import { newRetryState, sendWithRetryStrategy } from './sendWithRetryStrategy'\nimport { addEventListener } from '../browser/addEventListener'\nimport { monitor } from '../helper/monitor'\n/**\n * Use POST request without content type to:\n * - avoid CORS preflight requests\n * - allow usage of sendBeacon\n *\n * multiple elements are sent separated by \\n in order\n * to be parsed correctly without content type header\n */\nfunction addBatchPrecision(url) {\n  if (!url) return url\n  return url + (url.indexOf('?') === -1 ? '?' : '&') + 'precision=ms'\n}\nexport function createHttpRequest(\n  endpointUrl,\n  bytesLimit,\n  sendContentTypeByJson,\n  reportError\n) {\n  var contentType = sendContentTypeByJson\n    ? 'application/json; charset=UTF-8'\n    : undefined\n  var retryState = newRetryState()\n  var sendStrategyForRetry = function (payload, onResponse) {\n    return fetchKeepAliveStrategy(\n      endpointUrl,\n      bytesLimit,\n      contentType,\n      payload,\n      onResponse\n    )\n  }\n\n  return {\n    send: function (payload) {\n      sendWithRetryStrategy(\n        payload,\n        retryState,\n        sendStrategyForRetry,\n        endpointUrl,\n        reportError\n      )\n    },\n    /**\n     * Since fetch keepalive behaves like regular fetch on Firefox,\n     * keep using sendBeaconStrategy on exit\n     */\n    sendOnExit: function (payload) {\n      sendBeaconStrategy(endpointUrl, bytesLimit, contentType, payload)\n    }\n  }\n}\n\nfunction sendBeaconStrategy(endpointUrl, bytesLimit, contentType, payload) {\n  var data = payload.data\n  var bytesCount = payload.bytesCount\n  var url = addBatchPrecision(endpointUrl)\n  var canUseBeacon = !!navigator.sendBeacon && bytesCount < bytesLimit\n  if (canUseBeacon) {\n    try {\n      var beaconData\n      if (contentType) {\n        beaconData = new Blob([data], {\n          type: contentType\n        })\n      } else {\n        beaconData = data\n      }\n\n      var isQueued = navigator.sendBeacon(url, beaconData)\n\n      if (isQueued) {\n        return\n      }\n    } catch (e) {\n      // reportBeaconError(e)\n    }\n  }\n  sendXHR(url, contentType, data)\n}\n\nexport function fetchKeepAliveStrategy(\n  endpointUrl,\n  bytesLimit,\n  contentType,\n  payload,\n  onResponse\n) {\n  var data = payload.data\n  var bytesCount = payload.bytesCount\n  var url = addBatchPrecision(endpointUrl)\n  var canUseKeepAlive = isKeepAliveSupported() && bytesCount < bytesLimit\n  if (canUseKeepAlive) {\n    var fetchOption = {\n      method: 'POST',\n      body: data,\n      keepalive: true,\n      mode: 'cors'\n    }\n    if (contentType) {\n      fetchOption.headers = {\n        'Content-Type': contentType\n      }\n    }\n    fetch(url, fetchOption).then(\n      monitor(function (response) {\n        if (typeof onResponse === 'function') {\n          onResponse({ status: response.status, type: response.type })\n        }\n      }),\n      monitor(function () {\n        // failed to queue the request\n        sendXHR(url, contentType, data, onResponse)\n      })\n    )\n  } else {\n    sendXHR(url, contentType, data, onResponse)\n  }\n}\n\nfunction isKeepAliveSupported() {\n  // Request can throw, cf https://developer.mozilla.org/en-US/docs/Web/API/Request/Request#errors\n  try {\n    return window.Request && 'keepalive' in new Request('http://a')\n  } catch {\n    return false\n  }\n}\n\nfunction sendXHR(url, contentType, data, onResponse) {\n  const request = new XMLHttpRequest()\n  request.open('POST', url, true)\n  if (contentType) {\n    //application/json; charset=UTF-8\n    request.setRequestHeader('Content-Type', contentType)\n  }\n\n  addEventListener(\n    request,\n    'loadend',\n    function () {\n      if (typeof onResponse === 'function') {\n        onResponse({ status: request.status })\n      }\n    },\n    {\n      once: true\n    }\n  )\n  request.send(data)\n}\n"],"mappings":";;;;;;;AAAA,IAAAA,sBAAA,GAAAC,OAAA;AACA,IAAAC,iBAAA,GAAAD,OAAA;AACA,IAAAE,QAAA,GAAAF,OAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASG,iBAAiBA,CAACC,GAAG,EAAE;EAC9B,IAAI,CAACA,GAAG,EAAE,OAAOA,GAAG;EACpB,OAAOA,GAAG,IAAIA,GAAG,CAACC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,cAAc;AACrE;AACO,SAASC,iBAAiBA,CAC/BC,WAAW,EACXC,UAAU,EACVC,qBAAqB,EACrBC,WAAW,EACX;EACA,IAAIC,WAAW,GAAGF,qBAAqB,GACnC,iCAAiC,GACjCG,SAAS;EACb,IAAIC,UAAU,GAAG,IAAAC,oCAAa,EAAC,CAAC;EAChC,IAAIC,oBAAoB,GAAG,SAAvBA,oBAAoBA,CAAaC,OAAO,EAAEC,UAAU,EAAE;IACxD,OAAOC,sBAAsB,CAC3BX,WAAW,EACXC,UAAU,EACVG,WAAW,EACXK,OAAO,EACPC,UACF,CAAC;EACH,CAAC;EAED,OAAO;IACLE,IAAI,EAAE,SAAAA,KAAUH,OAAO,EAAE;MACvB,IAAAI,4CAAqB,EACnBJ,OAAO,EACPH,UAAU,EACVE,oBAAoB,EACpBR,WAAW,EACXG,WACF,CAAC;IACH,CAAC;IACD;AACJ;AACA;AACA;IACIW,UAAU,EAAE,SAAAA,WAAUL,OAAO,EAAE;MAC7BM,kBAAkB,CAACf,WAAW,EAAEC,UAAU,EAAEG,WAAW,EAAEK,OAAO,CAAC;IACnE;EACF,CAAC;AACH;AAEA,SAASM,kBAAkBA,CAACf,WAAW,EAAEC,UAAU,EAAEG,WAAW,EAAEK,OAAO,EAAE;EACzE,IAAIO,IAAI,GAAGP,OAAO,CAACO,IAAI;EACvB,IAAIC,UAAU,GAAGR,OAAO,CAACQ,UAAU;EACnC,IAAIpB,GAAG,GAAGD,iBAAiB,CAACI,WAAW,CAAC;EACxC,IAAIkB,YAAY,GAAG,CAAC,CAACC,SAAS,CAACC,UAAU,IAAIH,UAAU,GAAGhB,UAAU;EACpE,IAAIiB,YAAY,EAAE;IAChB,IAAI;MACF,IAAIG,UAAU;MACd,IAAIjB,WAAW,EAAE;QACfiB,UAAU,GAAG,IAAIC,IAAI,CAAC,CAACN,IAAI,CAAC,EAAE;UAC5BO,IAAI,EAAEnB;QACR,CAAC,CAAC;MACJ,CAAC,MAAM;QACLiB,UAAU,GAAGL,IAAI;MACnB;MAEA,IAAIQ,QAAQ,GAAGL,SAAS,CAACC,UAAU,CAACvB,GAAG,EAAEwB,UAAU,CAAC;MAEpD,IAAIG,QAAQ,EAAE;QACZ;MACF;IACF,CAAC,CAAC,OAAOC,CAAC,EAAE;MACV;IAAA;EAEJ;EACAC,OAAO,CAAC7B,GAAG,EAAEO,WAAW,EAAEY,IAAI,CAAC;AACjC;AAEO,SAASL,sBAAsBA,CACpCX,WAAW,EACXC,UAAU,EACVG,WAAW,EACXK,OAAO,EACPC,UAAU,EACV;EACA,IAAIM,IAAI,GAAGP,OAAO,CAACO,IAAI;EACvB,IAAIC,UAAU,GAAGR,OAAO,CAACQ,UAAU;EACnC,IAAIpB,GAAG,GAAGD,iBAAiB,CAACI,WAAW,CAAC;EACxC,IAAI2B,eAAe,GAAGC,oBAAoB,CAAC,CAAC,IAAIX,UAAU,GAAGhB,UAAU;EACvE,IAAI0B,eAAe,EAAE;IACnB,IAAIE,WAAW,GAAG;MAChBC,MAAM,EAAE,MAAM;MACdC,IAAI,EAAEf,IAAI;MACVgB,SAAS,EAAE,IAAI;MACfC,IAAI,EAAE;IACR,CAAC;IACD,IAAI7B,WAAW,EAAE;MACfyB,WAAW,CAACK,OAAO,GAAG;QACpB,cAAc,EAAE9B;MAClB,CAAC;IACH;IACA+B,KAAK,CAACtC,GAAG,EAAEgC,WAAW,CAAC,CAACO,IAAI,CAC1B,IAAAC,gBAAO,EAAC,UAAUC,QAAQ,EAAE;MAC1B,IAAI,OAAO5B,UAAU,KAAK,UAAU,EAAE;QACpCA,UAAU,CAAC;UAAE6B,MAAM,EAAED,QAAQ,CAACC,MAAM;UAAEhB,IAAI,EAAEe,QAAQ,CAACf;QAAK,CAAC,CAAC;MAC9D;IACF,CAAC,CAAC,EACF,IAAAc,gBAAO,EAAC,YAAY;MAClB;MACAX,OAAO,CAAC7B,GAAG,EAAEO,WAAW,EAAEY,IAAI,EAAEN,UAAU,CAAC;IAC7C,CAAC,CACH,CAAC;EACH,CAAC,MAAM;IACLgB,OAAO,CAAC7B,GAAG,EAAEO,WAAW,EAAEY,IAAI,EAAEN,UAAU,CAAC;EAC7C;AACF;AAEA,SAASkB,oBAAoBA,CAAA,EAAG;EAC9B;EACA,IAAI;IACF,OAAOY,MAAM,CAACC,OAAO,IAAI,WAAW,IAAI,IAAIA,OAAO,CAAC,UAAU,CAAC;EACjE,CAAC,CAAC,OAAAC,OAAA,EAAM;IACN,OAAO,KAAK;EACd;AACF;AAEA,SAAShB,OAAOA,CAAC7B,GAAG,EAAEO,WAAW,EAAEY,IAAI,EAAEN,UAAU,EAAE;EACnD,IAAMiC,OAAO,GAAG,IAAIC,cAAc,CAAC,CAAC;EACpCD,OAAO,CAACE,IAAI,CAAC,MAAM,EAAEhD,GAAG,EAAE,IAAI,CAAC;EAC/B,IAAIO,WAAW,EAAE;IACf;IACAuC,OAAO,CAACG,gBAAgB,CAAC,cAAc,EAAE1C,WAAW,CAAC;EACvD;EAEA,IAAA2C,kCAAgB,EACdJ,OAAO,EACP,SAAS,EACT,YAAY;IACV,IAAI,OAAOjC,UAAU,KAAK,UAAU,EAAE;MACpCA,UAAU,CAAC;QAAE6B,MAAM,EAAEI,OAAO,CAACJ;MAAO,CAAC,CAAC;IACxC;EACF,CAAC,EACD;IACES,IAAI,EAAE;EACR,CACF,CAAC;EACDL,OAAO,CAAC/B,IAAI,CAACI,IAAI,CAAC;AACpB","ignoreList":[]}