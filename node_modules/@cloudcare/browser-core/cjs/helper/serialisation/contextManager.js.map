{"version":3,"file":"contextManager.js","names":["_byteUtils","require","_tools","_sanitize","_jsonStringify","_observable","_heavyCustomerDataWarning","BYTES_COMPUTATION_THROTTLING_DELAY","exports","createContextManager","customerDataType","computeBytesCountImpl","computeBytesCount","context","bytesCountCache","alreadyWarned","changeObservable","Observable","computeBytesCountThrottled","throttle","jsonStringify","warnIfCustomerDataLimitReached","throttled","contextManager","getBytesCount","get","add","key","value","notify","remove","set","newContext","getContext","deepClone","setContext","getType","sanitize","clearContext","setContextProperty","property","removeContextProperty"],"sources":["../../../src/helper/serialisation/contextManager.js"],"sourcesContent":["import { computeBytesCount } from '../byteUtils'\nimport { deepClone, throttle, getType } from '../tools'\nimport { sanitize } from '../sanitize'\nimport { jsonStringify } from './jsonStringify'\nimport { Observable } from '../observable'\nimport { warnIfCustomerDataLimitReached } from './heavyCustomerDataWarning'\n\nexport var BYTES_COMPUTATION_THROTTLING_DELAY = 200\n\nexport function createContextManager(customerDataType, computeBytesCountImpl) {\n  if (typeof computeBytesCountImpl === 'undefined') {\n    computeBytesCountImpl = computeBytesCount\n  }\n  var context = {}\n  var bytesCountCache\n  var alreadyWarned = false\n  var changeObservable = new Observable()\n  // Throttle the bytes computation to minimize the impact on performance.\n  // Especially useful if the user call context APIs synchronously multiple times in a row\n  var computeBytesCountThrottled = throttle(function (context) {\n    bytesCountCache = computeBytesCountImpl(jsonStringify(context))\n    if (!alreadyWarned) {\n      alreadyWarned = warnIfCustomerDataLimitReached(\n        bytesCountCache,\n        customerDataType\n      )\n    }\n  }, BYTES_COMPUTATION_THROTTLING_DELAY).throttled\n\n  var contextManager = {\n    getBytesCount: function () {\n      return bytesCountCache\n    },\n    /** @deprecated use getContext instead */\n    get: function () {\n      return context\n    },\n\n    /** @deprecated use setContextProperty instead */\n    add: function (key, value) {\n      context[key] = value\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    /** @deprecated renamed to removeContextProperty */\n    remove: function (key) {\n      delete context[key]\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    /** @deprecated use setContext instead */\n    set: function (newContext) {\n      context = newContext\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    getContext: function () {\n      return deepClone(context)\n    },\n\n    setContext: function (newContext) {\n      if (getType(newContext) === 'object') {\n        context = sanitize(newContext)\n        computeBytesCountThrottled(context)\n      } else {\n        contextManager.clearContext()\n      }\n      changeObservable.notify()\n    },\n\n    setContextProperty: function (key, property) {\n      context[key] = deepClone(property)\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    removeContextProperty: function (key) {\n      delete context[key]\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    clearContext: function () {\n      context = {}\n      bytesCountCache = 0\n      changeObservable.notify()\n    },\n    changeObservable: changeObservable\n  }\n  return contextManager\n}\n"],"mappings":";;;;;;;AAAA,IAAAA,UAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AACA,IAAAE,SAAA,GAAAF,OAAA;AACA,IAAAG,cAAA,GAAAH,OAAA;AACA,IAAAI,WAAA,GAAAJ,OAAA;AACA,IAAAK,yBAAA,GAAAL,OAAA;AAEO,IAAIM,kCAAkC,GAAG,GAAG;AAAAC,OAAA,CAAAD,kCAAA,GAAAA,kCAAA;AAE5C,SAASE,oBAAoBA,CAACC,gBAAgB,EAAEC,qBAAqB,EAAE;EAC5E,IAAI,OAAOA,qBAAqB,KAAK,WAAW,EAAE;IAChDA,qBAAqB,GAAGC,4BAAiB;EAC3C;EACA,IAAIC,OAAO,GAAG,CAAC,CAAC;EAChB,IAAIC,eAAe;EACnB,IAAIC,aAAa,GAAG,KAAK;EACzB,IAAIC,gBAAgB,GAAG,IAAIC,sBAAU,CAAC,CAAC;EACvC;EACA;EACA,IAAIC,0BAA0B,GAAG,IAAAC,eAAQ,EAAC,UAAUN,OAAO,EAAE;IAC3DC,eAAe,GAAGH,qBAAqB,CAAC,IAAAS,4BAAa,EAACP,OAAO,CAAC,CAAC;IAC/D,IAAI,CAACE,aAAa,EAAE;MAClBA,aAAa,GAAG,IAAAM,wDAA8B,EAC5CP,eAAe,EACfJ,gBACF,CAAC;IACH;EACF,CAAC,EAAEH,kCAAkC,CAAC,CAACe,SAAS;EAEhD,IAAIC,cAAc,GAAG;IACnBC,aAAa,EAAE,SAAAA,cAAA,EAAY;MACzB,OAAOV,eAAe;IACxB,CAAC;IACD;IACAW,GAAG,EAAE,SAAAA,IAAA,EAAY;MACf,OAAOZ,OAAO;IAChB,CAAC;IAED;IACAa,GAAG,EAAE,SAAAA,IAAUC,GAAG,EAAEC,KAAK,EAAE;MACzBf,OAAO,CAACc,GAAG,CAAC,GAAGC,KAAK;MACpBV,0BAA0B,CAACL,OAAO,CAAC;MACnCG,gBAAgB,CAACa,MAAM,CAAC,CAAC;IAC3B,CAAC;IAED;IACAC,MAAM,EAAE,SAAAA,OAAUH,GAAG,EAAE;MACrB,OAAOd,OAAO,CAACc,GAAG,CAAC;MACnBT,0BAA0B,CAACL,OAAO,CAAC;MACnCG,gBAAgB,CAACa,MAAM,CAAC,CAAC;IAC3B,CAAC;IAED;IACAE,GAAG,EAAE,SAAAA,IAAUC,UAAU,EAAE;MACzBnB,OAAO,GAAGmB,UAAU;MACpBd,0BAA0B,CAACL,OAAO,CAAC;MACnCG,gBAAgB,CAACa,MAAM,CAAC,CAAC;IAC3B,CAAC;IAEDI,UAAU,EAAE,SAAAA,WAAA,EAAY;MACtB,OAAO,IAAAC,gBAAS,EAACrB,OAAO,CAAC;IAC3B,CAAC;IAEDsB,UAAU,EAAE,SAAAA,WAAUH,UAAU,EAAE;MAChC,IAAI,IAAAI,cAAO,EAACJ,UAAU,CAAC,KAAK,QAAQ,EAAE;QACpCnB,OAAO,GAAG,IAAAwB,kBAAQ,EAACL,UAAU,CAAC;QAC9Bd,0BAA0B,CAACL,OAAO,CAAC;MACrC,CAAC,MAAM;QACLU,cAAc,CAACe,YAAY,CAAC,CAAC;MAC/B;MACAtB,gBAAgB,CAACa,MAAM,CAAC,CAAC;IAC3B,CAAC;IAEDU,kBAAkB,EAAE,SAAAA,mBAAUZ,GAAG,EAAEa,QAAQ,EAAE;MAC3C3B,OAAO,CAACc,GAAG,CAAC,GAAG,IAAAO,gBAAS,EAACM,QAAQ,CAAC;MAClCtB,0BAA0B,CAACL,OAAO,CAAC;MACnCG,gBAAgB,CAACa,MAAM,CAAC,CAAC;IAC3B,CAAC;IAEDY,qBAAqB,EAAE,SAAAA,sBAAUd,GAAG,EAAE;MACpC,OAAOd,OAAO,CAACc,GAAG,CAAC;MACnBT,0BAA0B,CAACL,OAAO,CAAC;MACnCG,gBAAgB,CAACa,MAAM,CAAC,CAAC;IAC3B,CAAC;IAEDS,YAAY,EAAE,SAAAA,aAAA,EAAY;MACxBzB,OAAO,GAAG,CAAC,CAAC;MACZC,eAAe,GAAG,CAAC;MACnBE,gBAAgB,CAACa,MAAM,CAAC,CAAC;IAC3B,CAAC;IACDb,gBAAgB,EAAEA;EACpB,CAAC;EACD,OAAOO,cAAc;AACvB","ignoreList":[]}