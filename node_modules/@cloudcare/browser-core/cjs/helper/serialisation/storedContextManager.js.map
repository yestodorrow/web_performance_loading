{"version":3,"file":"storedContextManager.js","names":["_byteUtils","require","_enums","_tools","_addEventListener","_contextManager","CONTEXT_STORE_KEY_PREFIX","storageListeners","createStoredContextManager","productKey","customerDataType","computeBytesCountImpl","undefined","computeBytesCount","storageKey","buildStorageKey","contextManager","createContextManager","synchronizeWithStorage","push","addEventListener","window","DOM_EVENT","STORAGE","params","key","changeObservable","subscribe","dumpToStorage","rawContext","localStorage","getItem","context","JSON","parse","setContext","setItem","stringify","getContext","removeStorageListeners","map","listener","stop"],"sources":["../../../src/helper/serialisation/storedContextManager.js"],"sourcesContent":["import { computeBytesCount } from '../byteUtils'\nimport { DOM_EVENT } from '../enums'\nimport { map } from '../tools'\nimport { addEventListener } from '../../browser/addEventListener'\nimport { createContextManager } from './contextManager'\nvar CONTEXT_STORE_KEY_PREFIX = '_gc_s'\n\nvar storageListeners = []\n\nexport function createStoredContextManager(\n  productKey,\n  customerDataType,\n  computeBytesCountImpl\n) {\n  if (computeBytesCountImpl === undefined) {\n    computeBytesCountImpl = computeBytesCount\n  }\n  var storageKey = buildStorageKey(productKey, customerDataType)\n  var contextManager = createContextManager(\n    customerDataType,\n    computeBytesCountImpl\n  )\n\n  synchronizeWithStorage()\n  storageListeners.push(\n    addEventListener(window, DOM_EVENT.STORAGE, function (params) {\n      if (storageKey === params.key) {\n        synchronizeWithStorage()\n      }\n    })\n  )\n  contextManager.changeObservable.subscribe(dumpToStorage)\n  function synchronizeWithStorage() {\n    var rawContext = localStorage.getItem(storageKey)\n    var context = rawContext !== null ? JSON.parse(rawContext) : {}\n    contextManager.setContext(context)\n  }\n\n  function dumpToStorage() {\n    localStorage.setItem(\n      storageKey,\n      JSON.stringify(contextManager.getContext())\n    )\n  }\n  return contextManager\n}\n\nexport function buildStorageKey(productKey, customerDataType) {\n  return CONTEXT_STORE_KEY_PREFIX + '_' + productKey + '_' + customerDataType\n}\n\nexport function removeStorageListeners() {\n  map(storageListeners, function (listener) {\n    listener.stop()\n  })\n}\n"],"mappings":";;;;;;;;AAAA,IAAAA,UAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AACA,IAAAE,MAAA,GAAAF,OAAA;AACA,IAAAG,iBAAA,GAAAH,OAAA;AACA,IAAAI,eAAA,GAAAJ,OAAA;AACA,IAAIK,wBAAwB,GAAG,OAAO;AAEtC,IAAIC,gBAAgB,GAAG,EAAE;AAElB,SAASC,0BAA0BA,CACxCC,UAAU,EACVC,gBAAgB,EAChBC,qBAAqB,EACrB;EACA,IAAIA,qBAAqB,KAAKC,SAAS,EAAE;IACvCD,qBAAqB,GAAGE,4BAAiB;EAC3C;EACA,IAAIC,UAAU,GAAGC,eAAe,CAACN,UAAU,EAAEC,gBAAgB,CAAC;EAC9D,IAAIM,cAAc,GAAG,IAAAC,oCAAoB,EACvCP,gBAAgB,EAChBC,qBACF,CAAC;EAEDO,sBAAsB,CAAC,CAAC;EACxBX,gBAAgB,CAACY,IAAI,CACnB,IAAAC,kCAAgB,EAACC,MAAM,EAAEC,gBAAS,CAACC,OAAO,EAAE,UAAUC,MAAM,EAAE;IAC5D,IAAIV,UAAU,KAAKU,MAAM,CAACC,GAAG,EAAE;MAC7BP,sBAAsB,CAAC,CAAC;IAC1B;EACF,CAAC,CACH,CAAC;EACDF,cAAc,CAACU,gBAAgB,CAACC,SAAS,CAACC,aAAa,CAAC;EACxD,SAASV,sBAAsBA,CAAA,EAAG;IAChC,IAAIW,UAAU,GAAGC,YAAY,CAACC,OAAO,CAACjB,UAAU,CAAC;IACjD,IAAIkB,OAAO,GAAGH,UAAU,KAAK,IAAI,GAAGI,IAAI,CAACC,KAAK,CAACL,UAAU,CAAC,GAAG,CAAC,CAAC;IAC/Db,cAAc,CAACmB,UAAU,CAACH,OAAO,CAAC;EACpC;EAEA,SAASJ,aAAaA,CAAA,EAAG;IACvBE,YAAY,CAACM,OAAO,CAClBtB,UAAU,EACVmB,IAAI,CAACI,SAAS,CAACrB,cAAc,CAACsB,UAAU,CAAC,CAAC,CAC5C,CAAC;EACH;EACA,OAAOtB,cAAc;AACvB;AAEO,SAASD,eAAeA,CAACN,UAAU,EAAEC,gBAAgB,EAAE;EAC5D,OAAOJ,wBAAwB,GAAG,GAAG,GAAGG,UAAU,GAAG,GAAG,GAAGC,gBAAgB;AAC7E;AAEO,SAAS6B,sBAAsBA,CAAA,EAAG;EACvC,IAAAC,UAAG,EAACjC,gBAAgB,EAAE,UAAUkC,QAAQ,EAAE;IACxCA,QAAQ,CAACC,IAAI,CAAC,CAAC;EACjB,CAAC,CAAC;AACJ","ignoreList":[]}