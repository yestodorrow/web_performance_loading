{"version":3,"file":"contextHistory.js","names":["_tools","require","_timer","_createForOfIteratorHelper","o","allowArrayLike","it","Symbol","iterator","Array","isArray","_unsupportedIterableToArray","length","i","F","s","n","done","value","e","_e","f","TypeError","normalCompletion","didErr","err","call","step","next","_e2","minLen","_arrayLikeToArray","Object","prototype","toString","slice","constructor","name","from","test","arr","len","arr2","END_OF_TIMES","Infinity","CLEAR_OLD_CONTEXTS_INTERVAL","ONE_MINUTE","exports","ContextHistory","expireDelay","maxEntries","entries","_this","clearOldContextsInterval","setInterval","clearOldContexts","add","context","startTime","entry","endTime","remove","index","indexOf","splice","close","pop","unshift","find","_iterator","_step","closeActive","latestEntry","findAll","duration","addDuration","result","filter","map","reset","stop","clearInterval","oldTimeThreshold","relativeNow"],"sources":["../../src/helper/contextHistory.js"],"sourcesContent":["import { relativeNow, ONE_MINUTE, filter, map, addDuration } from './tools'\nimport { setInterval, clearInterval } from './timer'\nvar END_OF_TIMES = Infinity\n\nexport var CLEAR_OLD_CONTEXTS_INTERVAL = ONE_MINUTE\nexport function ContextHistory(expireDelay, maxEntries) {\n  this.expireDelay = expireDelay\n  this.entries = []\n  this.maxEntries = maxEntries\n  var _this = this\n  this.clearOldContextsInterval = setInterval(function () {\n    _this.clearOldContexts()\n  }, CLEAR_OLD_CONTEXTS_INTERVAL)\n}\n\nContextHistory.prototype.add = function (context, startTime) {\n  var _this = this\n  var entry = {\n    context: context,\n    startTime: startTime,\n    endTime: END_OF_TIMES,\n    remove: function () {\n      var index = _this.entries.indexOf(entry)\n      if (index >= 0) {\n        _this.entries.splice(index, 1)\n      }\n    },\n    close: function (endTime) {\n      entry.endTime = endTime\n    }\n  }\n  if (this.maxEntries && this.entries.length >= this.maxEntries) {\n    this.entries.pop()\n  }\n  this.entries.unshift(entry)\n  return entry\n}\nContextHistory.prototype.find = function (startTime) {\n  if (typeof startTime === 'undefined') {\n    startTime = END_OF_TIMES\n  }\n  for (var entry of this.entries) {\n    if (entry.startTime <= startTime) {\n      if (startTime <= entry.endTime) {\n        return entry.context\n      }\n      break\n    }\n  }\n  //\n}\n/**\n * Helper function to close the currently active context, if any. This method assumes that entries\n * are not overlapping.\n */\nContextHistory.prototype.closeActive = function (endTime) {\n  var latestEntry = this.entries[0]\n  if (latestEntry && latestEntry.endTime === END_OF_TIMES) {\n    latestEntry.close(endTime)\n  }\n}\n/**\n * Return all contexts that were active during `startTime`, or all currently active contexts if no\n * `startTime` is provided.\n */\nContextHistory.prototype.findAll = function (startTime, duration) {\n  if (typeof duration === 'undefined') {\n    duration = 0\n  }\n  if (typeof startTime === 'undefined') {\n    startTime = END_OF_TIMES\n  }\n  var endTime = addDuration(startTime, duration)\n  var result = filter(this.entries, function (entry) {\n    return entry.startTime <= endTime && startTime <= entry.endTime\n  })\n  return map(result, function (entry) {\n    return entry.context\n  })\n}\n/**\n * Remove all entries from this collection.\n */\nContextHistory.prototype.reset = function () {\n  this.entries = []\n}\n/**\n * Stop internal garbage collection of past entries.\n */\nContextHistory.prototype.stop = function () {\n  clearInterval(this.clearOldContextsInterval)\n}\nContextHistory.prototype.clearOldContexts = function () {\n  var oldTimeThreshold = relativeNow() - this.expireDelay\n  while (\n    this.entries.length > 0 &&\n    this.entries[this.entries.length - 1].endTime < oldTimeThreshold\n  ) {\n    this.entries.pop()\n  }\n}\n"],"mappings":"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","ignoreList":[]}