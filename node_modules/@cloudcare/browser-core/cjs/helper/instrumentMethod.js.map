{"version":3,"file":"instrumentMethod.js","names":["_tools","require","_timer","_monitor","instrumentMethod","object","method","instrumentationFactory","original","instrumentation","instrumentationWrapper","undefined","apply","arguments","stop","instrumentMethodAndCallOriginal","aliasOption","result","before","callMonitored","after","instrumentSetter","property","originalDescriptor","Object","getOwnPropertyDescriptor","set","configurable","noop","stoppedInstrumentation","thisObject","value","setTimeout","call","defineProperty"],"sources":["../../src/helper/instrumentMethod.js"],"sourcesContent":["import { noop } from './tools'\nimport { setTimeout } from './timer'\nimport { callMonitored } from './monitor'\nexport function instrumentMethod(object, method, instrumentationFactory) {\n  var original = object[method]\n\n  var instrumentation = instrumentationFactory(original)\n\n  var instrumentationWrapper = function () {\n    if (typeof instrumentation !== 'function') {\n      return undefined\n    }\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return instrumentation.apply(this, arguments)\n  }\n  object[method] = instrumentationWrapper\n  return {\n    stop: function () {\n      if (object[method] === instrumentationWrapper) {\n        object[method] = original\n      } else {\n        instrumentation = original\n      }\n    }\n  }\n}\n\nexport function instrumentMethodAndCallOriginal(object, method, aliasOption) {\n  return instrumentMethod(object, method, function (original) {\n    return function () {\n      var result\n      if (aliasOption && aliasOption.before) {\n        callMonitored(aliasOption.before, this, arguments)\n        // aliasOption.before.apply(this, arguments)\n      }\n      if (typeof original === 'function') {\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-call\n        result = original.apply(this, arguments)\n      }\n      if (aliasOption && aliasOption.after) {\n        callMonitored(aliasOption.after, this, arguments)\n        // aliasOption.after.apply(this, arguments)\n      }\n      return result\n    }\n  })\n}\n\nexport function instrumentSetter(object, property, after) {\n  var originalDescriptor = Object.getOwnPropertyDescriptor(object, property)\n  if (\n    !originalDescriptor ||\n    !originalDescriptor.set ||\n    !originalDescriptor.configurable\n  ) {\n    return { stop: noop }\n  }\n  var stoppedInstrumentation = noop\n  var instrumentation = function (thisObject, value) {\n    // put hooked setter into event loop to avoid of set latency\n    setTimeout(function () {\n      if (instrumentation !== stoppedInstrumentation) {\n        after(thisObject, value)\n      }\n    }, 0)\n  }\n\n  var instrumentationWrapper = function (value) {\n    originalDescriptor.set.call(this, value)\n    instrumentation(this, value)\n  }\n\n  Object.defineProperty(object, property, {\n    set: instrumentationWrapper\n  })\n\n  return {\n    stop: function () {\n      if (\n        Object.getOwnPropertyDescriptor(object, property) &&\n        Object.getOwnPropertyDescriptor(object, property).set ===\n          instrumentationWrapper\n      ) {\n        Object.defineProperty(object, property, originalDescriptor)\n      } else {\n        instrumentation = stoppedInstrumentation\n      }\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}