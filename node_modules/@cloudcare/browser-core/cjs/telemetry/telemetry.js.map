{"version":3,"file":"telemetry.js","names":["_display","require","_errorTools","_tracekit","_observable","_monitor","_tools","_jsonStringify","_enums","_types","ALLOWED_FRAME_URLS","TelemetryService","LOGS","RUM","exports","telemetryConfiguration","maxEventsPerPage","sentEventCount","telemetryEnabled","onRawTelemetryEventCollected","startTelemetry","telemetryService","configuration","contextProvider","observable","Observable","performDraw","telemetrySampleRate","rawEvent","event","toTelemetryEvent","notify","startMonitorErrorCollection","addTelemetryError","assign","maxTelemetryEventsPerPage","extend2Lev","type","date","timeStampNow","service","version","__BUILD_ENV__SDK_VERSION__","source","telemetry","undefined","setContextProvider","provider","enabled","resetTelemetry","addTelemetryDebug","message","context","displayIfDebugEnabled","ConsoleApiName","debug","addTelemetry","TelemetryType","log","status","TelemetryStatusType","e","error","formatError","addTelemetryConfiguration","Error","stackTrace","computeStackTrace","kind","name","stack","toStackTraceString","scrubCustomerFrames","NO_ERROR_STACK_PRESENT_MESSAGE","NonErrorPrefix","UNCAUGHT","jsonStringify","filter","frame","url","some","allowedFrameUrl","startsWith"],"sources":["../../src/telemetry/telemetry.js"],"sourcesContent":["import { ConsoleApiName } from '../helper/display'\nimport {\n  toStackTraceString,\n  NO_ERROR_STACK_PRESENT_MESSAGE\n} from '../helper/errorTools'\nimport { computeStackTrace } from '../tracekit'\nimport { Observable } from '../helper/observable'\nimport {\n  displayIfDebugEnabled,\n  startMonitorErrorCollection\n} from '..//helper/monitor'\nimport {\n  startsWith,\n  assign,\n  performDraw,\n  timeStampNow,\n  extend2Lev\n} from '../helper/tools'\nimport { jsonStringify } from '../helper/serialisation/jsonStringify'\nimport { NonErrorPrefix } from '../helper/enums'\nimport { TelemetryStatusType, TelemetryType } from './types'\n\nconst ALLOWED_FRAME_URLS = [\n  'https://static.guance.com',\n  'http://localhost',\n  '<anonymous>'\n]\n\nexport var TelemetryService = {\n  LOGS: 'browser-logs-sdk',\n  RUM: 'browser-rum-sdk'\n}\n\nvar telemetryConfiguration = {\n  maxEventsPerPage: 0,\n  sentEventCount: 0,\n  telemetryEnabled: false\n}\n\nvar onRawTelemetryEventCollected\n\nexport function startTelemetry(telemetryService, configuration) {\n  let contextProvider\n  var observable = new Observable()\n  telemetryConfiguration.telemetryEnabled =\n    configuration.telemetryEnabled &&\n    performDraw(configuration.telemetrySampleRate)\n\n  onRawTelemetryEventCollected = function (rawEvent) {\n    if (telemetryConfiguration.telemetryEnabled) {\n      var event = toTelemetryEvent(telemetryService, rawEvent)\n      observable.notify(event)\n    }\n  }\n  startMonitorErrorCollection(addTelemetryError)\n\n  assign(telemetryConfiguration, {\n    maxEventsPerPage: configuration.maxTelemetryEventsPerPage,\n    sentEventCount: 0\n  })\n\n  function toTelemetryEvent(telemetryService, event) {\n    return extend2Lev(\n      {\n        type: 'telemetry',\n        date: timeStampNow(),\n        service: telemetryService,\n        version: __BUILD_ENV__SDK_VERSION__,\n        source: 'browser',\n        telemetry: event // https://github.com/microsoft/TypeScript/issues/48457\n      },\n      contextProvider !== undefined ? contextProvider() : {}\n    )\n  }\n\n  return {\n    setContextProvider: function (provider) {\n      contextProvider = provider\n    },\n    observable: observable,\n    enabled: telemetryConfiguration.telemetryEnabled\n  }\n}\n\nexport function resetTelemetry() {\n  onRawTelemetryEventCollected = undefined\n}\n\nexport function addTelemetryDebug(message, context) {\n  displayIfDebugEnabled(ConsoleApiName.debug, message, context)\n  addTelemetry(\n    assign(\n      {\n        type: TelemetryType.log,\n        message: message,\n        status: TelemetryStatusType.debug\n      },\n      context\n    )\n  )\n}\n\nexport function addTelemetryError(e, context) {\n  addTelemetry(\n    assign(\n      {\n        type: TelemetryType.log,\n        status: TelemetryStatusType.error\n      },\n      formatError(e),\n      context\n    )\n  )\n}\n\nexport function addTelemetryConfiguration(configuration) {\n  if (telemetryConfiguration.telemetryEnabled) {\n    addTelemetry({\n      type: TelemetryType.configuration,\n      configuration: configuration\n    })\n  }\n}\n\nfunction addTelemetry(event) {\n  if (\n    onRawTelemetryEventCollected &&\n    telemetryConfiguration.sentEventCount <\n      telemetryConfiguration.maxEventsPerPage\n  ) {\n    telemetryConfiguration.sentEventCount += 1\n    onRawTelemetryEventCollected(event)\n  }\n}\n\nexport function formatError(e) {\n  if (e instanceof Error) {\n    var stackTrace = computeStackTrace(e)\n    return {\n      error: {\n        kind: stackTrace.name,\n        stack: toStackTraceString(scrubCustomerFrames(stackTrace))\n      },\n      message: stackTrace.message\n    }\n  }\n  return {\n    error: {\n      stack: NO_ERROR_STACK_PRESENT_MESSAGE\n    },\n    message: NonErrorPrefix.UNCAUGHT + ' ' + jsonStringify(e)\n  }\n}\n\nexport function scrubCustomerFrames(stackTrace) {\n  stackTrace.stack = stackTrace.stack.filter(function (frame) {\n    return (\n      !frame.url ||\n      ALLOWED_FRAME_URLS.some(function (allowedFrameUrl) {\n        return startsWith(frame.url, allowedFrameUrl)\n      })\n    )\n  })\n  return stackTrace\n}\n"],"mappings":"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","ignoreList":[]}