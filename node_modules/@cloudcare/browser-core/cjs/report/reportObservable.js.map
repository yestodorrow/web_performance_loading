{"version":3,"file":"reportObservable.js","names":["_errorTools","require","_observable","_tools","_addEventListener2","_enums","_monitor","RawReportType","intervention","deprecation","cspViolation","exports","initReportObservable","configuration","apis","observables","includes","push","createCspViolationReportObservable","reportTypes","filter","api","length","createReportObservable","mergeObservables","apply","Observable","observable","window","ReportingObserver","handleReports","monitor","reports","each","report","notify","buildRawReportFromReport","observer","types","buffered","observe","disconnect","handleCspViolation","event","buildRawReportFromCspViolation","_addEventListener","addEventListener","document","DOM_EVENT","SECURITY_POLICY_VIOLATION","stop","body","type","subtype","id","message","stack","buildStack","sourceFile","lineNumber","columnNumber","blockedURI","effectiveDirective","safeTruncate","originalPolicy","name","toStackTraceString","func","url","line","column"],"sources":["../../src/report/reportObservable.js"],"sourcesContent":["import { toStackTraceString } from '../helper/errorTools'\nimport { mergeObservables, Observable } from '../helper/observable'\nimport { includes, safeTruncate, filter, each } from '../helper/tools'\nimport { addEventListener } from '../browser/addEventListener'\nimport { DOM_EVENT } from '../helper/enums'\nimport { monitor } from '../helper/monitor'\nexport var RawReportType = {\n  intervention: 'intervention',\n  deprecation: 'deprecation',\n  cspViolation: 'csp_violation'\n}\nexport function initReportObservable(configuration, apis) {\n  var observables = []\n\n  if (includes(apis, RawReportType.cspViolation)) {\n    observables.push(createCspViolationReportObservable(configuration))\n  }\n\n  var reportTypes = filter(apis, function (api) {\n    return api !== RawReportType.cspViolation\n  })\n  if (reportTypes.length) {\n    observables.push(createReportObservable(reportTypes))\n  }\n  return mergeObservables.apply(this, observables)\n}\n\nfunction createReportObservable(reportTypes) {\n  return new Observable(function (observable) {\n    if (!window.ReportingObserver) {\n      return\n    }\n\n    var handleReports = monitor(function (reports) {\n      each(reports, function (report) {\n        observable.notify(buildRawReportFromReport(report))\n      })\n    })\n\n    var observer = new window.ReportingObserver(handleReports, {\n      types: reportTypes,\n      buffered: true\n    })\n\n    observer.observe()\n    return function () {\n      observer.disconnect()\n    }\n  })\n\n  return observable\n}\n\nfunction createCspViolationReportObservable(configuration) {\n  return new Observable(function (observable) {\n    var handleCspViolation = function (event) {\n      observable.notify(buildRawReportFromCspViolation(event))\n    }\n\n    var _addEventListener = addEventListener(\n      document,\n      DOM_EVENT.SECURITY_POLICY_VIOLATION,\n      handleCspViolation\n    )\n\n    return _addEventListener.stop\n  })\n  return observable\n}\n\nfunction buildRawReportFromReport(report) {\n  var body = report.body\n  var type = report.type\n  return {\n    type: type,\n    subtype: body.id,\n    message: type + ': ' + body.message,\n    stack: buildStack(\n      body.id,\n      body.message,\n      body.sourceFile,\n      body.lineNumber,\n      body.columnNumber\n    )\n  }\n}\n\nfunction buildRawReportFromCspViolation(event) {\n  var type = RawReportType.cspViolation\n  var message =\n    \"'\" +\n    event.blockedURI +\n    \"' blocked by '\" +\n    event.effectiveDirective +\n    \"' directive\"\n  return {\n    type: RawReportType.cspViolation,\n    subtype: event.effectiveDirective,\n    message: type + ': ' + message,\n    stack: buildStack(\n      event.effectiveDirective,\n      message +\n        ' of the policy \"' +\n        safeTruncate(event.originalPolicy, 100, '...') +\n        '\"',\n      event.sourceFile,\n      event.lineNumber,\n      event.columnNumber\n    )\n  }\n}\n\nfunction buildStack(name, message, sourceFile, lineNumber, columnNumber) {\n  return (\n    sourceFile &&\n    toStackTraceString({\n      name: name,\n      message: message,\n      stack: [\n        {\n          func: '?',\n          url: sourceFile,\n          line: lineNumber,\n          column: columnNumber\n        }\n      ]\n    })\n  )\n}\n"],"mappings":"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","ignoreList":[]}