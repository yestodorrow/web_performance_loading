{"version":3,"file":"fetchObservable.js","names":["_instrumentMethod","require","_observable","_tools","_monitor","_urlPolyfill","fetchObservable","initFetchObservable","createFetchObservable","Observable","observable","window","fetch","fetchMethod","instrumentMethod","originalFetch","input","init","responsePromise","context","callMonitored","beforeSend","call","afterSend","stop","methodFromParams","method","undefined","Request","String","toUpperCase","url","normalizeUrl","startClocks","clocksNow","state","notify","startContext","reportFetch","response","Error","status","isAborted","DOMException","code","ABORT_ERR","error","responseType","constructor","Response","type","err","then","monitor"],"sources":["../../src/browser/fetchObservable.js"],"sourcesContent":["import { instrumentMethod } from '../helper/instrumentMethod'\nimport { Observable } from '../helper/observable'\nimport { clocksNow } from '../helper/tools'\nimport { monitor, callMonitored } from '../helper/monitor'\nimport { normalizeUrl } from '../helper/urlPolyfill'\n\nvar fetchObservable\n\nexport function initFetchObservable() {\n  if (!fetchObservable) {\n    fetchObservable = createFetchObservable()\n  }\n  return fetchObservable\n}\n\nfunction createFetchObservable() {\n  return new Observable(function (observable) {\n    if (!window.fetch) {\n      return\n    }\n\n    var fetchMethod = instrumentMethod(\n      window,\n      'fetch',\n      function (originalFetch) {\n        return function (input, init) {\n          var responsePromise\n          var context = callMonitored(beforeSend, null, [\n            observable,\n            input,\n            init\n          ])\n          if (context) {\n            responsePromise = originalFetch.call(\n              this,\n              context.input,\n              context.init\n            )\n            callMonitored(afterSend, null, [\n              observable,\n              responsePromise,\n              context\n            ])\n          } else {\n            responsePromise = originalFetch.call(this, input, init)\n          }\n          return responsePromise\n        }\n      }\n    )\n    return fetchMethod.stop\n  })\n}\n\nfunction beforeSend(observable, input, init) {\n  //   var method =\n  //       (init && init.method) || (input instanceof Request && input.method) || 'GET'\n  //     const methodFromParams =\n  //       (init && init.method) || (input instanceof Request && input.method)\n  //     const method = methodFromParams ? methodFromParams.toUpperCase() : 'GET'\n  var methodFromParams = init && init.method\n\n  if (methodFromParams === undefined && input instanceof Request) {\n    methodFromParams = input.method\n  }\n\n  var method =\n    methodFromParams !== undefined\n      ? String(methodFromParams).toUpperCase()\n      : 'GET'\n  var url = input instanceof Request ? input.url : normalizeUrl(String(input))\n\n  var startClocks = clocksNow()\n\n  var context = {\n    state: 'start',\n    init: init,\n    input: input,\n    method: method,\n    startClocks: startClocks,\n    url: url\n  }\n\n  observable.notify(context)\n\n  return context\n}\n\nfunction afterSend(observable, responsePromise, startContext) {\n  var reportFetch = function (response) {\n    var context = startContext\n    context.state = 'resolve'\n    // context.duration = elapsed(context.startClocks.timeStamp, timeStampNow())\n    if ('stack' in response || response instanceof Error) {\n      context.status = 0\n      context.isAborted =\n        response instanceof DOMException &&\n        response.code === DOMException.ABORT_ERR\n      context.error = response\n    } else if ('status' in response) {\n      context.response = response\n      try {\n        context.responseType =\n          (response.constructor === Response && response.type) || '' // issue The Response type getter can only be used on instances of Response\n      } catch (err) {\n        context.responseType = ''\n      }\n\n      context.status = response.status\n      context.isAborted = false\n    }\n    observable.notify(context)\n  }\n  responsePromise.then(monitor(reportFetch), monitor(reportFetch))\n}\n"],"mappings":"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","ignoreList":[]}