{"version":3,"file":"pageExitObservable.js","names":["_observable","require","_tools","_enums","_addEventListener","PageExitReason","HIDDEN","UNLOADING","PAGEHIDE","FROZEN","exports","createPageExitObservable","Observable","observable","visibilityChangeListener","addEventListeners","document","DOM_EVENT","VISIBILITY_CHANGE","FREEZE","PAGE_HIDE","event","type","visibilityState","notify","reason","capture","beforeUnloadListener","addEventListener","window","BEFORE_UNLOAD","stop","isPageExitReason","includes","values"],"sources":["../../src/browser/pageExitObservable.js"],"sourcesContent":["import { Observable } from '../helper/observable'\nimport { includes, values } from '../helper/tools'\nimport { DOM_EVENT } from '../helper/enums'\nimport {\n  addEventListener,\n  addEventListeners\n} from '../browser/addEventListener'\nexport var PageExitReason = {\n  HIDDEN: 'visibility_hidden',\n  UNLOADING: 'before_unload',\n  PAGEHIDE: 'page_hide',\n  FROZEN: 'page_frozen'\n}\n\nexport function createPageExitObservable() {\n  return new Observable(function (observable) {\n    /**\n     * Only event that guarantee to fire on mobile devices when the page transitions to background state\n     * (e.g. when user switches to a different application, goes to homescreen, etc), or is being unloaded.\n     */\n    var visibilityChangeListener = addEventListeners(\n      document,\n      [DOM_EVENT.VISIBILITY_CHANGE, DOM_EVENT.FREEZE, DOM_EVENT.PAGE_HIDE],\n      function (event) {\n        if (\n          event.type === DOM_EVENT.VISIBILITY_CHANGE &&\n          document.visibilityState === 'hidden'\n        ) {\n          /**\n           * Only event that guarantee to fire on mobile devices when the page transitions to background state\n           * (e.g. when user switches to a different application, goes to homescreen, etc), or is being unloaded.\n           */\n          observable.notify({ reason: PageExitReason.HIDDEN })\n        } else if (event.type === DOM_EVENT.FREEZE) {\n          /**\n           * After transitioning in background a tab can be freezed to preserve resources. (cf: https://developer.chrome.com/blog/page-lifecycle-api)\n           * Allow to collect events happening between hidden and frozen state.\n           */\n          observable.notify({ reason: PageExitReason.FROZEN })\n        }\n      },\n      { capture: true }\n    )\n\n    /**\n     * Safari does not support yet to send a request during:\n     * - a visibility change during doc unload (cf: https://bugs.webkit.org/show_bug.cgi?id=194897)\n     * - a page hide transition (cf: https://bugs.webkit.org/show_bug.cgi?id=188329)\n     */\n    var beforeUnloadListener = addEventListener(\n      window,\n      DOM_EVENT.BEFORE_UNLOAD,\n      function () {\n        observable.notify({ reason: PageExitReason.UNLOADING })\n      }\n    )\n\n    return function () {\n      visibilityChangeListener.stop()\n      beforeUnloadListener.stop()\n    }\n  })\n}\n\nexport function isPageExitReason(reason) {\n  return includes(values(PageExitReason), reason)\n}\n"],"mappings":";;;;;;;;AAAA,IAAAA,WAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AACA,IAAAE,MAAA,GAAAF,OAAA;AACA,IAAAG,iBAAA,GAAAH,OAAA;AAIO,IAAII,cAAc,GAAG;EAC1BC,MAAM,EAAE,mBAAmB;EAC3BC,SAAS,EAAE,eAAe;EAC1BC,QAAQ,EAAE,WAAW;EACrBC,MAAM,EAAE;AACV,CAAC;AAAAC,OAAA,CAAAL,cAAA,GAAAA,cAAA;AAEM,SAASM,wBAAwBA,CAAA,EAAG;EACzC,OAAO,IAAIC,sBAAU,CAAC,UAAUC,UAAU,EAAE;IAC1C;AACJ;AACA;AACA;IACI,IAAIC,wBAAwB,GAAG,IAAAC,mCAAiB,EAC9CC,QAAQ,EACR,CAACC,gBAAS,CAACC,iBAAiB,EAAED,gBAAS,CAACE,MAAM,EAAEF,gBAAS,CAACG,SAAS,CAAC,EACpE,UAAUC,KAAK,EAAE;MACf,IACEA,KAAK,CAACC,IAAI,KAAKL,gBAAS,CAACC,iBAAiB,IAC1CF,QAAQ,CAACO,eAAe,KAAK,QAAQ,EACrC;QACA;AACV;AACA;AACA;QACUV,UAAU,CAACW,MAAM,CAAC;UAAEC,MAAM,EAAEpB,cAAc,CAACC;QAAO,CAAC,CAAC;MACtD,CAAC,MAAM,IAAIe,KAAK,CAACC,IAAI,KAAKL,gBAAS,CAACE,MAAM,EAAE;QAC1C;AACV;AACA;AACA;QACUN,UAAU,CAACW,MAAM,CAAC;UAAEC,MAAM,EAAEpB,cAAc,CAACI;QAAO,CAAC,CAAC;MACtD;IACF,CAAC,EACD;MAAEiB,OAAO,EAAE;IAAK,CAClB,CAAC;;IAED;AACJ;AACA;AACA;AACA;IACI,IAAIC,oBAAoB,GAAG,IAAAC,kCAAgB,EACzCC,MAAM,EACNZ,gBAAS,CAACa,aAAa,EACvB,YAAY;MACVjB,UAAU,CAACW,MAAM,CAAC;QAAEC,MAAM,EAAEpB,cAAc,CAACE;MAAU,CAAC,CAAC;IACzD,CACF,CAAC;IAED,OAAO,YAAY;MACjBO,wBAAwB,CAACiB,IAAI,CAAC,CAAC;MAC/BJ,oBAAoB,CAACI,IAAI,CAAC,CAAC;IAC7B,CAAC;EACH,CAAC,CAAC;AACJ;AAEO,SAASC,gBAAgBA,CAACP,MAAM,EAAE;EACvC,OAAO,IAAAQ,eAAQ,EAAC,IAAAC,aAAM,EAAC7B,cAAc,CAAC,EAAEoB,MAAM,CAAC;AACjD","ignoreList":[]}