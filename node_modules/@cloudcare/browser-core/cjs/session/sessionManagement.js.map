{"version":3,"file":"sessionManagement.js","names":["_tools","require","_addEventListener2","_contextHistory","_sessionStore","_sessionConstants","_enums","_timer","_observable","VISIBILITY_CHECK_DELAY","ONE_MINUTE","exports","SESSION_CONTEXT_TIMEOUT_DELAY","SESSION_TIME_OUT_DELAY","stopCallbacks","startSessionManager","options","productKey","computeSessionState","renewObservable","Observable","expireObservable","sessionStore","startSessionStore","push","stop","sessionContextHistory","ContextHistory","subscribe","add","buildSessionContext","relativeNow","notify","closeActive","expandOrRenewSession","clocksOrigin","relative","trackActivity","trackVisibility","expandSession","id","getSession","trackingType","findActiveSession","startTime","find","expire","stopSessionManager","each","e","_addEventListeners","addEventListeners","window","DOM_EVENT","CLICK","TOUCH_START","KEY_DOWN","SCROLL","capture","passive","expandSessionWhenVisible","document","visibilityState","_addEventListener","addEventListener","VISIBILITY_CHANGE","visibilityCheckInterval","setInterval","clearInterval"],"sources":["../../src/session/sessionManagement.js"],"sourcesContent":["import { relativeNow, clocksOrigin, ONE_MINUTE, each } from '../helper/tools'\nimport {\n  addEventListeners,\n  addEventListener\n} from '../browser/addEventListener'\nimport { ContextHistory } from '../helper/contextHistory'\nimport { startSessionStore } from './sessionStore'\nimport { SESSION_TIME_OUT_DELAY } from './sessionConstants'\nimport { DOM_EVENT } from '../helper/enums'\nimport { clearInterval, setInterval } from '../helper/timer'\nimport { Observable } from '../helper/observable'\nexport var VISIBILITY_CHECK_DELAY = ONE_MINUTE\nvar SESSION_CONTEXT_TIMEOUT_DELAY = SESSION_TIME_OUT_DELAY\nvar stopCallbacks = []\n\nexport var startSessionManager = function (\n  options,\n  productKey,\n  computeSessionState\n) {\n  var renewObservable = new Observable()\n  var expireObservable = new Observable()\n  var sessionStore = startSessionStore(options, productKey, computeSessionState)\n  stopCallbacks.push(function () {\n    return sessionStore.stop()\n  })\n\n  var sessionContextHistory = new ContextHistory(SESSION_CONTEXT_TIMEOUT_DELAY)\n  stopCallbacks.push(function () {\n    return sessionContextHistory.stop()\n  })\n\n  sessionStore.renewObservable.subscribe(function () {\n    sessionContextHistory.add(buildSessionContext(), relativeNow())\n    renewObservable.notify()\n  })\n  sessionStore.expireObservable.subscribe(function () {\n    expireObservable.notify()\n    sessionContextHistory.closeActive(relativeNow())\n  })\n\n  sessionStore.expandOrRenewSession()\n  sessionContextHistory.add(buildSessionContext(), clocksOrigin().relative)\n\n  trackActivity(function () {\n    return sessionStore.expandOrRenewSession()\n  })\n  trackVisibility(function () {\n    return sessionStore.expandSession()\n  })\n\n  function buildSessionContext() {\n    return {\n      id: sessionStore.getSession().id,\n      trackingType: sessionStore.getSession()[productKey]\n    }\n  }\n\n  return {\n    findActiveSession: function (startTime) {\n      return sessionContextHistory.find(startTime)\n    },\n    renewObservable: renewObservable,\n    expireObservable: expireObservable,\n    expire: sessionStore.expire\n  }\n}\n\nexport function stopSessionManager() {\n  each(stopCallbacks, function (e) {\n    return e()\n  })\n  stopCallbacks = []\n}\n\nfunction trackActivity(expandOrRenewSession) {\n  var _addEventListeners = addEventListeners(\n    window,\n    [\n      DOM_EVENT.CLICK,\n      DOM_EVENT.TOUCH_START,\n      DOM_EVENT.KEY_DOWN,\n      DOM_EVENT.SCROLL\n    ],\n    expandOrRenewSession,\n    { capture: true, passive: true }\n  )\n  stopCallbacks.push(_addEventListeners.stop)\n}\n\nfunction trackVisibility(expandSession) {\n  var expandSessionWhenVisible = function () {\n    if (document.visibilityState === 'visible') {\n      expandSession()\n    }\n  }\n  var _addEventListener = addEventListener(\n    document,\n    DOM_EVENT.VISIBILITY_CHANGE,\n    expandSessionWhenVisible\n  )\n  stopCallbacks.push(_addEventListener.stop)\n\n  var visibilityCheckInterval = setInterval(\n    expandSessionWhenVisible,\n    VISIBILITY_CHECK_DELAY\n  )\n  stopCallbacks.push(function () {\n    clearInterval(visibilityCheckInterval)\n  })\n}\n"],"mappings":"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","ignoreList":[]}