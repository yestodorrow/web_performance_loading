"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.STORAGE_POLL_DELAY = void 0;
exports.startSessionStore = startSessionStore;
var _cookie = require("../browser/cookie");
var _observable = require("../helper/observable");
var _tools = require("../helper/tools");
var _sessionConstants = require("./sessionConstants");
var _sessionCookieStore = require("./sessionCookieStore");
var _timer = require("../helper/timer");
var STORAGE_POLL_DELAY = _tools.ONE_SECOND;
/**
 * Different session concepts:
 * - tracked, the session has an id and is updated along the user navigation
 * - not tracked, the session does not have an id but it is updated along the user navigation
 * - inactive, no session in store or session expired, waiting for a renew session
 */
exports.STORAGE_POLL_DELAY = STORAGE_POLL_DELAY;
function startSessionStore(options, productKey, computeSessionState) {
  var renewObservable = new _observable.Observable();
  var expireObservable = new _observable.Observable();
  var watchSessionTimeoutId = (0, _timer.setInterval)(watchSession, STORAGE_POLL_DELAY);
  var sessionCache = retrieveActiveSession();
  var _throttleExpandOrRenewSession = (0, _tools.throttle)(function () {
    var isTracked;
    (0, _sessionCookieStore.withCookieLockAccess)({
      options: options,
      process: function process(cookieSession) {
        var synchronizedSession = synchronizeSession(cookieSession);
        isTracked = expandOrRenewCookie(synchronizedSession);
        return synchronizedSession;
      },
      after: function after(cookieSession) {
        if (isTracked && !hasSessionInCache()) {
          renewSession(cookieSession);
        }
        sessionCache = cookieSession;
      }
    });
  }, STORAGE_POLL_DELAY);
  var throttledExpandOrRenewSession = _throttleExpandOrRenewSession.throttled;
  var cancelExpandOrRenewSession = _throttleExpandOrRenewSession.cancel;
  //   function expandOrRenewSession() {
  //     var isTracked
  //     withCookieLockAccess({
  //       options: options,
  //       process: function (cookieSession) {
  //         var synchronizedSession = synchronizeSession(cookieSession)
  //         isTracked = expandOrRenewCookie(synchronizedSession)
  //         return synchronizedSession
  //       },
  //       after: function (cookieSession) {
  //         if (isTracked && !hasSessionInCache()) {
  //           renewSession(cookieSession)
  //         }
  //         sessionCache = cookieSession
  //       }
  //     })
  //   }

  function expandSession() {
    (0, _sessionCookieStore.withCookieLockAccess)({
      options: options,
      process: function process(cookieSession) {
        return hasSessionInCache() ? synchronizeSession(cookieSession) : undefined;
      }
    });
  }

  /**
   * allows two behaviors:
   * - if the session is active, synchronize the session cache without updating the session cookie
   * - if the session is not active, clear the session cookie and expire the session cache
   */
  function watchSession() {
    (0, _sessionCookieStore.withCookieLockAccess)({
      options: options,
      process: function process(cookieSession) {
        return !isActiveSession(cookieSession) ? {} : undefined;
      },
      after: synchronizeSession
    });
  }
  function synchronizeSession(cookieSession) {
    if (!isActiveSession(cookieSession)) {
      cookieSession = {};
    }
    if (hasSessionInCache()) {
      if (isSessionInCacheOutdated(cookieSession)) {
        expireSessionInCache();
      } else {
        sessionCache = cookieSession;
      }
    }
    return cookieSession;
  }
  function expandOrRenewCookie(cookieSession) {
    var sessionState = computeSessionState(cookieSession[productKey]);
    var trackingType = sessionState.trackingType;
    var isTracked = sessionState.isTracked;
    cookieSession[productKey] = trackingType;
    if (isTracked && !cookieSession.id) {
      cookieSession.id = (0, _tools.UUID)();
      cookieSession.created = String((0, _tools.dateNow)());
    }
    return isTracked;
  }
  function hasSessionInCache() {
    return sessionCache[productKey] !== undefined;
  }
  function isSessionInCacheOutdated(cookieSession) {
    return sessionCache.id !== cookieSession.id || sessionCache[productKey] !== cookieSession[productKey];
  }
  function expireSessionInCache() {
    sessionCache = {};
    expireObservable.notify();
  }
  function renewSession(cookieSession) {
    sessionCache = cookieSession;
    renewObservable.notify();
  }
  function retrieveActiveSession() {
    var session = (0, _sessionCookieStore.retrieveSession)();
    if (isActiveSession(session)) {
      return session;
    }
    return {};
  }
  function isActiveSession(session) {
    // created and expire can be undefined for versions which was not storing them
    // these checks could be removed when older versions will not be available/live anymore
    return (session.created === undefined || (0, _tools.dateNow)() - Number(session.created) < _sessionConstants.SESSION_TIME_OUT_DELAY) && (session.expire === undefined || (0, _tools.dateNow)() < Number(session.expire));
  }
  return {
    expandOrRenewSession: throttledExpandOrRenewSession,
    expandSession: expandSession,
    getSession: function getSession() {
      return sessionCache;
    },
    renewObservable: renewObservable,
    expireObservable: expireObservable,
    expire: function expire() {
      cancelExpandOrRenewSession();
      (0, _sessionCookieStore.clearSession)(options);
      synchronizeSession({});
    },
    stop: function stop() {
      (0, _timer.clearInterval)(watchSessionTimeoutId);
    }
  };
}
//# sourceMappingURL=sessionStore.js.map