{"version":3,"file":"sessionCookieStore.js","names":["_cookie","require","_tools","_sessionConstants","_timer","SESSION_ENTRY_REGEXP","SESSION_ENTRY_SEPARATOR","SESSION_COOKIE_NAME","exports","LOCK_RETRY_DELAY","MAX_NUMBER_OF_LOCK_RETRIES","bufferedOperations","ongoingOperations","withCookieLockAccess","operations","numberOfRetries","push","next","currentLock","currentSession","retrieveSession","isCookieLockEnabled","lock","retryLater","UUID","setSession","options","processedSession","process","persistSession","isExpiredState","after","isChromium","currentNumberOfRetries","setTimeout","undefined","nextOperations","shift","session","clearSession","expire","String","dateNow","SESSION_EXPIRATION_DELAY","setCookie","toSessionString","map","objectEntries","item","join","sessionString","getCookie","isValidSessionString","each","split","entry","matches","exec","key","value","indexOf","test","isEmptyObject"],"sources":["../../src/session/sessionCookieStore.js"],"sourcesContent":["import { getCookie, setCookie } from '../browser/cookie'\nimport {\n  isChromium,\n  dateNow,\n  isEmptyObject,\n  UUID,\n  objectEntries,\n  map,\n  each\n} from '../helper/tools'\nimport { SESSION_EXPIRATION_DELAY } from './sessionConstants'\nimport { setTimeout } from '../helper/timer'\nvar SESSION_ENTRY_REGEXP = /^([a-z]+)=([a-z0-9-]+)$/\nvar SESSION_ENTRY_SEPARATOR = '&'\n\nexport var SESSION_COOKIE_NAME = '_dataflux_s'\n\n// arbitrary values\nexport var LOCK_RETRY_DELAY = 10\nexport var MAX_NUMBER_OF_LOCK_RETRIES = 100\n\nvar bufferedOperations = []\nvar ongoingOperations\n\nexport function withCookieLockAccess(operations, numberOfRetries) {\n  if (typeof numberOfRetries === 'undefined') {\n    numberOfRetries = 0\n  }\n  if (!ongoingOperations) {\n    ongoingOperations = operations\n  }\n  if (operations !== ongoingOperations) {\n    bufferedOperations.push(operations)\n    return\n  }\n  if (numberOfRetries >= MAX_NUMBER_OF_LOCK_RETRIES) {\n    next()\n    return\n  }\n  var currentLock\n  var currentSession = retrieveSession()\n  if (isCookieLockEnabled()) {\n    // if someone has lock, retry later\n    if (currentSession.lock) {\n      retryLater(operations, numberOfRetries)\n      return\n    }\n    // acquire lock\n    currentLock = UUID()\n    currentSession.lock = currentLock\n    setSession(currentSession, operations.options)\n    // if lock is not acquired, retry later\n    currentSession = retrieveSession()\n    if (currentSession.lock !== currentLock) {\n      retryLater(operations, numberOfRetries)\n      return\n    }\n  }\n  var processedSession = operations.process(currentSession)\n  if (isCookieLockEnabled()) {\n    // if lock corrupted after process, retry later\n    currentSession = retrieveSession()\n    if (currentSession.lock !== currentLock) {\n      retryLater(operations, numberOfRetries)\n      return\n    }\n  }\n  if (processedSession) {\n    persistSession(processedSession, operations.options)\n  }\n  if (isCookieLockEnabled()) {\n    // correctly handle lock around expiration would require to handle this case properly at several levels\n    // since we don't have evidence of lock issues around expiration, let's just not do the corruption check for it\n    if (!(processedSession && isExpiredState(processedSession))) {\n      // if lock corrupted after persist, retry later\n      currentSession = retrieveSession()\n      if (currentSession.lock !== currentLock) {\n        retryLater(operations, numberOfRetries)\n        return\n      }\n      delete currentSession.lock\n      setSession(currentSession, operations.options)\n      processedSession = currentSession\n    }\n  }\n  // call after even if session is not persisted in order to perform operations on\n  // up-to-date cookie value, the value could have been modified by another tab\n  if (operations.after) {\n    operations.after(processedSession || currentSession)\n  }\n  next()\n}\n\n/**\n * Cookie lock strategy allows mitigating issues due to concurrent access to cookie.\n * This issue concerns only chromium browsers and enabling this on firefox increase cookie write failures.\n */\nfunction isCookieLockEnabled() {\n  return isChromium()\n}\n\nfunction retryLater(operations, currentNumberOfRetries) {\n  setTimeout(function () {\n    withCookieLockAccess(operations, currentNumberOfRetries + 1)\n  }, LOCK_RETRY_DELAY)\n}\n\nfunction next() {\n  ongoingOperations = undefined\n  var nextOperations = bufferedOperations.shift()\n  if (nextOperations) {\n    withCookieLockAccess(nextOperations)\n  }\n}\n\nexport function persistSession(session, options) {\n  if (isExpiredState(session)) {\n    clearSession(options)\n    return\n  }\n  session.expire = String(dateNow() + SESSION_EXPIRATION_DELAY)\n  setSession(session, options)\n}\n\nfunction setSession(session, options) {\n  setCookie(\n    SESSION_COOKIE_NAME,\n    toSessionString(session),\n    SESSION_EXPIRATION_DELAY,\n    options\n  )\n}\n\nexport function toSessionString(session) {\n  return map(objectEntries(session), function (item) {\n    return item[0] + '=' + item[1]\n  }).join(SESSION_ENTRY_SEPARATOR)\n}\n\nexport function retrieveSession() {\n  var sessionString = getCookie(SESSION_COOKIE_NAME)\n  var session = {}\n  if (isValidSessionString(sessionString)) {\n    each(sessionString.split(SESSION_ENTRY_SEPARATOR), function (entry) {\n      var matches = SESSION_ENTRY_REGEXP.exec(entry)\n      if (matches !== null) {\n        var key = matches[1]\n        var value = matches[2]\n        session[key] = value\n      }\n    })\n  }\n  return session\n}\n\nfunction isValidSessionString(sessionString) {\n  return (\n    sessionString !== undefined &&\n    (sessionString.indexOf(SESSION_ENTRY_SEPARATOR) !== -1 ||\n      SESSION_ENTRY_REGEXP.test(sessionString))\n  )\n}\n\nfunction isExpiredState(session) {\n  return isEmptyObject(session)\n}\nexport function clearSession(options) {\n  setCookie(SESSION_COOKIE_NAME, '', 0, options)\n}\n"],"mappings":"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","ignoreList":[]}