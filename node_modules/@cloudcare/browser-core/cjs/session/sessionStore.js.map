{"version":3,"file":"sessionStore.js","names":["_cookie","require","_observable","_tools","_sessionConstants","_sessionCookieStore","_timer","STORAGE_POLL_DELAY","ONE_SECOND","exports","startSessionStore","options","productKey","computeSessionState","renewObservable","Observable","expireObservable","watchSessionTimeoutId","setInterval","watchSession","sessionCache","retrieveActiveSession","_throttleExpandOrRenewSession","throttle","isTracked","withCookieLockAccess","process","cookieSession","synchronizedSession","synchronizeSession","expandOrRenewCookie","after","hasSessionInCache","renewSession","throttledExpandOrRenewSession","throttled","cancelExpandOrRenewSession","cancel","expandSession","undefined","isActiveSession","isSessionInCacheOutdated","expireSessionInCache","sessionState","trackingType","id","UUID","created","String","dateNow","notify","session","retrieveSession","Number","SESSION_TIME_OUT_DELAY","expire","expandOrRenewSession","getSession","clearSession","stop","clearInterval"],"sources":["../../src/session/sessionStore.js"],"sourcesContent":["import { COOKIE_ACCESS_DELAY } from '../browser/cookie'\nimport { Observable } from '../helper/observable'\nimport { dateNow, UUID, throttle, ONE_SECOND } from '../helper/tools'\nimport { SESSION_TIME_OUT_DELAY } from './sessionConstants'\nimport {\n  retrieveSession,\n  withCookieLockAccess,\n  clearSession\n} from './sessionCookieStore'\nimport { clearInterval, setInterval } from '../helper/timer'\n\nexport var STORAGE_POLL_DELAY = ONE_SECOND\n/**\n * Different session concepts:\n * - tracked, the session has an id and is updated along the user navigation\n * - not tracked, the session does not have an id but it is updated along the user navigation\n * - inactive, no session in store or session expired, waiting for a renew session\n */\nexport function startSessionStore(options, productKey, computeSessionState) {\n  var renewObservable = new Observable()\n  var expireObservable = new Observable()\n\n  var watchSessionTimeoutId = setInterval(watchSession, STORAGE_POLL_DELAY)\n  var sessionCache = retrieveActiveSession()\n  var _throttleExpandOrRenewSession = throttle(function () {\n    var isTracked\n    withCookieLockAccess({\n      options: options,\n      process: function (cookieSession) {\n        var synchronizedSession = synchronizeSession(cookieSession)\n        isTracked = expandOrRenewCookie(synchronizedSession)\n        return synchronizedSession\n      },\n      after: function (cookieSession) {\n        if (isTracked && !hasSessionInCache()) {\n          renewSession(cookieSession)\n        }\n        sessionCache = cookieSession\n      }\n    })\n  }, STORAGE_POLL_DELAY)\n  var throttledExpandOrRenewSession = _throttleExpandOrRenewSession.throttled\n  var cancelExpandOrRenewSession = _throttleExpandOrRenewSession.cancel\n  //   function expandOrRenewSession() {\n  //     var isTracked\n  //     withCookieLockAccess({\n  //       options: options,\n  //       process: function (cookieSession) {\n  //         var synchronizedSession = synchronizeSession(cookieSession)\n  //         isTracked = expandOrRenewCookie(synchronizedSession)\n  //         return synchronizedSession\n  //       },\n  //       after: function (cookieSession) {\n  //         if (isTracked && !hasSessionInCache()) {\n  //           renewSession(cookieSession)\n  //         }\n  //         sessionCache = cookieSession\n  //       }\n  //     })\n  //   }\n\n  function expandSession() {\n    withCookieLockAccess({\n      options: options,\n      process: function (cookieSession) {\n        return hasSessionInCache()\n          ? synchronizeSession(cookieSession)\n          : undefined\n      }\n    })\n  }\n\n  /**\n   * allows two behaviors:\n   * - if the session is active, synchronize the session cache without updating the session cookie\n   * - if the session is not active, clear the session cookie and expire the session cache\n   */\n  function watchSession() {\n    withCookieLockAccess({\n      options: options,\n      process: function (cookieSession) {\n        return !isActiveSession(cookieSession) ? {} : undefined\n      },\n      after: synchronizeSession\n    })\n  }\n\n  function synchronizeSession(cookieSession) {\n    if (!isActiveSession(cookieSession)) {\n      cookieSession = {}\n    }\n    if (hasSessionInCache()) {\n      if (isSessionInCacheOutdated(cookieSession)) {\n        expireSessionInCache()\n      } else {\n        sessionCache = cookieSession\n      }\n    }\n    return cookieSession\n  }\n\n  function expandOrRenewCookie(cookieSession) {\n    var sessionState = computeSessionState(cookieSession[productKey])\n    var trackingType = sessionState.trackingType\n    var isTracked = sessionState.isTracked\n    cookieSession[productKey] = trackingType\n    if (isTracked && !cookieSession.id) {\n      cookieSession.id = UUID()\n      cookieSession.created = String(dateNow())\n    }\n    return isTracked\n  }\n\n  function hasSessionInCache() {\n    return sessionCache[productKey] !== undefined\n  }\n\n  function isSessionInCacheOutdated(cookieSession) {\n    return (\n      sessionCache.id !== cookieSession.id ||\n      sessionCache[productKey] !== cookieSession[productKey]\n    )\n  }\n\n  function expireSessionInCache() {\n    sessionCache = {}\n    expireObservable.notify()\n  }\n\n  function renewSession(cookieSession) {\n    sessionCache = cookieSession\n    renewObservable.notify()\n  }\n\n  function retrieveActiveSession() {\n    var session = retrieveSession()\n    if (isActiveSession(session)) {\n      return session\n    }\n    return {}\n  }\n\n  function isActiveSession(session) {\n    // created and expire can be undefined for versions which was not storing them\n    // these checks could be removed when older versions will not be available/live anymore\n    return (\n      (session.created === undefined ||\n        dateNow() - Number(session.created) < SESSION_TIME_OUT_DELAY) &&\n      (session.expire === undefined || dateNow() < Number(session.expire))\n    )\n  }\n\n  return {\n    expandOrRenewSession: throttledExpandOrRenewSession,\n    expandSession: expandSession,\n    getSession: function () {\n      return sessionCache\n    },\n    renewObservable: renewObservable,\n    expireObservable: expireObservable,\n    expire: function () {\n      cancelExpandOrRenewSession()\n      clearSession(options)\n      synchronizeSession({})\n    },\n    stop: function () {\n      clearInterval(watchSessionTimeoutId)\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}