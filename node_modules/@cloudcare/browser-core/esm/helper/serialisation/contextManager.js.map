{"version":3,"file":"contextManager.js","names":["computeBytesCount","deepClone","throttle","getType","sanitize","jsonStringify","Observable","warnIfCustomerDataLimitReached","BYTES_COMPUTATION_THROTTLING_DELAY","createContextManager","customerDataType","computeBytesCountImpl","context","bytesCountCache","alreadyWarned","changeObservable","computeBytesCountThrottled","throttled","contextManager","getBytesCount","get","add","key","value","notify","remove","set","newContext","getContext","setContext","clearContext","setContextProperty","property","removeContextProperty"],"sources":["../../../src/helper/serialisation/contextManager.js"],"sourcesContent":["import { computeBytesCount } from '../byteUtils'\nimport { deepClone, throttle, getType } from '../tools'\nimport { sanitize } from '../sanitize'\nimport { jsonStringify } from './jsonStringify'\nimport { Observable } from '../observable'\nimport { warnIfCustomerDataLimitReached } from './heavyCustomerDataWarning'\n\nexport var BYTES_COMPUTATION_THROTTLING_DELAY = 200\n\nexport function createContextManager(customerDataType, computeBytesCountImpl) {\n  if (typeof computeBytesCountImpl === 'undefined') {\n    computeBytesCountImpl = computeBytesCount\n  }\n  var context = {}\n  var bytesCountCache\n  var alreadyWarned = false\n  var changeObservable = new Observable()\n  // Throttle the bytes computation to minimize the impact on performance.\n  // Especially useful if the user call context APIs synchronously multiple times in a row\n  var computeBytesCountThrottled = throttle(function (context) {\n    bytesCountCache = computeBytesCountImpl(jsonStringify(context))\n    if (!alreadyWarned) {\n      alreadyWarned = warnIfCustomerDataLimitReached(\n        bytesCountCache,\n        customerDataType\n      )\n    }\n  }, BYTES_COMPUTATION_THROTTLING_DELAY).throttled\n\n  var contextManager = {\n    getBytesCount: function () {\n      return bytesCountCache\n    },\n    /** @deprecated use getContext instead */\n    get: function () {\n      return context\n    },\n\n    /** @deprecated use setContextProperty instead */\n    add: function (key, value) {\n      context[key] = value\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    /** @deprecated renamed to removeContextProperty */\n    remove: function (key) {\n      delete context[key]\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    /** @deprecated use setContext instead */\n    set: function (newContext) {\n      context = newContext\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    getContext: function () {\n      return deepClone(context)\n    },\n\n    setContext: function (newContext) {\n      if (getType(newContext) === 'object') {\n        context = sanitize(newContext)\n        computeBytesCountThrottled(context)\n      } else {\n        contextManager.clearContext()\n      }\n      changeObservable.notify()\n    },\n\n    setContextProperty: function (key, property) {\n      context[key] = deepClone(property)\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    removeContextProperty: function (key) {\n      delete context[key]\n      computeBytesCountThrottled(context)\n      changeObservable.notify()\n    },\n\n    clearContext: function () {\n      context = {}\n      bytesCountCache = 0\n      changeObservable.notify()\n    },\n    changeObservable: changeObservable\n  }\n  return contextManager\n}\n"],"mappings":"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","ignoreList":[]}