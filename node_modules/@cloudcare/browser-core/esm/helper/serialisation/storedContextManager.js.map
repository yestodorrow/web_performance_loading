{"version":3,"file":"storedContextManager.js","names":["computeBytesCount","DOM_EVENT","map","addEventListener","createContextManager","CONTEXT_STORE_KEY_PREFIX","storageListeners","createStoredContextManager","productKey","customerDataType","computeBytesCountImpl","undefined","storageKey","buildStorageKey","contextManager","synchronizeWithStorage","push","window","STORAGE","params","key","changeObservable","subscribe","dumpToStorage","rawContext","localStorage","getItem","context","JSON","parse","setContext","setItem","stringify","getContext","removeStorageListeners","listener","stop"],"sources":["../../../src/helper/serialisation/storedContextManager.js"],"sourcesContent":["import { computeBytesCount } from '../byteUtils'\nimport { DOM_EVENT } from '../enums'\nimport { map } from '../tools'\nimport { addEventListener } from '../../browser/addEventListener'\nimport { createContextManager } from './contextManager'\nvar CONTEXT_STORE_KEY_PREFIX = '_gc_s'\n\nvar storageListeners = []\n\nexport function createStoredContextManager(\n  productKey,\n  customerDataType,\n  computeBytesCountImpl\n) {\n  if (computeBytesCountImpl === undefined) {\n    computeBytesCountImpl = computeBytesCount\n  }\n  var storageKey = buildStorageKey(productKey, customerDataType)\n  var contextManager = createContextManager(\n    customerDataType,\n    computeBytesCountImpl\n  )\n\n  synchronizeWithStorage()\n  storageListeners.push(\n    addEventListener(window, DOM_EVENT.STORAGE, function (params) {\n      if (storageKey === params.key) {\n        synchronizeWithStorage()\n      }\n    })\n  )\n  contextManager.changeObservable.subscribe(dumpToStorage)\n  function synchronizeWithStorage() {\n    var rawContext = localStorage.getItem(storageKey)\n    var context = rawContext !== null ? JSON.parse(rawContext) : {}\n    contextManager.setContext(context)\n  }\n\n  function dumpToStorage() {\n    localStorage.setItem(\n      storageKey,\n      JSON.stringify(contextManager.getContext())\n    )\n  }\n  return contextManager\n}\n\nexport function buildStorageKey(productKey, customerDataType) {\n  return CONTEXT_STORE_KEY_PREFIX + '_' + productKey + '_' + customerDataType\n}\n\nexport function removeStorageListeners() {\n  map(storageListeners, function (listener) {\n    listener.stop()\n  })\n}\n"],"mappings":"AAAA,SAASA,iBAAiB,QAAQ,cAAc;AAChD,SAASC,SAAS,QAAQ,UAAU;AACpC,SAASC,GAAG,QAAQ,UAAU;AAC9B,SAASC,gBAAgB,QAAQ,gCAAgC;AACjE,SAASC,oBAAoB,QAAQ,kBAAkB;AACvD,IAAIC,wBAAwB,GAAG,OAAO;AAEtC,IAAIC,gBAAgB,GAAG,EAAE;AAEzB,OAAO,SAASC,0BAA0BA,CACxCC,UAAU,EACVC,gBAAgB,EAChBC,qBAAqB,EACrB;EACA,IAAIA,qBAAqB,KAAKC,SAAS,EAAE;IACvCD,qBAAqB,GAAGV,iBAAiB;EAC3C;EACA,IAAIY,UAAU,GAAGC,eAAe,CAACL,UAAU,EAAEC,gBAAgB,CAAC;EAC9D,IAAIK,cAAc,GAAGV,oBAAoB,CACvCK,gBAAgB,EAChBC,qBACF,CAAC;EAEDK,sBAAsB,CAAC,CAAC;EACxBT,gBAAgB,CAACU,IAAI,CACnBb,gBAAgB,CAACc,MAAM,EAAEhB,SAAS,CAACiB,OAAO,EAAE,UAAUC,MAAM,EAAE;IAC5D,IAAIP,UAAU,KAAKO,MAAM,CAACC,GAAG,EAAE;MAC7BL,sBAAsB,CAAC,CAAC;IAC1B;EACF,CAAC,CACH,CAAC;EACDD,cAAc,CAACO,gBAAgB,CAACC,SAAS,CAACC,aAAa,CAAC;EACxD,SAASR,sBAAsBA,CAAA,EAAG;IAChC,IAAIS,UAAU,GAAGC,YAAY,CAACC,OAAO,CAACd,UAAU,CAAC;IACjD,IAAIe,OAAO,GAAGH,UAAU,KAAK,IAAI,GAAGI,IAAI,CAACC,KAAK,CAACL,UAAU,CAAC,GAAG,CAAC,CAAC;IAC/DV,cAAc,CAACgB,UAAU,CAACH,OAAO,CAAC;EACpC;EAEA,SAASJ,aAAaA,CAAA,EAAG;IACvBE,YAAY,CAACM,OAAO,CAClBnB,UAAU,EACVgB,IAAI,CAACI,SAAS,CAAClB,cAAc,CAACmB,UAAU,CAAC,CAAC,CAC5C,CAAC;EACH;EACA,OAAOnB,cAAc;AACvB;AAEA,OAAO,SAASD,eAAeA,CAACL,UAAU,EAAEC,gBAAgB,EAAE;EAC5D,OAAOJ,wBAAwB,GAAG,GAAG,GAAGG,UAAU,GAAG,GAAG,GAAGC,gBAAgB;AAC7E;AAEA,OAAO,SAASyB,sBAAsBA,CAAA,EAAG;EACvChC,GAAG,CAACI,gBAAgB,EAAE,UAAU6B,QAAQ,EAAE;IACxCA,QAAQ,CAACC,IAAI,CAAC,CAAC;EACjB,CAAC,CAAC;AACJ","ignoreList":[]}