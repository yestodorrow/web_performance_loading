{"version":3,"file":"contextHistory.js","names":["relativeNow","ONE_MINUTE","filter","map","addDuration","setInterval","clearInterval","END_OF_TIMES","Infinity","CLEAR_OLD_CONTEXTS_INTERVAL","ContextHistory","expireDelay","maxEntries","entries","_this","clearOldContextsInterval","clearOldContexts","prototype","add","context","startTime","entry","endTime","remove","index","indexOf","splice","close","length","pop","unshift","find","_iterator","_createForOfIteratorHelper","_step","s","n","done","value","err","e","f","closeActive","latestEntry","findAll","duration","result","reset","stop","oldTimeThreshold"],"sources":["../../src/helper/contextHistory.js"],"sourcesContent":["import { relativeNow, ONE_MINUTE, filter, map, addDuration } from './tools'\nimport { setInterval, clearInterval } from './timer'\nvar END_OF_TIMES = Infinity\n\nexport var CLEAR_OLD_CONTEXTS_INTERVAL = ONE_MINUTE\nexport function ContextHistory(expireDelay, maxEntries) {\n  this.expireDelay = expireDelay\n  this.entries = []\n  this.maxEntries = maxEntries\n  var _this = this\n  this.clearOldContextsInterval = setInterval(function () {\n    _this.clearOldContexts()\n  }, CLEAR_OLD_CONTEXTS_INTERVAL)\n}\n\nContextHistory.prototype.add = function (context, startTime) {\n  var _this = this\n  var entry = {\n    context: context,\n    startTime: startTime,\n    endTime: END_OF_TIMES,\n    remove: function () {\n      var index = _this.entries.indexOf(entry)\n      if (index >= 0) {\n        _this.entries.splice(index, 1)\n      }\n    },\n    close: function (endTime) {\n      entry.endTime = endTime\n    }\n  }\n  if (this.maxEntries && this.entries.length >= this.maxEntries) {\n    this.entries.pop()\n  }\n  this.entries.unshift(entry)\n  return entry\n}\nContextHistory.prototype.find = function (startTime) {\n  if (typeof startTime === 'undefined') {\n    startTime = END_OF_TIMES\n  }\n  for (var entry of this.entries) {\n    if (entry.startTime <= startTime) {\n      if (startTime <= entry.endTime) {\n        return entry.context\n      }\n      break\n    }\n  }\n  //\n}\n/**\n * Helper function to close the currently active context, if any. This method assumes that entries\n * are not overlapping.\n */\nContextHistory.prototype.closeActive = function (endTime) {\n  var latestEntry = this.entries[0]\n  if (latestEntry && latestEntry.endTime === END_OF_TIMES) {\n    latestEntry.close(endTime)\n  }\n}\n/**\n * Return all contexts that were active during `startTime`, or all currently active contexts if no\n * `startTime` is provided.\n */\nContextHistory.prototype.findAll = function (startTime, duration) {\n  if (typeof duration === 'undefined') {\n    duration = 0\n  }\n  if (typeof startTime === 'undefined') {\n    startTime = END_OF_TIMES\n  }\n  var endTime = addDuration(startTime, duration)\n  var result = filter(this.entries, function (entry) {\n    return entry.startTime <= endTime && startTime <= entry.endTime\n  })\n  return map(result, function (entry) {\n    return entry.context\n  })\n}\n/**\n * Remove all entries from this collection.\n */\nContextHistory.prototype.reset = function () {\n  this.entries = []\n}\n/**\n * Stop internal garbage collection of past entries.\n */\nContextHistory.prototype.stop = function () {\n  clearInterval(this.clearOldContextsInterval)\n}\nContextHistory.prototype.clearOldContexts = function () {\n  var oldTimeThreshold = relativeNow() - this.expireDelay\n  while (\n    this.entries.length > 0 &&\n    this.entries[this.entries.length - 1].endTime < oldTimeThreshold\n  ) {\n    this.entries.pop()\n  }\n}\n"],"mappings":"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","ignoreList":[]}