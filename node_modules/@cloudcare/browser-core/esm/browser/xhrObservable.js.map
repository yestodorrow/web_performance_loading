{"version":3,"file":"xhrObservable.js","names":["instrumentMethodAndCallOriginal","Observable","normalizeUrl","shallowClone","elapsed","relativeNow","clocksNow","timeStampNow","UUID","addEventListener","xhrObservable","xhrContexts","DATA_FLUX_REQUEST_ID_KEY","initXhrObservable","createXhrObservable","observable","openInstrumentMethod","XMLHttpRequest","prototype","before","openXhr","sendInstrumentMethod","sendXhr","call","abortInstrumentMethod","abortXhr","stop","method","url","requestUUID","state","String","toUpperCase","context","startContext","startTime","startClocks","isAborted","xhr","hasBeenReported","stopInstrumentingOnReadyStateChange","readyState","DONE","onEnd","unsubscribeLoadEndListener","completeContext","duration","timeStamp","status","notify","clearRequestId"],"sources":["../../src/browser/xhrObservable.js"],"sourcesContent":["import { instrumentMethodAndCallOriginal } from '../helper/instrumentMethod'\nimport { Observable } from '../helper/observable'\nimport { normalizeUrl } from '../helper/urlPolyfill'\nimport {\n  shallowClone,\n  elapsed,\n  relativeNow,\n  clocksNow,\n  timeStampNow,\n  UUID\n} from '../helper/tools'\nimport { addEventListener } from '../browser/addEventListener'\nvar xhrObservable\nvar xhrContexts = {}\nvar DATA_FLUX_REQUEST_ID_KEY = '_DATAFLUX_REQUEST_UUID'\nexport function initXhrObservable() {\n  if (!xhrObservable) {\n    xhrObservable = createXhrObservable()\n  }\n  return xhrObservable\n}\n\nfunction createXhrObservable() {\n  return new Observable(function (observable) {\n    var openInstrumentMethod = instrumentMethodAndCallOriginal(\n      XMLHttpRequest.prototype,\n      'open',\n      {\n        before: openXhr\n      }\n    )\n\n    var sendInstrumentMethod = instrumentMethodAndCallOriginal(\n      XMLHttpRequest.prototype,\n      'send',\n      {\n        before: function () {\n          sendXhr.call(this, observable)\n        }\n      }\n    )\n\n    var abortInstrumentMethod = instrumentMethodAndCallOriginal(\n      XMLHttpRequest.prototype,\n      'abort',\n      {\n        before: abortXhr\n      }\n    )\n\n    return function () {\n      openInstrumentMethod.stop()\n      sendInstrumentMethod.stop()\n      abortInstrumentMethod.stop()\n    }\n  })\n}\n\nfunction openXhr(method, url) {\n  var requestUUID = this[DATA_FLUX_REQUEST_ID_KEY] || UUID()\n  this[DATA_FLUX_REQUEST_ID_KEY] = requestUUID\n  xhrContexts[requestUUID] = {\n    state: 'open',\n    method: String(method).toUpperCase(),\n    url: normalizeUrl(String(url))\n  }\n}\n\nfunction sendXhr(observable) {\n  var context = xhrContexts[this[DATA_FLUX_REQUEST_ID_KEY]]\n  if (!context) {\n    return\n  }\n  var startContext = context\n  startContext.state = 'start'\n  startContext.startTime = relativeNow()\n  startContext.startClocks = clocksNow()\n  startContext.isAborted = false\n  startContext.xhr = this\n  var hasBeenReported = false\n  var stopInstrumentingOnReadyStateChange = instrumentMethodAndCallOriginal(\n    this,\n    'onreadystatechange',\n    {\n      before: function () {\n        if (this.readyState === XMLHttpRequest.DONE) {\n          // Try to report the XHR as soon as possible, because the XHR may be mutated by the\n          // application during a future event. For example, Angular is calling .abort() on\n          // completed requests during a onreadystatechange event, so the status becomes '0'\n          // before the request is collected.\n          onEnd.call(this)\n        }\n      }\n    }\n  ).stop\n\n  var onEnd = function () {\n    unsubscribeLoadEndListener()\n    stopInstrumentingOnReadyStateChange()\n    if (hasBeenReported) {\n      return\n    }\n    hasBeenReported = true\n    var completeContext = context\n    completeContext.state = 'complete'\n    completeContext.duration = elapsed(\n      startContext.startClocks.timeStamp,\n      timeStampNow()\n    )\n    completeContext.status = this.status\n    observable.notify(shallowClone(completeContext))\n    clearRequestId.call(this)\n  }\n  var unsubscribeLoadEndListener = addEventListener(this, 'loadend', onEnd).stop\n  observable.notify(startContext)\n}\nfunction clearRequestId() {\n  delete xhrContexts[this[DATA_FLUX_REQUEST_ID_KEY]]\n  delete this[DATA_FLUX_REQUEST_ID_KEY]\n}\nfunction abortXhr() {\n  var context = xhrContexts[this[DATA_FLUX_REQUEST_ID_KEY]]\n  if (context) {\n    context.isAborted = true\n  }\n}\n"],"mappings":"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","ignoreList":[]}