{"version":3,"file":"fetchObservable.js","names":["instrumentMethod","Observable","clocksNow","monitor","callMonitored","normalizeUrl","fetchObservable","initFetchObservable","createFetchObservable","observable","window","fetch","fetchMethod","originalFetch","input","init","responsePromise","context","beforeSend","call","afterSend","stop","methodFromParams","method","undefined","Request","String","toUpperCase","url","startClocks","state","notify","startContext","reportFetch","response","Error","status","isAborted","DOMException","code","ABORT_ERR","error","responseType","constructor","Response","type","err","then"],"sources":["../../src/browser/fetchObservable.js"],"sourcesContent":["import { instrumentMethod } from '../helper/instrumentMethod'\nimport { Observable } from '../helper/observable'\nimport { clocksNow } from '../helper/tools'\nimport { monitor, callMonitored } from '../helper/monitor'\nimport { normalizeUrl } from '../helper/urlPolyfill'\n\nvar fetchObservable\n\nexport function initFetchObservable() {\n  if (!fetchObservable) {\n    fetchObservable = createFetchObservable()\n  }\n  return fetchObservable\n}\n\nfunction createFetchObservable() {\n  return new Observable(function (observable) {\n    if (!window.fetch) {\n      return\n    }\n\n    var fetchMethod = instrumentMethod(\n      window,\n      'fetch',\n      function (originalFetch) {\n        return function (input, init) {\n          var responsePromise\n          var context = callMonitored(beforeSend, null, [\n            observable,\n            input,\n            init\n          ])\n          if (context) {\n            responsePromise = originalFetch.call(\n              this,\n              context.input,\n              context.init\n            )\n            callMonitored(afterSend, null, [\n              observable,\n              responsePromise,\n              context\n            ])\n          } else {\n            responsePromise = originalFetch.call(this, input, init)\n          }\n          return responsePromise\n        }\n      }\n    )\n    return fetchMethod.stop\n  })\n}\n\nfunction beforeSend(observable, input, init) {\n  //   var method =\n  //       (init && init.method) || (input instanceof Request && input.method) || 'GET'\n  //     const methodFromParams =\n  //       (init && init.method) || (input instanceof Request && input.method)\n  //     const method = methodFromParams ? methodFromParams.toUpperCase() : 'GET'\n  var methodFromParams = init && init.method\n\n  if (methodFromParams === undefined && input instanceof Request) {\n    methodFromParams = input.method\n  }\n\n  var method =\n    methodFromParams !== undefined\n      ? String(methodFromParams).toUpperCase()\n      : 'GET'\n  var url = input instanceof Request ? input.url : normalizeUrl(String(input))\n\n  var startClocks = clocksNow()\n\n  var context = {\n    state: 'start',\n    init: init,\n    input: input,\n    method: method,\n    startClocks: startClocks,\n    url: url\n  }\n\n  observable.notify(context)\n\n  return context\n}\n\nfunction afterSend(observable, responsePromise, startContext) {\n  var reportFetch = function (response) {\n    var context = startContext\n    context.state = 'resolve'\n    // context.duration = elapsed(context.startClocks.timeStamp, timeStampNow())\n    if ('stack' in response || response instanceof Error) {\n      context.status = 0\n      context.isAborted =\n        response instanceof DOMException &&\n        response.code === DOMException.ABORT_ERR\n      context.error = response\n    } else if ('status' in response) {\n      context.response = response\n      try {\n        context.responseType =\n          (response.constructor === Response && response.type) || '' // issue The Response type getter can only be used on instances of Response\n      } catch (err) {\n        context.responseType = ''\n      }\n\n      context.status = response.status\n      context.isAborted = false\n    }\n    observable.notify(context)\n  }\n  responsePromise.then(monitor(reportFetch), monitor(reportFetch))\n}\n"],"mappings":"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","ignoreList":[]}